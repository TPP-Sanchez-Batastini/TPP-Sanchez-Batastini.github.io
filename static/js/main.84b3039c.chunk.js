/*! For license information please see main.84b3039c.chunk.js.LICENSE.txt */
(this["webpackJsonptpp-driving-simulator"]=this["webpackJsonptpp-driving-simulator"]||[]).push([[0],{239:function(t,e,s){},290:function(t,e,s){"use strict";s.r(e),s.d(e,"default",(function(){return i}));class i{constructor(t){this.car=t}handleAccelerate(t,e){this.car.accelerate(t,e)}handleBrake(t,e){this.car.brake(t,e)}doHorn(){this.car.doHorn()}changeShift(t,e){this.car.changeShift(t,e)}turnDirection(t){this.car.turnDirection(t)}turnOnCar(){this.car.turnOnCar()}updateCar(){this.car.update()}changeShiftBox(t){this.car.changeShiftBox(t)}turnRightLight(){this.car.turnRightLight()}turnLeftLight(){this.car.turnLeftLight()}turnParkingLight(){this.car.turnParkingLight()}}},413:function(t,e,s){},425:function(t,e){},427:function(t,e){},438:function(t,e){},440:function(t,e){},465:function(t,e){},467:function(t,e){},468:function(t,e){},473:function(t,e){},475:function(t,e){},481:function(t,e){},483:function(t,e){},502:function(t,e){},514:function(t,e){},517:function(t,e){},528:function(t,e,s){"use strict";s.r(e);var i=s(0),n=s.n(i),a=s(370),r=s.n(a),o=(s(413),s(3));class h{constructor(){this.observedState=null}update(t){this.observedState=t}}class l extends h{constructor(t){super(),this.camera=new o.hb(85,window.innerWidth/window.innerHeight,.1,300),this.group=new o.fb,this.group180Rot=(new o.fb).add(this.camera),this.group.add(this.group180Rot),this.renderer=t,this.rotation=0}handleResize(){this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix()}setPositionRelativeToObject(){const t=new o.Jb(.4,.6,-.1);if(null!=this.observedState)if(t.applyQuaternion(this.observedState.rotation),this.group.position.copy(this.observedState.position).add(t),"true"===localStorage.getItem("VR")){let t=new o.Jb(0,-1.25,0);t.applyQuaternion(this.observedState.rotation),this.group.position.add(t),this.group.setRotationFromQuaternion(this.observedState.rotation),this.group180Rot.setRotationFromAxisAngle(new o.Jb(0,1,0),Math.PI),this.camera.lookAt(new o.Jb(0,0,5))}else{const t=new o.pb(this.observedState.rotation.x,this.observedState.rotation.y,this.observedState.rotation.z,this.observedState.rotation.w).normalize();this.group180Rot.setRotationFromAxisAngle(new o.Jb(0,1,0),-5*Math.PI/180+this.rotation),this.group.quaternion.copy(t)}else this.camera.lookAt(new o.Jb(0,0,5))}getCameraInstance(){return this.camera}addContainerToScene(t){t.add(this.group)}rotate(t){this.rotation=t}}class c extends h{constructor(t){super(),this.positionCamera=t,this.camera=new o.hb(75,window.innerWidth/window.innerHeight,.1,300)}handleResize(){this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix()}setPositionRelativeToObject(){const t=new o.Jb(this.positionCamera.x,this.positionCamera.y,this.positionCamera.z);if(null!=this.observedState){let e=t.applyQuaternion(this.observedState.rotation);this.camera.position.copy(this.observedState.position).add(e);let s=new o.Jb(this.observedState.position.x,this.observedState.position.y,this.observedState.position.z);this.camera.lookAt(s)}else this.camera.lookAt(new o.Jb(0,0,0)),this.camera.position.copy(t)}getCameraInstance(){return this.camera}}var d=s(371);class u extends h{constructor(t){super(),this.camera=new o.hb(75,window.innerWidth/window.innerHeight,.1,1e3),this.renderer=t,this.controls=new d.a(this.camera,this.renderer.domElement),this.controls.enableDamping=!0,this.controls.dampingFactor=.25,this.controls.enableZoom=!0,this.camera.position.set(0,5.5,0)}handleResize(){this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix()}getCameraInstance(){return this.camera}setPositionRelativeToObject(){this.controls.update(),null!=this.observedState?this.camera.lookAt(this.observedState.position):this.camera.lookAt(new o.Jb(0,0,0))}}var p=s(392),g=s(224);class b extends h{constructor(t){super(),this.fbxLoader=new p.a,this.gltfLoader=new g.a,this.threeDModel=null,this.pathToTexture=t}async loadFBX(){let t=this.pathToTexture;return await this.fbxLoader.loadAsync(t,(function(t){return t}))}async loadGLTF(){let t=this.pathToTexture;return await this.gltfLoader.loadAsync(t,(function(t){return t}))}async addToScene(t,e,s,i){if(!this.threeDModel){let a;try{a=await this.loadFBX(),this.threeDModel=a}catch(n){a=await this.loadGLTF(),this.threeDModel=a.scene}this.threeDModel.name=e,this.threeDModel.position.x=s[0],this.threeDModel.position.y=s[1],this.threeDModel.position.z=s[2],this.threeDModel.scale.x=i[0],this.threeDModel.scale.y=i[1],this.threeDModel.scale.z=i[2],t.add(this.threeDModel)}return this}getModel(){return this.threeDModel}animate(){return null}}var S=s(226);class m{constructor(){this.gltfLoader=new g.a,this.carModel=null,this.building_1=null,this.building_2=null,this.building_3=null,this.building_4=null}changeMaterialsToBasic(t){for(let e=0;e<t.length;e++){const s=t[e];if(s.isGroup)this.changeMaterialsToBasic(s.children);else if(s.isMesh){const t=new o.W;o.U.prototype.copy.call(t,s.material),s.material=t,s.receiveShadow=!0,s.castShadow=!0}}}async loadGLTF(t){let e=t;const s=await this.gltfLoader.loadAsync(e,(function(t){return t}));return this.changeMaterialsToBasic(s.scene.children),s.scene}async loadModels(){return this.carModel=this.loadGLTF("res/models/source/Mercedes.glb"),this.building_1=this.loadGLTF("res/models/source/buildings/Building_1.glb"),this.building_2=this.loadGLTF("res/models/source/buildings/Building_2.glb"),this.building_3=this.loadGLTF("res/models/source/buildings/Building_3.glb"),this.building_4=this.loadGLTF("res/models/source/buildings/Building_4.glb"),"OK"}}class w{static async getInstance(){if(w.ModelsSingleton)return w.ModelsSingleton;if(w.ModelsSingleton=new m,"OK"===await w.ModelsSingleton.loadModels())return w.ModelsSingleton;throw new Error("Error al cargar los modelos.")}}const x=[1,1,1],f=[0,0,0],y=.75,v=1/3600,j=1e3;class E extends b{constructor(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];super("res/models/source/Mercedes.glb"),this.carModel=null,this.carLogic=null,this.lastValueRotation=0,this.currentSpeedRotation=0,this.currentWheelRotation=0,this.lastSteeringRotation=0,this.lastVelocityRotation=0,this.lastRPMRotation=0,this.isIA=t,this.lastTurnOff=new Date}generateRetrovisor(){const t=new o.jb(.145,.085),e=JSON.parse(localStorage.getItem("graphic_config")),s=new S.a(t,{textureWidth:window.innerWidth*e.MirrorResMultiplier,textureHeight:window.innerHeight*e.MirrorResMultiplier,clipBias:.35,multisample:e.AAEspejos});s.rotateX(Math.PI-.04),s.rotateY(.35),s.position.set(.075,.625,.31),this.threeDModel.add(s)}generateLeftMirror(){const t=new o.jb(.19,.1),e=JSON.parse(localStorage.getItem("graphic_config")),s=new S.a(t,{textureWidth:window.innerWidth*e.MirrorResMultiplier,textureHeight:window.innerHeight*e.MirrorResMultiplier,clipBias:0,multisample:e.AAEspejos});let i=new o.fb;i.add(s),i.position.set(.96,.345,.62),i.rotateX(.13-Math.PI),s.rotateY(-18*Math.PI/180),this.threeDModel.add(i)}generateRightMirror(){const t=JSON.parse(localStorage.getItem("graphic_config")),e=new o.jb(.19,.1),s=new S.a(e,{textureWidth:window.innerWidth*t.MirrorResMultiplier,textureHeight:window.innerHeight*t.MirrorResMultiplier,clipBias:0,multisample:t.AAEspejos});let i=new o.fb;i.add(s),i.position.set(-.96,.345,.62),i.rotateX(.1-Math.PI),s.rotateY(18*Math.PI/180),this.threeDModel.add(i)}generateMirrors(){const t=JSON.parse(localStorage.getItem("graphic_config"));!this.isIA&&t.CreateMirrors&&(this.generateRetrovisor(),this.generateLeftMirror(),this.generateRightMirror())}generateSpotlights(){const t=JSON.parse(localStorage.getItem("graphic_config")).lightsOn;!this.isIA&&t&&(this.rightSpotlight=new o.zb(16777215),this.leftSpotlight=new o.zb(16777215),this.targetRight=new o.fb,this.targetLeft=new o.fb,this.targetRight.position.set(-.8,.05,3),this.targetLeft.position.set(.8,.05,3),this.rightSpotlight.position.set(-.8,.3,2.6),this.leftSpotlight.position.set(.8,.3,2.6),this.rightSpotlight.target=this.targetRight,this.leftSpotlight.target=this.targetLeft,this.leftSpotlight.castShadow=!0,this.rightSpotlight.castShadow=!0,this.rightSpotlight.shadow.mapSize.width=1024,this.leftSpotlight.shadow.mapSize.height=1024,this.rightSpotlight.shadow.camera.near=.1,this.leftSpotlight.shadow.camera.near=.1,this.rightSpotlight.shadow.camera.far=2,this.leftSpotlight.shadow.camera.far=2,this.rightSpotlight.shadow.camera.fov=10,this.leftSpotlight.shadow.camera.fov=10,this.rightSpotlight.intensity=.5,this.leftSpotlight.intensity=.5,this.rightSpotlight.angle=Math.PI/5,this.leftSpotlight.angle=Math.PI/5,this.rightSpotlight.distance=15,this.leftSpotlight.distance=15,this.threeDModel.add(this.leftSpotlight),this.threeDModel.add(this.rightSpotlight),this.threeDModel.add(this.targetLeft),this.threeDModel.add(this.targetRight),this.rightTurnlight=new o.zb(14387728),this.targetTurnRight=new o.fb,this.targetTurnRight.position.set(-.85,.05,3),this.rightTurnlight.position.set(-.8,.3,2.6),this.rightTurnlight.target=this.targetTurnRight,this.rightTurnlight.castShadow=!1,this.rightTurnlight.intensity=0,this.rightTurnlight.angle=Math.PI/5,this.rightTurnlight.distance=10,this.threeDModel.add(this.targetTurnRight),this.threeDModel.add(this.rightTurnlight),this.leftTurnlight=new o.zb(14387728),this.targetTurnLeft=new o.fb,this.targetTurnLeft.position.set(.85,.05,3),this.leftTurnlight.position.set(.8,.3,2.6),this.leftTurnlight.target=this.targetTurnLeft,this.leftTurnlight.castShadow=!1,this.leftTurnlight.intensity=0,this.leftTurnlight.angle=Math.PI/5,this.leftTurnlight.distance=10,this.threeDModel.add(this.targetTurnLeft),this.threeDModel.add(this.leftTurnlight),this.rightTurnlightBack=new o.zb(14387728),this.targetTurnRightBack=new o.fb,this.targetTurnRightBack.position.set(-.85,3,-3),this.rightTurnlightBack.position.set(-.8,3.2,2.6),this.rightTurnlightBack.target=this.targetTurnRightBack,this.rightTurnlightBack.castShadow=!1,this.rightTurnlightBack.intensity=0,this.rightTurnlightBack.angle=Math.PI/5,this.rightTurnlightBack.distance=10,this.threeDModel.add(this.targetTurnRightBack),this.threeDModel.add(this.rightTurnlightBack),this.leftTurnlightBack=new o.zb(14387728),this.targetTurnLeftBack=new o.fb,this.targetTurnLeftBack.position.set(.85,3,-3),this.leftTurnlightBack.position.set(.8,3.2,2.6),this.leftTurnlightBack.target=this.targetTurnLeftBack,this.leftTurnlightBack.castShadow=!1,this.leftTurnlightBack.intensity=0,this.leftTurnlightBack.angle=Math.PI/5,this.leftTurnlightBack.distance=10,this.threeDModel.add(this.targetTurnLeftBack),this.threeDModel.add(this.leftTurnlightBack))}turnRigth(){const t=JSON.parse(localStorage.getItem("graphic_config")).lightsOn;if(this.isIA||!t)return;let e=new Date;if(this.observedState.turnRigthLigth){let t=e-this.lastTurnOff;t<j?(this.rightTurnlight.intensity=1,this.rightTurnlightBack.intensity=1):t<2e3?(this.rightTurnlight.intensity=0,this.rightTurnlightBack.intensity=0):this.lastTurnOff=new Date}else this.rightTurnlight.intensity=0,this.rightTurnlightBack.intensity=0}turnLeft(){const t=JSON.parse(localStorage.getItem("graphic_config")).lightsOn;if(this.isIA||!t)return;let e=new Date;if(this.observedState.turnLeftLigth){let t=e-this.lastTurnOff;t<j?(this.leftTurnlight.intensity=1,this.leftTurnlightBack.intensity=1):t<2e3?(this.leftTurnlight.intensity=0,this.leftTurnlightBack.intensity=0):this.lastTurnOff=new Date}else this.leftTurnlight.intensity=0,this.leftTurnlightBack.intensity=0}async addToScene(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"driverCar",s=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const i=await w.getInstance();return this.threeDModel=await i.carModel,this.threeDModel=this.threeDModel.clone(),this.threeDModel.name=e,this.threeDModel.position.x=f[0],this.threeDModel.position.y=f[1],this.threeDModel.position.z=f[2],this.threeDModel.scale.x=x[0],this.threeDModel.scale.y=x[1],this.threeDModel.scale.z=x[2],t.add(this.threeDModel),s&&this.generateMirrors(),this.generateSpotlights(),this}animate(){this.moveCar()}addPhysicsView(t){this.physicsShape=new o.Jb(2,1.35,5);const e=new o.e(this.physicsShape.x,this.physicsShape.y,this.physicsShape.z),s=new o.U({color:255});this.PHYSICSSQUARE=new o.T(e,s),this.PHYSICSSQUARE.position.set(0,0,0),t.add(this.PHYSICSSQUARE);const i=new o.l(.35,.35,.35,32,32);i.rotateZ(Math.PI/2);const n=new o.U({color:16711680});this.wheelMesh1=new o.T(i,n),this.wheelMesh1.position.set(0,4,0),t.add(this.wheelMesh1),this.wheelMesh2=new o.T(i,n),this.wheelMesh2.position.set(0,4,0),t.add(this.wheelMesh2),this.wheelMesh3=new o.T(i,n),this.wheelMesh3.position.set(0,4,0),t.add(this.wheelMesh3),this.wheelMesh4=new o.T(i,n),this.wheelMesh4.position.set(0,4,0),t.add(this.wheelMesh4)}watchPhysicsColliders(){null!=this.observedState&&(this.PHYSICSSQUARE.position.set(this.observedState.position.x,this.observedState.position.y,this.observedState.position.z),this.PHYSICSSQUARE.quaternion.set(this.observedState.rotation.x,this.observedState.rotation.y,this.observedState.rotation.z,this.observedState.rotation.w),this.wheelMesh1.position.set(this.observedState.wheelsData[0].position.x,this.observedState.wheelsData[0].position.y,this.observedState.wheelsData[0].position.z),this.wheelMesh1.quaternion.set(this.observedState.wheelsData[0].rotation.x,this.observedState.wheelsData[0].rotation.y,this.observedState.wheelsData[0].rotation.z,this.observedState.wheelsData[0].rotation.w),this.wheelMesh2.position.set(this.observedState.wheelsData[1].position.x,this.observedState.wheelsData[1].position.y,this.observedState.wheelsData[1].position.z),this.wheelMesh2.quaternion.set(this.observedState.wheelsData[1].rotation.x,this.observedState.wheelsData[1].rotation.y,this.observedState.wheelsData[1].rotation.z,this.observedState.wheelsData[1].rotation.w),this.wheelMesh3.position.set(this.observedState.wheelsData[2].position.x,this.observedState.wheelsData[2].position.y,this.observedState.wheelsData[2].position.z),this.wheelMesh3.quaternion.set(this.observedState.wheelsData[2].rotation.x,this.observedState.wheelsData[2].rotation.y,this.observedState.wheelsData[2].rotation.z,this.observedState.wheelsData[2].rotation.w),this.wheelMesh4.position.set(this.observedState.wheelsData[3].position.x,this.observedState.wheelsData[3].position.y,this.observedState.wheelsData[3].position.z),this.wheelMesh4.quaternion.set(this.observedState.wheelsData[3].rotation.x,this.observedState.wheelsData[3].rotation.y,this.observedState.wheelsData[3].rotation.z,this.observedState.wheelsData[3].rotation.w))}moveCar(){null!=this.observedState&&(this.threeDModel.userData.physicsBody=this.observedState.physicsBody,this.threeDModel.position.set(this.observedState.position.x,this.observedState.position.y,this.observedState.position.z),this.threeDModel.quaternion.set(this.observedState.rotation.x,this.observedState.rotation.y,this.observedState.rotation.z,this.observedState.rotation.w),this.lastValueRotation=this.observedState.direction,this.rotateWheels(),this.rotateSteeringWheel(),this.rotateVelocityAndRPM(),this.turnRigth(),this.turnLeft())}rotateSteeringWheel(){let t=this.threeDModel.children.find((t=>"Steering_Wheel"===t.name)),e=new o.Jb(0,0,1).applyAxisAngle(new o.Jb(1,0,0),.13);t.rotateOnAxis(e,this.lastSteeringRotation),t.rotateOnAxis(e,540*this.observedState.lastRotationWheel/360*Math.PI*2),this.lastSteeringRotation=540*-this.observedState.lastRotationWheel/360*Math.PI*2}rotateVelocityAndRPM(){let t=this.threeDModel.children.find((t=>"Cubo001"===t.name)),e=this.threeDModel.children.find((t=>"Cubo"===t.name));const s=-Math.abs(this.observedState.velocity)*(240*Math.PI/180)/240,i=-this.observedState.rpm*(260*Math.PI/180)/6e3;t.rotateOnAxis(new o.Jb(0,1,0),-this.lastVelocityRotation),t.rotateOnAxis(new o.Jb(0,1,0),s),e.rotateOnAxis(new o.Jb(0,1,0),-this.lastRPMRotation),e.rotateOnAxis(new o.Jb(0,1,0),i),this.lastVelocityRotation=s,this.lastRPMRotation=i}rotateWheels(){let t=this.threeDModel.children.find((t=>"W222WheelFtR"===t.name)),e=this.threeDModel.children.find((t=>"W222WheelFtL"===t.name)),s=this.threeDModel.children.find((t=>"W222WheelBkR"===t.name)),i=this.threeDModel.children.find((t=>"W222WheelBkL"===t.name)),n=new o.Jb(0,1,0).applyAxisAngle(new o.Jb(1,0,0),-this.currentSpeedRotation);e.rotateOnAxis(n,this.currentWheelRotation),t.rotateOnAxis(n,this.currentWheelRotation),e.rotateX(this.observedState.velocity*v*4),t.rotateX(this.observedState.velocity*v*4),s.rotateX(this.observedState.velocity*v*4),i.rotateX(this.observedState.velocity*v*4),n=new o.Jb(0,1,0).applyAxisAngle(new o.Jb(1,0,0),-this.currentSpeedRotation-this.observedState.velocity*v*4),e.rotateOnAxis(n,-this.observedState.lastRotationWheel*y),t.rotateOnAxis(n,-this.observedState.lastRotationWheel*y),this.currentWheelRotation=this.observedState.lastRotationWheel*y,this.currentSpeedRotation+=this.observedState.velocity*v*4,this.currentSpeedRotation>=2*Math.PI&&(this.currentSpeedRotation-=2*Math.PI)}}const{default:I}=s(290);class A{constructor(t,e,s){this.carLogic=t;const i=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[];this.gamepad=null;for(let n=0;n<i.length;n++)i[n]&&i[n].id.startsWith("G29 Driving Force Racing Wheel")&&(this.gamepad=i[n]);this.buttonX=0,this.buttonSquare=1,this.buttonCircle=2,this.buttonTriangle=3,this.bumperRight=4,this.bumperLeft=5,this.buttonR2=6,this.buttonL2=7,this.shareButton=8,this.optionsButton=9,this.buttonR3=10,this.buttonL3=11,this.firstShift=12,this.secondShift=13,this.thirdShift=14,this.fourthShift=15,this.fifthShift=16,this.sixthShift=17,this.reverseShift=18,this.buttonPlus=19,this.buttonMinus=20,this.wheelInEnterRight=21,this.wheelInEnterLeft=22,this.enter=23,this.psButton=24,this.buttonsPressed=[];for(let n=0;n<=24;n++)this.buttonsPressed.push(!1);this.wheelAxes=0,this.clutch=1,this.accelerator=2,this.brake=5,this.DPad=9,this.valueDpadUP=-1,this.valueDpadDOWN=.14285719394683838,this.valueDpadLEFT=.7142857313156128,this.valueDpadRIGHT=-.4285714030265808,this.camera=e,this.pause=s,this.dpadPressed=[];for(let n=0;n<=3;n++)this.dpadPressed.push(!1);this.globalControllerHandler=new I(t)}checkGamepadChanges(){const t=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[];for(let e=0;e<t.length;e++)t[e]&&t[e].id.startsWith("G29 Driving Force Racing Wheel")&&(this.gamepad=t[e])}checkEvents(){this.gamepad=null,this.checkGamepadChanges(),null!=this.gamepad&&this.doActionByMapping(),this.globalControllerHandler.updateCar()}doActionsPedals(){let t=this.gamepad.axes[this.clutch]**3,e=this.gamepad.axes[this.brake]**3;e=1-(e+1)/2;let s=this.gamepad.axes[this.accelerator]**3;s=1-(s+1)/2,this.globalControllerHandler.handleAccelerate(t,s),this.globalControllerHandler.handleBrake(t,e)}doActionsWheel(){this.globalControllerHandler.turnDirection(this.gamepad.axes[this.wheelAxes])}doActionsDPad(){if(1.2857143878936768!==this.gamepad.axes[this.DPad])this.gamepad.axes[this.DPad]!==this.valueDpadDOWN||this.dpadPressed[1]?this.gamepad.axes[this.DPad]!==this.valueDpadDOWN&&(this.dpadPressed[1]=!1):this.dpadPressed[1]=!0,this.gamepad.axes[this.DPad]===this.valueDpadRIGHT?this.camera.rotate&&this.camera.rotate(-1):this.gamepad.axes[this.DPad]===this.valueDpadLEFT&&this.camera.rotate&&this.camera.rotate(1),this.gamepad.axes[this.DPad]!==this.valueDpadUP||this.dpadPressed[0]?this.gamepad.axes[this.DPad]!==this.valueDpadUP&&(this.dpadPressed[0]=!1):(this.globalControllerHandler.turnParkingLight(),this.dpadPressed[0]=!0);else{for(let t=0;t<this.dpadPressed.length;t++)this.dpadPressed[t]=!1;this.camera.rotate&&this.camera.rotate(0)}}doActionsButtons(){this.gamepad.buttons[this.buttonX].pressed&&!this.buttonsPressed[this.buttonX]?this.buttonsPressed[this.buttonX]=!0:this.gamepad.buttons[this.buttonX].pressed||(this.buttonsPressed[this.buttonX]=!1),this.gamepad.buttons[this.buttonTriangle].pressed&&!this.buttonsPressed[this.buttonTriangle]?this.buttonsPressed[this.buttonTriangle]=!0:this.gamepad.buttons[this.buttonTriangle].pressed||(this.buttonsPressed[this.buttonTriangle]=!1),this.gamepad.buttons[this.buttonCircle].pressed&&!this.buttonsPressed[this.buttonCircle]?this.buttonsPressed[this.buttonCircle]=!0:this.gamepad.buttons[this.buttonCircle].pressed||(this.buttonsPressed[this.buttonCircle]=!1),this.gamepad.buttons[this.buttonSquare].pressed&&!this.buttonsPressed[this.buttonSquare]?(this.globalControllerHandler.doHorn(),this.buttonsPressed[this.buttonSquare]=!0):this.gamepad.buttons[this.buttonSquare].pressed||(this.buttonsPressed[this.buttonSquare]=!1),this.gamepad.buttons[this.psButton].pressed&&!this.buttonsPressed[this.psButton]?this.buttonsPressed[this.psButton]=!0:this.gamepad.buttons[this.psButton].pressed||(this.buttonsPressed[this.psButton]=!1),this.gamepad.buttons[this.buttonPlus].pressed&&!this.buttonsPressed[this.buttonPlus]?this.buttonsPressed[this.buttonPlus]=!0:this.gamepad.buttons[this.buttonPlus].pressed||(this.buttonsPressed[this.buttonPlus]=!1),this.gamepad.buttons[this.buttonMinus].pressed&&!this.buttonsPressed[this.buttonMinus]?this.buttonsPressed[this.buttonMinus]=!0:this.gamepad.buttons[this.buttonMinus].pressed||(this.buttonsPressed[this.buttonMinus]=!1),this.gamepad.buttons[this.buttonL2].pressed&&!this.buttonsPressed[this.buttonL2]?this.buttonsPressed[this.buttonL2]=!0:this.gamepad.buttons[this.buttonL2].pressed||(this.buttonsPressed[this.buttonL2]=!1),this.gamepad.buttons[this.buttonL3].pressed&&!this.buttonsPressed[this.buttonL3]?this.buttonsPressed[this.buttonL3]=!0:this.gamepad.buttons[this.buttonL3].pressed||(this.buttonsPressed[this.buttonL3]=!1),this.gamepad.buttons[this.buttonR2].pressed&&!this.buttonsPressed[this.buttonR2]?(this.globalControllerHandler.turnOnCar(),this.buttonsPressed[this.buttonR2]=!0):this.gamepad.buttons[this.buttonR2].pressed||(this.buttonsPressed[this.buttonR2]=!1),this.gamepad.buttons[this.buttonR3].pressed&&!this.buttonsPressed[this.buttonR3]?this.buttonsPressed[this.buttonR3]=!0:this.gamepad.buttons[this.buttonR3].pressed||(this.buttonsPressed[this.buttonR3]=!1),this.gamepad.buttons[this.enter].pressed&&!this.buttonsPressed[this.enter]?(this.buttonsPressed[this.enter]=!0,this.pause()):this.gamepad.buttons[this.enter].pressed||(this.buttonsPressed[this.enter]=!1),this.gamepad.buttons[this.shareButton].pressed&&!this.buttonsPressed[this.shareButton]?this.buttonsPressed[this.shareButton]=!0:this.gamepad.buttons[this.shareButton].pressed||(this.buttonsPressed[this.shareButton]=!1),this.gamepad.buttons[this.optionsButton].pressed&&!this.buttonsPressed[this.optionsButton]?this.buttonsPressed[this.optionsButton]=!0:this.gamepad.buttons[this.optionsButton].pressed||(this.buttonsPressed[this.optionsButton]=!1),this.gamepad.buttons[this.bumperLeft].pressed&&!this.buttonsPressed[this.bumperLeft]?(this.globalControllerHandler.turnLeftLight(),this.buttonsPressed[this.bumperLeft]=!0):this.gamepad.buttons[this.bumperLeft].pressed||(this.buttonsPressed[this.bumperLeft]=!1),this.gamepad.buttons[this.bumperRight].pressed&&!this.buttonsPressed[this.bumperRight]?(this.globalControllerHandler.turnRightLight(),this.buttonsPressed[this.bumperRight]=!0):this.gamepad.buttons[this.bumperRight].pressed||(this.buttonsPressed[this.bumperRight]=!1),this.gamepad.buttons[this.wheelInEnterLeft].pressed&&!this.buttonsPressed[this.wheelInEnterLeft]?this.buttonsPressed[this.wheelInEnterLeft]=!0:this.gamepad.buttons[this.wheelInEnterLeft].pressed||(this.buttonsPressed[this.wheelInEnterLeft]=!1),this.gamepad.buttons[this.wheelInEnterRight].pressed&&!this.buttonsPressed[this.wheelInEnterRight]?this.buttonsPressed[this.wheelInEnterRight]=!0:this.gamepad.buttons[this.wheelInEnterRight].pressed||(this.buttonsPressed[this.wheelInEnterRight]=!1)}doActionsShifter(){this.gamepad.buttons[this.firstShift].pressed&&!this.buttonsPressed[this.firstShift]?(this.globalControllerHandler.changeShift(this.gamepad.axes[this.clutch],1),this.buttonsPressed[this.firstShift]=!0):!this.gamepad.buttons[this.firstShift].pressed&&this.buttonsPressed[this.firstShift]&&(this.globalControllerHandler.changeShift(this.gamepad.axes[this.clutch],0),this.buttonsPressed[this.firstShift]=!1),this.gamepad.buttons[this.secondShift].pressed&&!this.buttonsPressed[this.secondShift]?(this.globalControllerHandler.changeShift(this.gamepad.axes[this.clutch],2),this.buttonsPressed[this.secondShift]=!0):!this.gamepad.buttons[this.secondShift].pressed&&this.buttonsPressed[this.secondShift]&&(this.globalControllerHandler.changeShift(this.gamepad.axes[this.clutch],0),this.buttonsPressed[this.secondShift]=!1),this.gamepad.buttons[this.thirdShift].pressed&&!this.buttonsPressed[this.thirdShift]?(this.globalControllerHandler.changeShift(this.gamepad.axes[this.clutch],3),this.buttonsPressed[this.thirdShift]=!0):!this.gamepad.buttons[this.thirdShift].pressed&&this.buttonsPressed[this.thirdShift]&&(this.globalControllerHandler.changeShift(this.gamepad.axes[this.clutch],0),this.buttonsPressed[this.thirdShift]=!1),this.gamepad.buttons[this.fourthShift].pressed&&!this.buttonsPressed[this.fourthShift]?(this.globalControllerHandler.changeShift(this.gamepad.axes[this.clutch],4),this.buttonsPressed[this.fourthShift]=!0):!this.gamepad.buttons[this.fourthShift].pressed&&this.buttonsPressed[this.fourthShift]&&(this.globalControllerHandler.changeShift(this.gamepad.axes[this.clutch],0),this.buttonsPressed[this.fourthShift]=!1),this.gamepad.buttons[this.fifthShift].pressed&&!this.buttonsPressed[this.fifthShift]?(this.globalControllerHandler.changeShift(this.gamepad.axes[this.clutch],5),this.buttonsPressed[this.fifthShift]=!0):!this.gamepad.buttons[this.fifthShift].pressed&&this.buttonsPressed[this.fifthShift]&&(this.globalControllerHandler.changeShift(this.gamepad.axes[this.clutch],0),this.buttonsPressed[this.fifthShift]=!1),this.gamepad.buttons[this.sixthShift].pressed&&!this.buttonsPressed[this.sixthShift]?(this.globalControllerHandler.changeShift(this.gamepad.axes[this.clutch],6),this.buttonsPressed[this.sixthShift]=!0):!this.gamepad.buttons[this.sixthShift].pressed&&this.buttonsPressed[this.sixthShift]&&(this.globalControllerHandler.changeShift(this.gamepad.axes[this.clutch],0),this.buttonsPressed[this.sixthShift]=!1),this.gamepad.buttons[this.reverseShift].pressed&&!this.buttonsPressed[this.reverseShift]?(this.globalControllerHandler.changeShift(this.gamepad.axes[this.clutch],-1),this.buttonsPressed[this.reverseShift]=!0):!this.gamepad.buttons[this.reverseShift].pressed&&this.buttonsPressed[this.reverseShift]&&(this.globalControllerHandler.changeShift(this.gamepad.axes[this.clutch],0),this.buttonsPressed[this.reverseShift]=!1)}doActionByMapping(){this.doActionsPedals(),this.doActionsWheel(),this.doActionsDPad(),this.doActionsButtons(),this.doActionsShifter()}setCamera(t){this.camera=t}updatePauseFun(t){this.pause=t}}class R{constructor(){throw new Error("Can not construct singleton. Call get instance instead.")}static getInstance(t,e,s){return R.instance||(R.instance=new A(t,e,s)),R.instance.setCamera(e),R.instance.updatePauseFun(s),R.instance}}const{default:O}=s(290);class T{constructor(t,e,s){const i=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[];this.gamepad=null;for(let n=0;n<i.length;n++)i[n]&&(i[n].id.startsWith("Xbox")||i[n].id.startsWith("xinput"))&&(this.gamepad=i[n]);this.buttonA=0,this.buttonB=1,this.buttonX=2,this.buttonY=3,this.buttonL1=4,this.buttonR1=5,this.buttonL2=6,this.buttonR2=7,this.shareButton=8,this.optionButton=9,this.buttonL3=10,this.buttonR3=11,this.padUp=12,this.padDown=13,this.padLeft=14,this.padRight=15,this.buttomHome=16,this.buttonPressed=[],this.actualShift=0;for(let n=0;n<=16;n++)this.buttonPressed.push(!1);this.xLeftAxe=0,this.yLeftAxe=1,this.xRightAxe=2,this.yRightAxe=3,this.globalControllerHandler=new O(t),this.camera=e,this.pause=s}checkGamepadChanges(){const t=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[];for(let e=0;e<t.length;e++)t[e]&&t[e].id.startsWith("Xbox")&&(this.gamepad=t[e])}checkEvents(){this.gamepad=null,this.checkGamepadChanges(),null!=this.gamepad&&this.doActionByMapping(),this.globalControllerHandler.updateCar()}doActionsAxes(){if(Math.abs(this.gamepad.axes[this.yLeftAxe]),Math.abs(this.gamepad.axes[this.xLeftAxe])>=.1){let t=this.gamepad.axes[this.xLeftAxe]**3;this.globalControllerHandler.turnDirection(t)}else this.globalControllerHandler.turnDirection(0);Math.abs(this.gamepad.axes[this.yRightAxe]);let t=this.gamepad.axes[this.xRightAxe]**3;this.camera.rotate&&this.camera.rotate(-t)}doActionHotKeys(){this.globalControllerHandler.handleAccelerate(1,this.gamepad.buttons[this.buttonR2].value),this.globalControllerHandler.handleBrake(0,this.gamepad.buttons[this.buttonL2].value)}doActionsTriggers(){this.gamepad.buttons[this.buttonR2].pressed,this.gamepad.buttons[this.buttonL2].pressed}doActionsButtons(){this.gamepad.buttons[this.buttonR1].pressed&&!this.buttonPressed[this.buttonR1]?(this.actualShift<=5&&(this.actualShift+=1,this.globalControllerHandler.changeShift(0,this.actualShift)),this.buttonPressed[this.buttonR1]=!0):this.gamepad.buttons[this.buttonR1].pressed||(this.buttonPressed[this.buttonR1]=!1),this.gamepad.buttons[this.buttonL1].pressed&&!this.buttonPressed[this.buttonL1]?(this.actualShift>=0&&(this.actualShift-=1,this.globalControllerHandler.changeShift(0,this.actualShift)),this.buttonPressed[this.buttonL1]=!0):this.gamepad.buttons[this.buttonL1].pressed||(this.buttonPressed[this.buttonL1]=!1),this.gamepad.buttons[this.shareButton].pressed&&!this.buttonPressed[this.shareButton]?(this.pause(),this.buttonPressed[this.shareButton]=!0):this.gamepad.buttons[this.shareButton].pressed||(this.buttonPressed[this.shareButton]=!1),this.gamepad.buttons[this.padUp].pressed&&!this.buttonPressed[this.padUp]?(this.globalControllerHandler.turnParkingLight(),this.buttonPressed[this.padUp]=!0):this.gamepad.buttons[this.padUp].pressed||(this.buttonPressed[this.padUp]=!1),this.gamepad.buttons[this.padDown].pressed&&!this.buttonPressed[this.padDown]?this.buttonPressed[this.padDown]=!0:this.gamepad.buttons[this.padDown].pressed||(this.buttonPressed[this.padDown]=!1),this.gamepad.buttons[this.padLeft].pressed&&!this.buttonPressed[this.padLeft]?(this.globalControllerHandler.turnLeftLight(),this.buttonPressed[this.padLeft]=!0):this.gamepad.buttons[this.padLeft].pressed||(this.buttonPressed[this.padLeft]=!1),this.gamepad.buttons[this.padRight].pressed&&!this.buttonPressed[this.padRight]?(this.globalControllerHandler.turnRightLight(),this.buttonPressed[this.padRight]=!0):this.gamepad.buttons[this.padRight].pressed||(this.buttonPressed[this.padRight]=!1),this.gamepad.buttons[this.buttonA].pressed&&!this.buttonPressed[this.buttonA]?this.buttonPressed[this.buttonA]=!0:this.gamepad.buttons[this.buttonA].pressed||(this.buttonPressed[this.buttonA]=!1),this.gamepad.buttons[this.buttonB].pressed&&!this.buttonPressed[this.buttonB]?this.buttonPressed[this.buttonB]=!0:this.gamepad.buttons[this.buttonB].pressed||(this.buttonPressed[this.buttonB]=!1),this.gamepad.buttons[this.buttonY].pressed&&!this.buttonPressed[this.buttonY]?this.buttonPressed[this.buttonY]=!0:this.gamepad.buttons[this.buttonY].pressed||(this.buttonPressed[this.buttonY]=!1),this.gamepad.buttons[this.buttonX].pressed&&!this.buttonPressed[this.buttonX]?(this.globalControllerHandler.doHorn(),this.buttonPressed[this.buttonX]=!0):this.gamepad.buttons[this.buttonX].pressed||(this.buttonPressed[this.buttonX]=!1),this.gamepad.buttons[this.buttonR3].pressed&&!this.buttonPressed[this.buttonR3]?this.buttonPressed[this.buttonR3]=!0:this.gamepad.buttons[this.buttonR3].pressed||(this.buttonPressed[this.buttonR3]=!1),this.gamepad.buttons[this.buttonL3].pressed&&!this.buttonPressed[this.buttonL3]?this.buttonPressed[this.buttonL3]=!0:this.gamepad.buttons[this.buttonL3].pressed||(this.buttonPressed[this.buttonL3]=!1),this.gamepad.buttons[this.buttomHome].pressed&&!this.buttonPressed[this.buttomHome]?(this.globalControllerHandler.changeShiftBox("semi-auto"),this.buttonPressed[this.buttomHome]=!0):this.gamepad.buttons[this.buttomHome].pressed||(this.buttonPressed[this.buttomHome]=!1),this.gamepad.buttons[this.optionButton].pressed&&!this.buttonPressed[this.optionButton]?(this.globalControllerHandler.turnOnCar(),this.buttonPressed[this.optionButton]=!0):this.gamepad.buttons[this.optionButton].pressed||(this.buttonPressed[this.optionButton]=!1)}doActionByMapping(){this.doActionHotKeys(),this.doActionsAxes(),this.doActionsTriggers(),this.doActionsButtons()}setCamera(t){this.camera=t}updatePauseFun(t){this.pause=t}}class M{constructor(){throw new Error("Can not construct singleton. Call get instance instead.")}static getInstance(t,e,s){return M.instance||(M.instance=new T(t,e,s)),M.instance.setCamera(e),M.instance.updatePauseFun(s),M.instance}}class P{constructor(){this.observers=[]}attachObserver(t){this.observers.push(t)}removeObserver(t){let e=this.observers.indexOf(t);e>-1&&this.observers.splice(e,1)}notifyObservers(t){for(let e=0;e<this.observers.length;e++)this.observers[e].update(t)}}var _=s(372),C=s.n(_);class L{constructor(){throw new Error("Can not construct singleton. Call get instance instead.")}static async getInstance(){return L.AmmoInstanceToReturn||(L.AmmoInstanceToReturn=await C()()),L.AmmoInstanceToReturn}}L.AmmoInstanceToReturn=null;class D{constructor(t,e,s,i,n,a,r){this.position=t,this.quaternion=e,this.inertia=s,this.mass=i,this.shape=n,this.physicsWorld=a,this.friction=r}async buildAmmoPhysics(){let t=await L.getInstance();this.inertia=new t.btVector3(this.inertia.x,this.inertia.y,this.inertia.z),this.Ammo=t;let e=new t.btTransform;e.setIdentity(),e.setOrigin(new t.btVector3(this.position.x,this.position.y,this.position.z)),e.setRotation(new t.btQuaternion(this.quaternion.x,this.quaternion.y,this.quaternion.z,this.quaternion.w)),this.tempTransform=new t.btTransform;let s=new t.btDefaultMotionState(e),i=new t.btBoxShape(new t.btVector3(this.shape.x/2,this.shape.y/2,this.shape.z/2));i.calculateLocalInertia(this.mass,this.inertia);let n=new t.btRigidBodyConstructionInfo(this.mass,s,i,this.inertia);this.rigidBody=new t.btRigidBody(n),this.rigidBody.setFriction(this.friction),this.rigidBody.setRollingFriction(10*this.friction),this.physicsWorld.addRigidBody(this.rigidBody),this.tuning=new this.Ammo.btVehicleTuning;var a=new this.Ammo.btDefaultVehicleRaycaster(this.physicsWorld);this.vehicle=new this.Ammo.btRaycastVehicle(this.tuning,this.rigidBody,a),this.vehicle.setCoordinateSystem(0,1,2),this.physicsWorld.addAction(this.vehicle);this.addWheel(!0,new this.Ammo.btVector3(.85,.2,1.65),.35,.35,0,1),this.addWheel(!0,new this.Ammo.btVector3(-.85,.2,1.65),.35,.35,1,-1),this.addWheel(!1,new this.Ammo.btVector3(.85,.2,-1.45),.35,.35,2,1),this.addWheel(!1,new this.Ammo.btVector3(-.85,.2,-1.45),.35,.35,3,-1),this.mass>0&&this.rigidBody.setActivationState(4)}addWheel(t,e,s,i,n,a){var r=new this.Ammo.btVector3(0,-1,0),o=new this.Ammo.btVector3(-1,0,0),h=this.vehicle.addWheel(e,r,o,.6,s,this.tuning,t);h.set_m_suspensionStiffness(2),h.set_m_wheelsDampingRelaxation(3.3),h.set_m_wheelsDampingCompression(4.4),h.set_m_frictionSlip(1e3),h.set_m_rollInfluence(.2)}updatePhysics(){let t={chassis:{position:null,rotation:null},wheels:[]};for(let n=0;n<this.vehicle.getNumWheels();n++){this.vehicle.updateWheelTransform(n,!0);let e=this.vehicle.getWheelTransformWS(n),s=e.getOrigin(),i=e.getRotation();t.wheels.push({position:new o.Jb(s.x(),s.y(),s.z()),rotation:new o.Kb(i.x(),i.y(),i.z(),i.w())})}let e=this.vehicle.getChassisWorldTransform(),s=e.getOrigin(),i=e.getRotation();return t.chassis={position:new o.Jb(s.x(),s.y(),s.z()),rotation:new o.Kb(i.x(),i.y(),i.z(),i.w())},t}getRigidBody(){return this.rigidBody}setEngineForce(t){this.vehicle.applyEngineForce(t,2),this.vehicle.applyEngineForce(t,3)}brake(t){let e=Math.abs(this.vehicle.getCurrentSpeedKmHour()),s=100/e;0===e&&(s=0),t+=s,this.vehicle.setBrake(t/2,0),this.vehicle.setBrake(t/2,1),this.vehicle.setBrake(t,2),this.vehicle.setBrake(t,3)}setSteeringRotation(t){this.vehicle.setSteeringValue(-.5*t,0),this.vehicle.setSteeringValue(-.5*t,1)}getVelocity(){return this.vehicle.getCurrentSpeedKmHour()}}const Z=8e3,k=200;class U{changeValueInRPMCurve(t,e,s,i){let n;if(e){n=2*(t-s/Z)}else n=1.5*-t;return(i+=n)>600?i=600:i<0&&(i=0),[s=Z*(1-Math.exp(-i/k)),i]}}class B extends U{accelerate(t,e,s){return this.changeValueInRPMCurve(0,!0,e,s)}brake(t,e,s){return this.changeValueInRPMCurve(t,!1,e,s)}}class W extends U{accelerate(t,e,s){return this.changeValueInRPMCurve(t,!0,e,s)}brake(t,e,s){return this.changeValueInRPMCurve(t,!1,e,s)}}class J{constructor(t){this.engineState=new B,this.currentRPM=0,this.currentXInRPMCurve=0,this.playbackRate=1.1,this.useAudio=t}turnOn(){this.engineState instanceof B&&(this.engineState=new W,this.useAudio&&(new Audio("./sounds/encendido.wav").play(),setTimeout((()=>{this.soundEngine=new(window.AudioContext||window.webkitAudioContext),fetch("./sounds/engine.wav").then((t=>t.arrayBuffer())).then((t=>this.soundEngine.decodeAudioData(t))).then((t=>{this.soundEngineSource=this.soundEngine.createBufferSource(),this.soundEngineSource.buffer=t,this.soundEngineSource.loop=!0,this.soundEngineSource.connect(this.soundEngine.destination),this.soundEngineSource.start()}))}),1300)))}clutchIsPressed(t){return t<=.25}handleEngineShutdown(t,e){e.shutDownEngine(t,this.currentRPM)&&this.engineState instanceof W&&(this.engineState=new B)}isInConditionToAccelerate(t){return this.currentRPM>=0&&!this.clutchIsPressed(t)||this.clutchIsPressed(t)}engineCanApplyForce(t){return this.currentRPM>=0&&!this.clutchIsPressed(t)}accelerate(t,e,s){let i=this.engineState.accelerate(e,this.currentRPM,this.currentXInRPMCurve);this.currentRPM=i[0],this.soundEngineSource&&(this.soundEngineSource.playbackRate.value=1.1+this.currentRPM/Z*2),this.currentXInRPMCurve=i[1],this.handleEngineShutdown(t,s)}brake(t,e,s){let i=this.engineState.brake(e,this.currentRPM,this.currentXInRPMCurve);this.currentRPM=i[0],this.soundEngineSource&&(this.soundEngineSource.playbackRate.value=1.1+this.currentRPM/Z*2),this.currentXInRPMCurve=i[1],this.handleEngineShutdown(t,s)}changeRPM(t){this.currentRPM=t,-this.currentRPM/Z+1>0?(this.currentXInRPMCurve=-Math.log(-this.currentRPM/Z+1)*k,this.currentXInRPMCurve<0&&(this.currentXInRPMCurve=0)):this.currentRPM===Z&&(this.currentXInRPMCurve=600)}getCurrentRPM(){return this.currentRPM}}class H{constructor(t){this.NEUTRAL=0,this.REVERSE=-1,this.FIRST=1,this.SECOND=2,this.THIRD=3,this.FOURTH=4,this.FIFTH=5,this.SIXTH=6,this.validShifts=[this.REVERSE,this.NEUTRAL,this.FIRST,this.SECOND,this.THIRD,this.FOURTH,this.FIFTH,this.SIXTH],this.currentShift=this.NEUTRAL,this.carEngine=t,this.minimumVelocityOnShift=[0,10,20,35,60,90],this.maximumVelocityOnShift=[40,60,80,110,140,200]}isValidShift(t){if(this.validShifts.indexOf(t)>=0)return!0;throw new Error("Shift "+t+" is not valid.")}calculateNormalFactorRPM(t,e){return(e-this.minimumVelocityOnShift[Math.abs(t)-1])/(this.maximumVelocityOnShift[Math.abs(t)-1]-this.minimumVelocityOnShift[Math.abs(t)-1])}getValueForNewRPM(t,e){if(t===this.NEUTRAL||Math.abs(t)===this.FIRST&&Math.abs(e)<5)return this.carEngine.getCurrentRPM();if(t===this.REVERSE&&e>0)return 0;if(t>0&&e<0)return 0;let s=this.calculateNormalFactorRPM(t,e);if(s>1)return Z;{let t=s*k;return Z*(1-Math.exp(-t/k))}}clutchIsPressed(t){return t<=-.75}shutDownEngine(){return!1}getEngineForce(t,e){t=Math.abs(t);let s=this.carEngine.getCurrentRPM();if(this.currentShift===this.NEUTRAL)return 0;let i=(e+1)/2,n=this.minimumVelocityOnShift[Math.abs(this.currentShift)-1]*(1-Math.exp(3*-i)),a=(1-(t-n)/(this.maximumVelocityOnShift[Math.abs(this.currentShift)-1]-n))**2;return a>1&&(a=0),6/this.currentShift*s*a}changeShift(){}getCurrentShift(){return this.currentShift}}class N extends H{changeShift(t,e,s){if(!this.isValidShift(e)||!this.clutchIsPressed(t))throw new Error("Can't change shift if clutch is not pressed");this.currentShift=e,this.carEngine.changeRPM(this.getValueForNewRPM(e,s,t))}shutDownEngine(t,e){return!this.clutchIsPressed(t)&&e<1e3}}class G extends H{changeShift(t,e,s){this.isValidShift(e)&&(this.currentShift=e,this.carEngine.changeRPM(this.getValueForNewRPM(e,s,t)))}}class Q extends P{constructor(t,e){let s=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:(new o.pb).identity();super(),this.carEngine=new J(s),this.shiftBox=new G(this.carEngine),this.currentDirectionTurn=0,this.currentTireRotation=0,this.position=new o.Jb(e[0],e[1],e[2]),this.rotationQuaternion=i,this.mass=1e3,this.physicsShape=new o.Jb(2,1.3,5),this.rotation=new o.Kb(0,0,0,1),this.inertia=new o.Jb(1,0,1),this.carPhysics=new D(this.position,this.rotationQuaternion,this.inertia,this.mass,this.physicsShape,t,0),this.turnRigthLigth=!1,this.turnLeftLigth=!1}accelerate(t,e){this.carEngine.accelerate(t,e,this.shiftBox),e>.1&&this.carEngine.engineCanApplyForce(t)?this.carPhysics.setEngineForce(this.shiftBox.getEngineForce(this.carPhysics.getVelocity(),t)):this.carPhysics.setEngineForce(0)}brake(t,e){this.carEngine.brake(t,e,this.shiftBox),this.carPhysics.brake(180*e)}doHorn(){new Audio("./sounds/bocina.wav").play()}changeShift(t,e){this.shiftBox.changeShift(t,e,this.carPhysics.getVelocity())}turnRightLight(){!this.turnRigthLigth&&this.turnLeftLigth&&(this.turnLeftLigth=!1),this.turnRigthLigth=!this.turnRigthLigth}turnLeftLight(){!this.turnLeftLigth&&this.turnRigthLigth&&(this.turnRigthLigth=!1),this.turnLeftLigth=!this.turnLeftLigth}turnParkingLight(){this.turnLeftLigth&&this.turnRigthLigth?(this.turnLeftLigth=!this.turnLeftLigth,this.turnRigthLigth=!this.turnRigthLigth):(this.turnRigthLigth=!0,this.turnLeftLigth=!0)}turnOnCar(){this.carEngine.turnOn()}turnDirection(t){this.currentTireRotation=t,this.carPhysics.setSteeringRotation(t)}update(){let t=this.carPhysics.updatePhysics();this.position=t.chassis.position,this.rotation=t.chassis.rotation,this.wheelsData=t.wheels,super.notifyObservers(this.getDataToAnimate())}getLastRotation(){return this.currentTireRotation}getDataToAnimate(){const t=new o.Jb(0,0,1).applyQuaternion(this.rotation),e=new o.Jb(0,0,1).applyAxisAngle(new o.Jb(0,1,0),-Math.PI/2).applyQuaternion(this.rotation);return{direction:this.currentDirectionTurn,velocity:this.carPhysics.getVelocity(),lastRotationWheel:this.currentTireRotation,dirVector:t,frontPosition:new o.Jb(this.position.x+2.5*t.x,this.position.y,this.position.z+2.5*t.z),backPosition:new o.Jb(this.position.x-2.5*t.x,this.position.y,this.position.z-2.5*t.z),rightDirection:e,position:this.position,rotation:this.rotation,physicsBody:this.carPhysics,wheelsData:this.wheelsData,rpm:this.getCurrentRPM(),turnRigthLigth:this.turnRigthLigth,turnLeftLigth:this.turnLeftLigth}}getSpeed(){return this.carPhysics.getVelocity()}getCurrentRPM(){return this.carEngine.getCurrentRPM()}changeShiftBox(t){"semi-auto"===t?this.shiftBox=new G(this.carEngine):"manual"===t&&(this.shiftBox=new N(this.carEngine))}getCurrentShift(){return this.shiftBox.getCurrentShift()}}class z extends P{constructor(t,e,s,i,n,a,r){super(),this.position=t,this.quaternion=e,this.inertia=s,this.mass=i,this.shape=n,this.physicsWorld=a,r||(r=1),this.friction=r}async generateShape(){return null}async buildAmmoPhysics(){let t=await L.getInstance();this.inertia=new t.btVector3(this.inertia.x,this.inertia.y,this.inertia.z),this.Ammo=t;let e=new t.btTransform;e.setIdentity(),e.setOrigin(new t.btVector3(this.position.x,this.position.y,this.position.z)),e.setRotation(new t.btQuaternion(this.quaternion.x,this.quaternion.y,this.quaternion.z,this.quaternion.w)),this.tempTransform=new t.btTransform;let s=new t.btDefaultMotionState(e),i=await this.generateShape();i.calculateLocalInertia(this.mass,this.inertia);let n=new t.btRigidBodyConstructionInfo(this.mass,s,i,this.inertia);this.rigidBody=new t.btRigidBody(n),this.rigidBody.setFriction(this.friction),this.rigidBody.setRollingFriction(2*this.friction),this.physicsWorld.addRigidBody(this.rigidBody),this.mass>0&&this.rigidBody.setActivationState(4)}updatePhysics(){let t=this.rigidBody.getMotionState();if(t){t.getWorldTransform(this.tempTransform);let e=this.tempTransform.getOrigin(),s=this.tempTransform.getRotation();const i={position:new o.Jb(e.x(),e.y(),e.z()),rotation:new o.Kb(s.x(),s.y(),s.z(),s.w())};return this.notifyObservers(i),i}throw new Error("No motion state found in rigid body")}setLinearVelocity(t){let e=new this.Ammo.btVector3(this.mass*t.x,this.mass*t.y,this.mass*t.z);this.rigidBody.applyForce(e)}getRigidBody(){return this.rigidBody}}class V extends z{async generateShape(){let t=await L.getInstance();const e=new t.btBoxShape(new t.btVector3(this.shape.x/2,this.shape.y/2,this.shape.z/2));return e.setMargin(.05),e}}class F extends b{constructor(t){super(t),this.pathToTexture=t,this.RADIUS_TOP=.1,this.RADIUS_BOTTOM=.8,this.HEIGHT=1.25,this.observedState=null}animate(){null!=this.observedState&&(this.threeDModel.position.set(this.observedState.position.x,this.observedState.position.y,this.observedState.position.z),this.threeDModel.quaternion.set(this.observedState.rotation.x,this.observedState.rotation.y,this.observedState.rotation.z,this.observedState.rotation.w))}async addToScene(t,e,s,i){if(!this.threeDModel){const n=new o.l(this.RADIUS_TOP,this.RADIUS_BOTTOM,this.HEIGHT,32,void 0,!0),a=(new o.Cb).load(this.pathToTexture),r=new o.U({map:a}),h=new o.U({color:13984548}),l=new o.e(2*this.RADIUS_BOTTOM,.1,2*this.RADIUS_BOTTOM),c=new o.T(l,h);c.position.set(0,-this.HEIGHT/2,0);const d=new o.T(n,r);d.castShadow=!0,d.receiveShadow=!0,d.position.set(0,0,0),this.threeDModel=new o.u,this.threeDModel.add(d).add(c),this.threeDModel.name=e,this.threeDModel.position.set(s[0],s[1],s[2]),this.threeDModel.scale.set(i[0],i[1],i[2]),this.RADIUS_TOP*=i[0],this.RADIUS_BOTTOM*=i[0],this.HEIGHT*=i[1],t.add(this.threeDModel)}return this}}class X extends z{async generateShape(){let t=await L.getInstance();const e=new t.btCylinderShape(new t.btVector3(this.shape.x,this.shape.y,this.shape.z));return e.setMargin(.05),e}}class K extends z{async generateShape(){let t=await L.getInstance(),e=new t.btTriangleMesh,s=new t.btVector3(0,0,0),i=new t.btVector3(0,0,0),n=new t.btVector3(0,0,0),a=this.shape.getAttribute("position").array,r=[];for(let h=0;h<a.length;h+=3)r.push({x:a[h],y:a[h+1],z:a[h+2]});for(let h=0;h<r.length-3;h+=3)s.setX(r[h].x),s.setY(r[h].y),s.setZ(r[h].z),i.setX(r[h+1].x),i.setY(r[h+1].y),i.setZ(r[h+1].z),n.setX(r[h+2].x),n.setY(r[h+2].y),n.setZ(r[h+2].z),e.addTriangle(s,i,n,!0);t.destroy(s),t.destroy(i),t.destroy(n);var o=new t.btBvhTriangleMeshShape(e,!0);return o.setMargin(0),o}}class q extends b{constructor(t){super(t),this.pathToTexture=t,this.pathToNormalMap="textures/pavimento_map.png",this.SIZE=30,this.SIDEWALK_HEIGHT=.4,this.observedState=null}animate(){null!=this.observedState&&(this.threeDModel.position.set(this.observedState.position.x,this.observedState.position.y,this.observedState.position.z),this.threeDModel.quaternion.set(this.observedState.rotation.x,this.observedState.rotation.y,this.observedState.rotation.z,this.observedState.rotation.w))}createSidewalkMesh(t){const e=(new o.Cb).load("textures/pavimento.jpg");e.wrapS=o.rb,e.wrapT=o.rb,e.repeat.set(3,10*t);const s=new o.W({map:e,side:o.n}),i=new o.e(7*this.SIZE/24,this.SIDEWALK_HEIGHT,this.SIZE);return new o.T(i,s)}createStreetMesh(t){const e=new o.e(10*this.SIZE/24,.1,this.SIZE),s=(new o.Cb).load(this.pathToTexture);s.repeat.set(1,2*t),s.wrapS=o.rb,s.wrapT=o.rb;const i=new o.W({map:s,side:o.n}),n=new o.T(e,i);return n.receiveShadow=!0,n}async loadBuildingBlock(t){const e=await w.getInstance();return(await e[`building_${t}`]).clone()}async createBuildings(t,e){let s=await this.loadBuildingBlock(1+parseInt(4*Math.random()));s.name="buildingsRight_"+e,s.position.x=10*this.SIZE/24,s.position.y=this.SIDEWALK_HEIGHT+.05,s.position.z=-this.LONG/2+4+7.5*e,s.scale.x=.8,s.scale.y=1,s.scale.z=.6,s.rotateOnAxis(new o.Jb(0,1,0),-Math.PI/2),s.updateMatrix(),s.updateMatrixWorld(),s.matrixAutoUpdate=!1;let i=await this.loadBuildingBlock(1+parseInt(4*Math.random()));i.name="buildingsLeft_"+e,i.position.x=-10*this.SIZE/24,i.position.y=this.SIDEWALK_HEIGHT+.05,i.position.z=-this.LONG/2+4+7.5*e,i.scale.x=.8,i.scale.y=1,i.scale.z=.6,i.rotateOnAxis(new o.Jb(0,1,0),Math.PI/2),i.updateMatrix(),i.updateMatrixWorld(),i.matrixAutoUpdate=!1,this.threeDModel.add(s,i)}async addToScene(t,e,s,i,n){if(!this.threeDModel){const a=this.createStreetMesh(i),r=this.createSidewalkMesh(i),h=this.createSidewalkMesh(i);a.position.set(0,0,0),r.position.set(-8.4*this.SIZE/24,this.SIDEWALK_HEIGHT/2,0),h.position.set(8.4*this.SIZE/24,this.SIDEWALK_HEIGHT/2,0),this.threeDModel=new o.u,this.threeDModel.add(a).add(r).add(h);for(let t=0;t<4*i;t++)this.createBuildings(s,t);this.threeDModel.name=e,this.threeDModel.position.set(s[0],s[1],s[2]),this.threeDModel.rotateOnAxis(new o.Jb(0,1,0),n),a.scale.set(1,1,i),r.scale.set(1,1,i),h.scale.set(1,1,i),a.updateMatrix(),a.updateMatrixWorld(),a.matrixAutoUpdate=!1,r.updateMatrix(),r.updateMatrixWorld(),r.matrixAutoUpdate=!1,h.updateMatrix(),h.updateMatrixWorld(),h.matrixAutoUpdate=!1,this.threeDModel.updateMatrix(),this.threeDModel.updateMatrixWorld(),this.threeDModel.matrixAutoUpdate=!1,this.LONG=this.SIZE*i,this.threeDModel.LONG=this.LONG,this.threeDModel.SIZE=this.SIZE,t.add(this.threeDModel)}return this}}class Y extends b{constructor(t){super(t),this.pathToTexture=t,this.pathToNormalMap="textures/pavimento_map.png",this.SIZE=30,this.SIDEWALK_HEIGHT=.4,this.SQUARE_SIZE=8.87,this.observedState=null}animate(){null!=this.observedState&&(this.threeDModel.position.set(this.observedState.position.x,this.observedState.position.y,this.observedState.position.z),this.threeDModel.quaternion.set(this.observedState.rotation.x,this.observedState.rotation.y,this.observedState.rotation.z,this.observedState.rotation.w))}getLerpPoints(t,e,s){const i=[];for(let n=0;n<=s;n++)i.push(new o.Jb(t.x+(e.x-t.x)*n/s,t.y+(e.y-t.y)*n/s,t.z+(e.z-t.z)*n/s));return i}createSidewalkCurve(){let t=new o.Jb(-this.SQUARE_SIZE/2,0,-this.SQUARE_SIZE/2);const e=this.getLerpPoints(t,new o.Jb(-this.SQUARE_SIZE/2,0,this.SQUARE_SIZE/10),5),s=new o.ob(new o.Ib(-this.SQUARE_SIZE/2,this.SQUARE_SIZE/10),new o.Ib(-this.SQUARE_SIZE/2,this.SQUARE_SIZE/2),new o.Ib(-this.SQUARE_SIZE/10,this.SQUARE_SIZE/2)).getPoints(10);for(let r=0;r<s.length;r++)s[r]=new o.Jb(s[r].x,0,s[r].y);const i=this.getLerpPoints(new o.Jb(-this.SQUARE_SIZE/10,0,this.SQUARE_SIZE/2),new o.Jb(this.SQUARE_SIZE/2,0,this.SQUARE_SIZE/2),5),n=this.getLerpPoints(new o.Jb(this.SQUARE_SIZE/2,0,this.SQUARE_SIZE/2),new o.Jb(this.SQUARE_SIZE/2,0,-this.SQUARE_SIZE/2),5),a=this.getLerpPoints(new o.Jb(this.SQUARE_SIZE/2,0,-this.SQUARE_SIZE/2),new o.Jb(-this.SQUARE_SIZE/2,0,-this.SQUARE_SIZE/2),5);return[...e,...s,...i,...n,...a]}getGeometrySidewalk(){const t=new o.g,e=this.createSidewalkCurve(),s=e.length,i=[[],[],[]],n=[],a=[],r=[],h=[];let l=0,c=0;for(let o=0;o<e.length;o++)l+=e[o].x,c+=e[o].z;for(let o=0;o<e.length;o++)i[0].push(e[o].x,e[o].y,e[o].z),i[1].push(e[o].x,this.SIDEWALK_HEIGHT,e[o].z),i[2].push(l/e.length,this.SIDEWALK_HEIGHT,c/e.length),a.push(.03414,0),r.push((e[o].x+this.SQUARE_SIZE/2)/this.SQUARE_SIZE,(e[o].z+this.SQUARE_SIZE/2)/this.SQUARE_SIZE),h.push((l/e.length+this.SQUARE_SIZE/2)/this.SQUARE_SIZE,(c/e.length+this.SQUARE_SIZE/2)/this.SQUARE_SIZE);const d=[...a,...a,...r,...h],u=[...i[0],...i[1],...i[1],...i[2]];for(let o=0;o<3;o++)for(let t=1;t<s;t++)n.push(o*s+t-1),n.push((o+1)*s+t-1),n.push(o*s+t),n.push(o*s+t),n.push((o+1)*s+t-1),n.push((o+1)*s+t);const p=new Float32Array(u),g=new Float32Array(d);return t.setIndex(n),t.setAttribute("position",new o.f(p,3)),t.setAttribute("uv",new o.f(g,2)),t.computeVertexNormals(),t}createSidewalkMesh(){const t=(new o.Cb).load("textures/pavimento.jpg");t.repeat.set(3,3),t.wrapS=o.rb,t.wrapT=o.rb;const e=new o.W({map:t,side:o.n}),s=this.getGeometrySidewalk(),i=new o.T(s,e);return i.receiveShadow=!0,i.castShadow=!0,i}createStreetMesh(){const t=new o.e(this.SIZE,.1,this.SIZE),e=(new o.Cb).load(this.pathToTexture);e.repeat.set(1,1),e.wrapS=o.rb,e.wrapT=o.rb;const s=new o.W({map:e,side:o.n}),i=new o.T(t,s);return i.receiveShadow=!0,i}async addToScene(t,e,s){if(!this.threeDModel){const i=this.createStreetMesh();i.position.set(0,0,0),this.threeDModel=new o.u,this.threeDModel.add(i);for(let t=0;t<4;t++){const e=this.createSidewalkMesh();0===t?(e.position.set(-this.SIZE/2+this.SQUARE_SIZE/2,0,-this.SIZE/2+this.SQUARE_SIZE/2),e.rotateOnAxis(new o.Jb(0,1,0),Math.PI/2)):2===t?(e.position.set(-this.SIZE/2+this.SQUARE_SIZE/2,0,this.SIZE/2-this.SQUARE_SIZE/2),e.rotateOnAxis(new o.Jb(0,1,0),Math.PI)):3===t?e.position.set(this.SIZE/2-this.SQUARE_SIZE/2,0,-this.SIZE/2+this.SQUARE_SIZE/2):(e.position.set(this.SIZE/2-this.SQUARE_SIZE/2,0,this.SIZE/2-this.SQUARE_SIZE/2),e.rotateOnAxis(new o.Jb(0,1,0),-Math.PI/2)),e.updateMatrix(),e.updateMatrixWorld(),e.matrixAutoUpdate=!1,this.threeDModel.add(e)}this.threeDModel.name=e,this.threeDModel.receiveShadow=!0,this.threeDModel.position.set(s[0],s[1],s[2]),i.updateMatrix(),i.updateMatrixWorld(),i.matrixAutoUpdate=!1,this.threeDModel.updateMatrix(),this.threeDModel.updateMatrixWorld(),this.threeDModel.matrixAutoUpdate=!1,t.add(this.threeDModel)}return this}}class $ extends b{constructor(t){super(t),this.pathToTexture=t,this.pathToNormalMap="textures/pavimento_map.png",this.SIZE=30,this.SIDEWALK_HEIGHT=.4,this.SQUARE_SIZE=8.87,this.TOP_CENTER=[this.SIZE/2-this.SQUARE_SIZE,this.SIDEWALK_HEIGHT,-this.SIZE/2+this.SQUARE_SIZE],this.observedState=null}animate(){null!=this.observedState&&(this.threeDModel.position.set(this.observedState.position.x,this.observedState.position.y,this.observedState.position.z),this.threeDModel.quaternion.set(this.observedState.rotation.x,this.observedState.rotation.y,this.observedState.rotation.z,this.observedState.rotation.w))}getLerpPoints(t,e,s){const i=[];for(let n=0;n<=s;n++)i.push(new o.Jb(t.x+(e.x-t.x)*n/s,t.y+(e.y-t.y)*n/s,t.z+(e.z-t.z)*n/s));return i}createSidewalkCurve(){let t=new o.Jb(-this.SQUARE_SIZE/2,0,-this.SQUARE_SIZE/2);const e=this.getLerpPoints(t,new o.Jb(-this.SQUARE_SIZE/2,0,this.SQUARE_SIZE/10),5),s=new o.ob(new o.Ib(-this.SQUARE_SIZE/2,this.SQUARE_SIZE/10),new o.Ib(-this.SQUARE_SIZE/2,this.SQUARE_SIZE/2),new o.Ib(-this.SQUARE_SIZE/10,this.SQUARE_SIZE/2)).getPoints(10);for(let r=0;r<s.length;r++)s[r]=new o.Jb(s[r].x,0,s[r].y);const i=this.getLerpPoints(new o.Jb(-this.SQUARE_SIZE/10,0,this.SQUARE_SIZE/2),new o.Jb(this.SQUARE_SIZE/2,0,this.SQUARE_SIZE/2),5),n=this.getLerpPoints(new o.Jb(this.SQUARE_SIZE/2,0,this.SQUARE_SIZE/2),new o.Jb(this.SQUARE_SIZE/2,0,-this.SQUARE_SIZE/2),5),a=this.getLerpPoints(new o.Jb(this.SQUARE_SIZE/2,0,-this.SQUARE_SIZE/2),new o.Jb(-this.SQUARE_SIZE/2,0,-this.SQUARE_SIZE/2),5);return[...e,...s,...i,...n,...a]}createLongSidewalkCurve(){let t=new o.Jb(-this.SIZE/2,0,-this.SIZE/2);const e=this.getLerpPoints(t,new o.Jb(this.SIZE/2,0,-this.SIZE/2),5),s=this.getLerpPoints(new o.Jb(this.SIZE/2,0,-this.SIZE/2),new o.Jb(this.SIZE/2,0,this.SIZE/2),5),i=this.getLerpPoints(new o.Jb(this.SIZE/2,0,this.SIZE/2),new o.Jb(this.SIZE/2-this.SQUARE_SIZE,0,this.SIZE/2),5),n=this.getLerpPoints(new o.Jb(this.SIZE/2-this.SQUARE_SIZE,0,this.SIZE/2),new o.Jb(this.SIZE/2-this.SQUARE_SIZE,0,this.SIZE/2-this.SQUARE_SIZE),5);let a=new o.ob(new o.Ib(this.SIZE/2-this.SQUARE_SIZE,this.SIZE/2-this.SQUARE_SIZE),new o.Ib(this.SIZE/2-this.SQUARE_SIZE,-this.SIZE/2+this.SQUARE_SIZE),new o.Ib(-this.SIZE/2+this.SQUARE_SIZE,-this.SIZE/2+this.SQUARE_SIZE)).getPoints(30);for(let l=0;l<a.length;l++)a[l]=new o.Jb(a[l].x,0,a[l].y);const r=this.getLerpPoints(new o.Jb(-this.SIZE/2+this.SQUARE_SIZE,0,-this.SIZE/2+this.SQUARE_SIZE),new o.Jb(-this.SIZE/2,0,-this.SIZE/2+this.SQUARE_SIZE),5),h=this.getLerpPoints(new o.Jb(-this.SIZE/2,0,-this.SIZE/2+this.SQUARE_SIZE),new o.Jb(-this.SIZE/2,0,-this.SIZE/2),5);return[...e,...s,...i,...n,...a,...r,...h]}getGeometrySidewalk(){const t=new o.g,e=this.createSidewalkCurve(),s=e.length,i=[[],[],[]],n=[],a=[],r=[],h=[];for(let o=0;o<e.length;o++)i[0].push(e[o].x,e[o].y,e[o].z),i[1].push(e[o].x,this.SIDEWALK_HEIGHT,e[o].z),i[2].push(0/e.length,this.SIDEWALK_HEIGHT,0/e.length),a.push(.03414,0),r.push((e[o].x+this.SQUARE_SIZE/2)/this.SQUARE_SIZE,(e[o].z+this.SQUARE_SIZE/2)/this.SQUARE_SIZE),h.push((0/e.length+this.SQUARE_SIZE/2)/this.SQUARE_SIZE,(0/e.length+this.SQUARE_SIZE/2)/this.SQUARE_SIZE);const l=[...a,...a,...r,...h],c=[...i[0],...i[1],...i[1],...i[2]];for(let o=0;o<3;o++)for(let t=1;t<s;t++)n.push(o*s+t-1),n.push((o+1)*s+t-1),n.push(o*s+t),n.push(o*s+t),n.push((o+1)*s+t-1),n.push((o+1)*s+t);const d=new Float32Array(c),u=new Float32Array(l);return t.setIndex(n),t.setAttribute("position",new o.f(d,3)),t.setAttribute("uv",new o.f(u,2)),t.computeVertexNormals(),t}getGeometryLongSidewalk(){const t=new o.g,e=this.createLongSidewalkCurve(),s=e.length,i=[[],[],[]],n=[],a=[],r=[],h=[];for(let o=0;o<e.length;o++)i[0].push(e[o].x,e[o].y,e[o].z),i[1].push(e[o].x,this.SIDEWALK_HEIGHT,e[o].z),i[2].push(this.TOP_CENTER[0],this.TOP_CENTER[1],this.TOP_CENTER[2]),a.push(.03414,0),r.push((e[o].x+this.SIZE/2)/this.SIZE,(e[o].z+this.SIZE/2)/this.SIZE),h.push((this.TOP_CENTER[0]+this.SIZE/2)/this.SIZE,(this.TOP_CENTER[2]+this.SIZE/2)/this.SIZE);const l=[...a,...a,...r,...h],c=[...i[0],...i[1],...i[1],...i[2]];for(let o=0;o<3;o++)for(let t=1;t<s;t++)n.push(o*s+t-1),n.push((o+1)*s+t-1),n.push(o*s+t),n.push(o*s+t),n.push((o+1)*s+t-1),n.push((o+1)*s+t);const d=new Float32Array(c),u=new Float32Array(l);return t.setIndex(n),t.setAttribute("position",new o.f(d,3)),t.setAttribute("uv",new o.f(u,2)),t.computeVertexNormals(),t}createSidewalkMesh(){const t=(new o.Cb).load("textures/pavimento.jpg");t.repeat.set(3,3),t.wrapS=o.rb,t.wrapT=o.rb;const e=new o.W({map:t,side:o.n}),s=this.getGeometrySidewalk(),i=new o.T(s,e);return i.receiveShadow=!0,i.castShadow=!0,i}createLongSidewalkMesh(){const t=(new o.Cb).load("textures/pavimento.jpg");t.repeat.set(10,10),t.wrapS=o.rb,t.wrapT=o.rb;const e=new o.W({map:t,side:o.n}),s=this.getGeometryLongSidewalk(),i=new o.T(s,e);return i.receiveShadow=!0,i.castShadow=!0,i}async loadBuildingBlock(t){const e=await w.getInstance();return(await e[`building_${t}`]).clone()}async createBuildings(t,e){let s=await this.loadBuildingBlock(1+parseInt(4*Math.random()));s.name="buildingsCurve_"+e,s.position.x=10*this.SIZE/24,s.position.y=this.SIDEWALK_HEIGHT+.05,s.position.z=-this.SIZE/2+4+7.5*e,s.scale.x=.8,s.scale.y=1,s.scale.z=.6,s.rotateOnAxis(new o.Jb(0,1,0),-Math.PI/2),s.updateMatrix(),s.updateMatrixWorld(),s.matrixAutoUpdate=!1;let i=await this.loadBuildingBlock(1+parseInt(4*Math.random()));i.name="buildingsCurveOtherSide_"+e,i.position.x=-this.SIZE/2+4+7.5*e,i.position.y=this.SIDEWALK_HEIGHT+.05,i.position.z=10*this.SIZE/24,i.scale.x=.8,i.scale.y=1,i.scale.z=.6,i.rotateOnAxis(new o.Jb(0,1,0),Math.PI),i.updateMatrix(),i.updateMatrixWorld(),i.matrixAutoUpdate=!1,this.threeDModel.add(s,i)}createStreetMesh(){const t=new o.e(this.SIZE,.1,this.SIZE),e=(new o.Cb).load(this.pathToTexture);e.repeat.set(1,1),e.wrapS=o.rb,e.wrapT=o.rb;const s=new o.W({map:e,side:o.n}),i=new o.T(t,s);return i.receiveShadow=!0,i}async addToScene(t,e,s,i){if(!this.threeDModel){const n=this.createStreetMesh();n.position.set(0,0,0),this.threeDModel=new o.u,this.threeDModel.add(n);const a=this.createSidewalkMesh();a.position.set(-this.SIZE/2+this.SQUARE_SIZE/2,0,-this.SIZE/2+this.SQUARE_SIZE/2),a.rotateOnAxis(new o.Jb(0,1,0),Math.PI/2),a.updateMatrix(),a.updateMatrixWorld(),a.matrixAutoUpdate=!1;const r=this.createLongSidewalkMesh();r.position.set(0,0,0),r.rotateOnAxis(new o.Jb(0,1,0),-Math.PI/2),r.updateMatrix(),r.updateMatrixWorld(),r.matrixAutoUpdate=!1,this.threeDModel.add(a).add(r);for(let t=0;t<3;t++)this.createBuildings(s,t);this.threeDModel.name=e,this.threeDModel.receiveShadow=!0,this.threeDModel.position.set(s[0],s[1],s[2]),this.threeDModel.rotateOnAxis(new o.Jb(0,1,0),i),n.updateMatrix(),n.updateMatrixWorld(),n.matrixAutoUpdate=!1,this.threeDModel.updateMatrix(),this.threeDModel.updateMatrixWorld(),this.threeDModel.matrixAutoUpdate=!1,t.add(this.threeDModel)}return this}}class tt extends b{constructor(t){super(t),this.pathToTexture=t,this.pathToNormalMap="textures/pavimento_map.png",this.SIZE=30,this.SIDEWALK_HEIGHT=.4,this.SQUARE_SIZE=8.87,this.observedState=null}animate(){null!=this.observedState&&(this.threeDModel.position.set(this.observedState.position.x,this.observedState.position.y,this.observedState.position.z),this.threeDModel.quaternion.set(this.observedState.rotation.x,this.observedState.rotation.y,this.observedState.rotation.z,this.observedState.rotation.w))}getLerpPoints(t,e,s){const i=[];for(let n=0;n<=s;n++)i.push(new o.Jb(t.x+(e.x-t.x)*n/s,t.y+(e.y-t.y)*n/s,t.z+(e.z-t.z)*n/s));return i}createSidewalkCurve(){let t=new o.Jb(-this.SQUARE_SIZE/2,0,-this.SQUARE_SIZE/2);const e=this.getLerpPoints(t,new o.Jb(-this.SQUARE_SIZE/2,0,this.SQUARE_SIZE/10),5),s=new o.ob(new o.Ib(-this.SQUARE_SIZE/2,this.SQUARE_SIZE/10),new o.Ib(-this.SQUARE_SIZE/2,this.SQUARE_SIZE/2),new o.Ib(-this.SQUARE_SIZE/10,this.SQUARE_SIZE/2)).getPoints(10);for(let r=0;r<s.length;r++)s[r]=new o.Jb(s[r].x,0,s[r].y);const i=this.getLerpPoints(new o.Jb(-this.SQUARE_SIZE/10,0,this.SQUARE_SIZE/2),new o.Jb(this.SQUARE_SIZE/2,0,this.SQUARE_SIZE/2),5),n=this.getLerpPoints(new o.Jb(this.SQUARE_SIZE/2,0,this.SQUARE_SIZE/2),new o.Jb(this.SQUARE_SIZE/2,0,-this.SQUARE_SIZE/2),5),a=this.getLerpPoints(new o.Jb(this.SQUARE_SIZE/2,0,-this.SQUARE_SIZE/2),new o.Jb(-this.SQUARE_SIZE/2,0,-this.SQUARE_SIZE/2),5);return[...e,...s,...i,...n,...a]}getGeometrySidewalk(){const t=new o.g,e=this.createSidewalkCurve(),s=e.length,i=[[],[],[]],n=[],a=[],r=[],h=[];let l=0,c=0;for(let o=0;o<e.length;o++)l+=e[o].x,c+=e[o].z;for(let o=0;o<e.length;o++)i[0].push(e[o].x,e[o].y,e[o].z),i[1].push(e[o].x,this.SIDEWALK_HEIGHT,e[o].z),i[2].push(l/e.length,this.SIDEWALK_HEIGHT,c/e.length),a.push(.03414,0),r.push((e[o].x+this.SQUARE_SIZE/2)/this.SQUARE_SIZE,(e[o].z+this.SQUARE_SIZE/2)/this.SQUARE_SIZE),h.push((l/e.length+this.SQUARE_SIZE/2)/this.SQUARE_SIZE,(c/e.length+this.SQUARE_SIZE/2)/this.SQUARE_SIZE);const d=[...a,...a,...r,...h],u=[...i[0],...i[1],...i[1],...i[2]];for(let o=0;o<3;o++)for(let t=1;t<s;t++)n.push(o*s+t-1),n.push((o+1)*s+t-1),n.push(o*s+t),n.push(o*s+t),n.push((o+1)*s+t-1),n.push((o+1)*s+t);const p=new Float32Array(u),g=new Float32Array(d);return t.setIndex(n),t.setAttribute("position",new o.f(p,3)),t.setAttribute("uv",new o.f(g,2)),t.computeVertexNormals(),t}createSidewalkMesh(){const t=(new o.Cb).load("textures/pavimento.jpg");t.repeat.set(3,3),t.wrapS=o.rb,t.wrapT=o.rb;const e=new o.W({map:t,side:o.n}),s=this.getGeometrySidewalk(),i=new o.T(s,e);return i.receiveShadow=!0,i.castShadow=!0,i}async loadBuildingBlock(t){const e=await w.getInstance();return(await e[`building_${t}`]).clone()}async createBuilding(t,e){let s=await this.loadBuildingBlock(1+parseInt(4*Math.random()));s.name="buildingsRight_"+e,s.position.x=10*this.SIZE/24,s.position.y=this.SIDEWALK_HEIGHT+.05,s.position.z=-this.SIZE/2+4+7.5*e,s.scale.x=.8,s.scale.y=1,s.scale.z=.6,s.rotateOnAxis(new o.Jb(0,1,0),-Math.PI/2),s.updateMatrix(),s.updateMatrixWorld(),s.matrixAutoUpdate=!1,this.threeDModel.add(s)}createStraightSidewalkMesh(){const t=(new o.Cb).load("textures/pavimento.jpg");t.wrapS=o.rb,t.wrapT=o.rb,t.repeat.set(3,10);const e=new o.W({map:t,side:o.n}),s=new o.e(7*this.SIZE/24,this.SIDEWALK_HEIGHT,this.SIZE);return new o.T(s,e)}createStreetMesh(){const t=new o.e(this.SIZE,.1,this.SIZE),e=(new o.Cb).load(this.pathToTexture);e.repeat.set(1,1),e.wrapS=o.rb,e.wrapT=o.rb;const s=new o.W({map:e,side:o.n}),i=new o.T(t,s);return i.receiveShadow=!0,i}async addToScene(t,e,s,i){if(!this.threeDModel){const n=this.createStreetMesh();n.position.set(0,0,0),this.threeDModel=new o.u,this.threeDModel.add(n);for(let t=0;t<2;t++){const e=this.createSidewalkMesh();0===t?(e.position.set(-this.SIZE/2+this.SQUARE_SIZE/2,0,-this.SIZE/2+this.SQUARE_SIZE/2),e.rotateOnAxis(new o.Jb(0,1,0),Math.PI/2)):(e.position.set(-this.SIZE/2+this.SQUARE_SIZE/2,0,this.SIZE/2-this.SQUARE_SIZE/2),e.rotateOnAxis(new o.Jb(0,1,0),Math.PI)),e.updateMatrix(),e.updateMatrixWorld(),e.matrixAutoUpdate=!1,this.threeDModel.add(e)}for(let t=0;t<4;t++)this.createBuilding(s,t);const a=this.createStraightSidewalkMesh();a.position.set(8.4*this.SIZE/24,this.SIDEWALK_HEIGHT/2,0),a.updateMatrix(),a.updateMatrixWorld(),a.matrixAutoUpdate=!1,this.threeDModel.add(a),this.threeDModel.name=e,this.threeDModel.receiveShadow=!0,this.threeDModel.position.set(s[0],s[1],s[2]),this.threeDModel.rotateOnAxis(new o.Jb(0,1,0),i),n.updateMatrix(),n.updateMatrixWorld(),n.matrixAutoUpdate=!1,this.threeDModel.updateMatrix(),this.threeDModel.updateMatrixWorld(),this.threeDModel.matrixAutoUpdate=!1,t.add(this.threeDModel)}return this}}class et extends b{constructor(t){super(null),this.checkpointsData=t,this.RADIUS=1,this.HEIGHT=5,this.observedState=null,this.stepHeartbeat=-.002,this.LEAST_OPACITY=.25,this.MAX_OPACITY=.5}animate(){null!=this.observedState&&(this.threeDModel.position.set(this.observedState.position.x,this.observedState.position.y,this.observedState.position.z),this.threeDModel.quaternion.set(this.observedState.rotation.x,this.observedState.rotation.y,this.observedState.rotation.z,this.observedState.rotation.w));const t=this.threeDModel.children[0].material.opacity-this.stepHeartbeat;this.threeDModel.children[0].material.opacity=t,(t<=this.LEAST_OPACITY||t>=this.MAX_OPACITY)&&(this.stepHeartbeat*=-1)}async addToScene(t,e,s,i){if(!this.threeDModel){const n=new o.l(this.RADIUS,this.RADIUS,this.HEIGHT,32),a=new o.U({color:65280,opacity:.4,transparent:!0}),r=new o.T(n,a);r.position.set(0,0,0),this.threeDModel=new o.u,this.threeDModel.add(r),this.threeDModel.name=e,this.threeDModel.position.set(s[0],s[1],s[2]),this.threeDModel.scale.set(i[0],i[1],i[2]),this.RADIUS*=i[0],this.RADIUS*=i[0],this.HEIGHT*=i[1],t.add(this.threeDModel)}return this}}class st{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this.score=t,this.timeStart=new Date}alterScore(t){if(isNaN(t))throw new Error("Solo se puede alterar el puntaje con n\xfameros.");this.score+=t}getCurrentScore(){return this.score}getCurrentTime(){const t=parseInt((new Date-this.timeStart)/1e3),e=t%60,s=parseInt((t-e)/60);return`${parseInt((s-s%60)/24).toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}:${e.toString().padStart(2,"0")}`}}class it{constructor(t,e,s,i){this.scene=t,this.physicsWorld=e,this.levelScore=new st(0),this.physicsToUpdate=[],this.objectsToAnimate=[],this.endLevel=s,this.notifyCheckpointUpdate=i,this.STREET_TYPES={STRAIGHT:this.createStreet.bind(this),CURVE:this.createCurve.bind(this),T_STREET:this.createTStreet.bind(this),INTERSECTION:this.createIntersection.bind(this)},this.OBJECTS={CONE:this.createCone.bind(this)}}updatePhysics(){this.physicsToUpdate.forEach((function(t){t.updatePhysics()}))}animate(){this.objectsToAnimate.forEach((function(t){t.animate()}))}async createRectangle(t,e,s,i,n,a,r){let h=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;const l=(new o.Cb).load(a);l.wrapS=o.rb,l.wrapT=o.rb,l.repeat.set(e,i);const c=new o.Y({map:l,side:o.n});if(h){let t=(new o.Cb).load(h);t.repeat.set(e,i),t.wrapS=o.rb,t.wrapT=o.rb,c.normalMap=t,c.normalScale.set(10,10)}const d=new o.e(e,s,i);d.rotateX(n);const u=new o.pb;u.setFromAxisAngle(new o.Jb(1,0,0),n);let p=new V(new o.Jb(t[0],t[1],t[2]),u,new r.btVector3(0,0,0),0,new o.Jb(e,s,i),this.physicsWorld,1e3);await p.buildAmmoPhysics();let g=new o.T(d,c);g.position.set(t[0],t[1],t[2]),this.scene.add(g)}async createCone(t,e,s){let i=new F("textures/coneTexture.jpg");i=await i.addToScene(this.scene,"trafficCone",t,[.5,1,.5]);let n=new X(new o.Jb(t[0],t[1],t[2]),(new o.pb).setFromAxisAngle(new o.Jb(0,1,0),s),new e.btVector3(0,0,0),10,new o.Jb(i.RADIUS_BOTTOM,i.HEIGHT/2,i.RADIUS_BOTTOM),this.physicsWorld,1e3);await n.buildAmmoPhysics(),n.rigidBody.threeObject=i,n.rigidBody.onCollide=()=>{this.levelScore.alterScore(-100)},this.physicsToUpdate.push(n),n.attachObserver(i),this.objectsToAnimate.push(i)}async buildStreetPhysics(t,e,s,i){let n=new V(new o.Jb(t[0],t[1],t[2]),(new o.pb).setFromAxisAngle(new o.Jb(0,1,0),i),new s.btVector3(0,0,0),0,new o.Jb(e.SIZE,.1,e.LONG),this.physicsWorld,1e3);await n.buildAmmoPhysics();const a=new o.Jb(-8.4*e.SIZE/24,e.SIDEWALK_HEIGHT/2,0).applyAxisAngle(new o.Jb(0,1,0),i);let r=new V(new o.Jb(t[0]+a.x,t[1]+a.y,t[2]+a.z),(new o.pb).setFromAxisAngle(new o.Jb(0,1,0),i),new s.btVector3(0,0,0),0,new o.Jb(7*e.SIZE/24,e.SIDEWALK_HEIGHT,e.LONG),this.physicsWorld,1e3);await r.buildAmmoPhysics();const h=new o.Jb(8.4*e.SIZE/24,e.SIDEWALK_HEIGHT/2,0).applyAxisAngle(new o.Jb(0,1,0),i);let l=new V(new o.Jb(t[0]+h.x,t[1]+e.SIDEWALK_HEIGHT/2+h.y,t[2]+h.z),(new o.pb).setFromAxisAngle(new o.Jb(0,1,0),i),new s.btVector3(0,0,0),0,new o.Jb(7*e.SIZE/24,e.SIDEWALK_HEIGHT,e.LONG),this.physicsWorld,1e3);await l.buildAmmoPhysics()}async buildTStreetPhysics(t,e,s,i){let n=new V(new o.Jb(t[0],t[1],t[2]),(new o.pb).identity(),new e.btVector3(0,0,0),0,new o.Jb(30,.1,30),this.physicsWorld,1e3);await n.buildAmmoPhysics();const a=new o.Jb(-s.SIZE/2+s.SQUARE_SIZE/2,0,-s.SIZE/2+s.SQUARE_SIZE/2).applyAxisAngle(new o.Jb(0,1,0),i),r=new K(new o.Jb(t[0]+a.x,t[1]+a.y,t[2]+a.z),(new o.pb).setFromAxisAngle(new o.Jb(0,1,0),Math.PI/2+i),new e.btVector3(0,0,0),0,s.getGeometrySidewalk(),this.physicsWorld,1e3);await r.buildAmmoPhysics();const h=new o.Jb(-s.SIZE/2+s.SQUARE_SIZE/2,0,s.SIZE/2-s.SQUARE_SIZE/2).applyAxisAngle(new o.Jb(0,1,0),i),l=new K(new o.Jb(t[0]+h.x,t[1]+h.y,t[2]+h.z),(new o.pb).setFromAxisAngle(new o.Jb(0,1,0),Math.PI+i),new e.btVector3(0,0,0),0,s.getGeometrySidewalk(),this.physicsWorld,1e3);await l.buildAmmoPhysics();const c=new o.Jb(8.4*s.SIZE/24,s.SIDEWALK_HEIGHT/2,0).applyAxisAngle(new o.Jb(0,1,0),i);let d=new V(new o.Jb(t[0]+c.x,t[1]+c.y,t[2]+c.z),(new o.pb).setFromAxisAngle(new o.Jb(0,1,0),i),new e.btVector3(0,0,0),0,new o.Jb(7*s.SIZE/24,s.SIDEWALK_HEIGHT,s.SIZE),this.physicsWorld,1e3);await d.buildAmmoPhysics()}async buildIntersectionPhysics(t,e,s){let i=new V(new o.Jb(t[0],t[1],t[2]),(new o.pb).identity(),new e.btVector3(0,0,0),0,new o.Jb(30,.1,30),this.physicsWorld,1e3);await i.buildAmmoPhysics();const n=new K(new o.Jb(t[0]-s.SIZE/2+s.SQUARE_SIZE/2,t[1],t[2]-s.SIZE/2+s.SQUARE_SIZE/2),(new o.pb).setFromAxisAngle(new o.Jb(0,1,0),Math.PI/2),new e.btVector3(0,0,0),0,s.getGeometrySidewalk(),this.physicsWorld,1e3);await n.buildAmmoPhysics();const a=new K(new o.Jb(t[0]-s.SIZE/2+s.SQUARE_SIZE/2,t[1],t[2]+s.SIZE/2-s.SQUARE_SIZE/2),(new o.pb).setFromAxisAngle(new o.Jb(0,1,0),Math.PI),new e.btVector3(0,0,0),0,s.getGeometrySidewalk(),this.physicsWorld,1e3);await a.buildAmmoPhysics();const r=new K(new o.Jb(t[0]+s.SIZE/2-s.SQUARE_SIZE/2,t[1],t[2]-s.SIZE/2+s.SQUARE_SIZE/2),(new o.pb).identity(),new e.btVector3(0,0,0),0,s.getGeometrySidewalk(),this.physicsWorld,1e3);await r.buildAmmoPhysics();const h=new K(new o.Jb(t[0]+s.SIZE/2-s.SQUARE_SIZE/2,t[1],t[2]+s.SIZE/2-s.SQUARE_SIZE/2),(new o.pb).setFromAxisAngle(new o.Jb(0,1,0),-Math.PI/2),new e.btVector3(0,0,0),0,s.getGeometrySidewalk(),this.physicsWorld,1e3);await h.buildAmmoPhysics()}async buildCurvePhysics(t,e,s,i){let n=new V(new o.Jb(t[0],t[1],t[2]),(new o.pb).setFromAxisAngle(new o.Jb(0,1,0),i),new e.btVector3(0,0,0),0,new o.Jb(30,.1,30),this.physicsWorld,1e3);await n.buildAmmoPhysics();const a=new o.Jb(-s.SIZE/2+s.SQUARE_SIZE/2,0,-s.SIZE/2+s.SQUARE_SIZE/2).applyAxisAngle(new o.Jb(0,1,0),i),r=new K(new o.Jb(t[0]+a.x,t[1]+a.y,t[2]+a.z),(new o.pb).setFromAxisAngle(new o.Jb(0,1,0),Math.PI/2+i),new e.btVector3(0,0,0),0,s.getGeometrySidewalk(),this.physicsWorld,1e3);await r.buildAmmoPhysics();const h=new K(new o.Jb(t[0],t[1],t[2]),(new o.pb).setFromAxisAngle(new o.Jb(0,1,0),-Math.PI/2+i),new e.btVector3(0,0,0),0,s.getGeometryLongSidewalk(),this.physicsWorld,1e3);await h.buildAmmoPhysics()}async createStreet(t,e,s,i){let n=new q("textures/road.jpg");await n.addToScene(this.scene,"street",t,i,s),await this.buildStreetPhysics(t,n,e,s)}async createIntersection(t,e){let s=new Y("textures/roadWithCrossWalk.jpg");await s.addToScene(this.scene,"intersection",t),await this.buildIntersectionPhysics(t,e,s)}async createCurve(t,e,s){let i=new $("textures/roadWithCrossWalk.jpg");await i.addToScene(this.scene,"curve",t,s),await this.buildCurvePhysics(t,e,i,s)}async createTStreet(t,e,s){let i=new tt("textures/roadWithCrossWalk.jpg");await i.addToScene(this.scene,"tStreet",t,s),await this.buildTStreetPhysics(t,e,i,s)}async createCheckpoint(t,e){let s=new et(e),i=await L.getInstance();await s.addToScene(this.scene,"checkpoint",t,[1,1,1]);let n=new X(new o.Jb(t[0],t[1],t[2]),(new o.pb).identity(),new i.btVector3(0,0,0),1,new o.Jb(s.RADIUS,s.HEIGHT/2,s.RADIUS),this.physicsWorld,1e3);this.physicsToUpdate.push(n),await n.buildAmmoPhysics(),n.rigidBody.threeObject=s,n.rigidBody.onCollide=async()=>{this.physicsWorld.removeRigidBody(n.rigidyBody),this.physicsWorld.removeCollisionObject(n.rigidBody),this.levelScore.alterScore(1e3),this.scene.remove(s.threeDModel);e.shift().end?this.endLevel(this.levelScore.getCurrentScore(),this.levelScore.getCurrentTime()):e.length>0&&(await this.createCheckpoint([e[0].position_x,1,e[0].position_y],e),this.notifyCheckpointUpdate())},n.attachObserver(s),this.objectsToAnimate.push(s)}async createLevel0(){let t=await L.getInstance();this.createRectangle([10,0,10],10,2,10,-Math.PI/8,"textures/pavimento.jpg",t,"textures/pavimento_map.png"),this.createRectangle([-10,0,10],10,2,10,-Math.PI/4,"textures/pavimento.jpg",t,"textures/pavimento_map.png"),this.createRectangle([0,0,0],100,.1,100,0,"textures/pavimento.jpg",t,"textures/pavimento_map.png"),this.createCone([0,.5,10],t),this.createCone([0,.5,30],t),this.createCone([0,.5,20],t)}async instantiateStreet(t,e,s,i){let n=await L.getInstance(),a=(30===s[0]?s[1]:s[0])/30;await this.STREET_TYPES[i]([t[0],0,t[1]],n,e,a)}async instantiateObject(t,e,s){let i=await L.getInstance();await this.OBJECTS[s]([t[0],.5,t[1]],i,e)}async createLevelCustom(t){for(let e=0;e<t.streets.length;e++){let s=t.streets[e];await this.instantiateStreet([s.position_x,s.position_y],s.rotation,[s.long_x,s.long_y],s.type)}for(let e=0;e<t.objects.length;e++){let s=t.objects[e];await this.instantiateObject([s.position_x,s.position_y],s.rotation,s.type)}return t.checkpoints.length>0&&await this.createCheckpoint([t.checkpoints[0].position_x,1,t.checkpoints[0].position_y],t.checkpoints),{physicsToUpdate:this.physicsToUpdate,objectsToAnimate:this.objectsToAnimate}}getScore(){return this.levelScore.getCurrentScore()}getTime(){return this.levelScore.getCurrentTime()}}class nt{static createButton(t){const e=document.createElement("button");function s(){e.style.display="",e.style.cursor="auto",e.style.left="calc(50% - 75px)",e.style.width="150px",e.onmouseenter=null,e.onmouseleave=null,e.onclick=null}function i(t){t.style.position="absolute",t.style.bottom="20px",t.style.padding="12px 6px",t.style.border="1px solid #fff",t.style.borderRadius="4px",t.style.background="rgba(0,0,0,0.1)",t.style.color="#fff",t.style.font="normal 13px sans-serif",t.style.textAlign="center",t.style.opacity="0.5",t.style.outline="none",t.style.zIndex="999"}if("xr"in navigator)return e.id="VRButton",e.style.display="none",i(e),navigator.xr.isSessionSupported("immersive-vr").then((function(i){i?function(){let s=null;async function i(i){i.addEventListener("end",n),await t.xr.setSession(i),e.textContent="EXIT VR",s=i}function n(){s.removeEventListener("end",n),e.textContent="ENTER VR",s=null}e.style.display="",e.style.cursor="pointer",e.style.left="calc(50% - 50px)",e.style.width="100px",e.textContent="ENTER VR",e.onmouseenter=function(){e.style.opacity="1.0"},e.onmouseleave=function(){e.style.opacity="0.5"},e.onclick=function(){if(null===s){const t={optionalFeatures:["local-floor","bounded-floor","hand-tracking","layers"]};navigator.xr.requestSession("immersive-vr",t).then(i),localStorage.setItem("VR",!0)}else s.end()}}():(s(),e.textContent="VR NOT SUPPORTED"),i&&nt.xrSessionIsGranted&&e.click()})).catch((function(t){s(),console.warn("Exception when trying to call xr.isSessionSupported",t),e.textContent="VR NOT ALLOWED"})),e;{const t=document.createElement("a");return!1===window.isSecureContext?(t.href=document.location.href.replace(/^http:/,"https:"),t.innerHTML="WEBXR NEEDS HTTPS"):(t.href="https://immersiveweb.dev/",t.innerHTML="WEBXR NOT AVAILABLE"),t.style.left="calc(50% - 90px)",t.style.width="180px",t.style.textDecoration="none",i(t),t}}static registerSessionGrantedListener(){if("xr"in navigator){if(/WebXRViewer\//i.test(navigator.userAgent))return;navigator.xr.addEventListener("sessiongranted",(()=>{nt.xrSessionIsGranted=!0}))}}}nt.xrSessionIsGranted=!1,nt.registerSessionGrantedListener();var at=s(373),rt=s.n(at);class ot extends h{constructor(t,e,s){super(),this.SIZE_OF_TRAFFIC=10,this.timeSinceLastUpdate=Date.now(),this.trafficWorker=new Worker("./workers/TrafficWorker.js"),this.currentTraffic={},this.scene=t,this.physicsWorld=e,this.levelStreets=s,this.lastID=0,this.straightStreetIndex=0,this.straightStreets=this.levelStreets.filter((t=>"STRAIGHT"===t.type)),this.lastCarRotation=0,this.carOffset=0,this.trafficWorker.onmessage=t=>{this.onReceiveResponseFromWorker(t)}}async onReceiveResponseFromWorker(t){this.updateCarEngines(t.data)}async onCollideWithCarOfTraffic(){console.log("CHOCASTE AL AUTO")}getNextCarPos(){return 0!==this.lastCarRotation?(this.lastCarRotation=0,this.straightStreetIndex+=1,this.straightStreetIndex=this.straightStreetIndex%this.straightStreets.length,0===this.straightStreetIndex&&(this.carOffset+=10)):this.lastID>0&&(this.lastCarRotation=Math.PI),{pos_x_street:this.straightStreets[this.straightStreetIndex].position_x,pos_y_street:this.straightStreets[this.straightStreetIndex].position_y,isSide:this.straightStreets[this.straightStreetIndex].rotation>0,max_x_offset:this.straightStreets[this.straightStreetIndex].long_y,max_y_offset:this.straightStreets[this.straightStreetIndex].long_x,carOffset:this.carOffset,rotation:this.lastCarRotation}}async generateCar(){const t=this.getNextCarPos();let e=new Q(this.physicsWorld,[t.pos_x_street+(t.isSide?t.carOffset-t.max_x_offset/2:t.rotation>0?2.5:-2.5),2,t.pos_y_street+(t.isSide?t.rotation>0?-2.5:2.5:t.carOffset-t.max_y_offset/2)],!1,(new o.pb).setFromAxisAngle(new o.Jb(0,1,0),t.isSide?Math.PI/2+t.rotation:t.rotation));await e.carPhysics.buildAmmoPhysics();let s=new E;await s.addToScene(this.scene,`traffic_car_${this.lastID}`,!1);const i=s.threeDModel.children.filter((t=>"W222Body"===t.name))[0].children[0];return i.material=i.material.clone(),i.material.color.set(16777215*Math.random()),e.carPhysics.rigidBody.threeObject=s,e.carPhysics.rigidBody.onCollide=this.onCollideWithCarOfTraffic,e.attachObserver(s),e.notifyObservers(),this.currentTraffic[this.lastID]={object3D:s,engine:e},this.lastID+=1,s}deleteCar(t){this.currentTraffic[t].engine.removeObserver(this.currentTraffic[t].object3D),this.physicsWorld.removeRigidBody(this.currentTraffic[t].engine.carPhysics.rigidyBody),this.physicsWorld.removeCollisionObject(this.currentTraffic[t].engine.carPhysics.rigidyBody),this.scene.remove(this.currentTraffic[t].object3D.threeDModel),delete this.currentTraffic[t]}async generateInitialTraffic(){const t=[];for(let e=0;e<this.SIZE_OF_TRAFFIC;e++)t.push(await this.generateCar());return t}updateTraffic(){const t=[];if(Object.entries(this.currentTraffic).forEach((e=>{const[s,i]=e,n=i.engine.getDataToAnimate();n.carId=s;const a=new o.Jb(0,0,2.5).applyQuaternion(n.rotation);n.frontPosition=n.position.add(a),n.backPosition=n.position.sub(a),delete n.physicsBody,delete n.wheelsData,t.push(n)})),this.observedState){delete this.observedState.physicsBody,delete this.observedState.wheelsData;const t=new o.Jb(0,0,2.5).applyQuaternion(this.observedState.rotation);this.observedState.frontPosition=this.observedState.position.add(t),this.observedState.backPosition=this.observedState.position.sub(t)}this.trafficWorker.postMessage({playersCar:this.observedState,streets:this.levelStreets,trafficCars:t})}updateCarEngines(t){Object.keys(t).forEach((e=>{t[e].deleteCar?this.deleteCar(e):(this.currentTraffic[e].engine.turnOnCar(),this.currentTraffic[e].engine.turnDirection(t[e].steering),this.currentTraffic[e].engine.changeShift(0,1),this.currentTraffic[e].engine.accelerate(1,t[e].accelerate),this.currentTraffic[e].engine.brake(0,t[e].brake),this.currentTraffic[e].engine.update())}))}animate(){this.updateTraffic(),Object.values(this.currentTraffic).forEach((t=>{t.object3D.animate()}))}}var ht=s(14),lt=s(123),ct=s(578),dt=s(292);const ut=Object(i.createContext)(void 0),pt="https://backend-bata340.cloud.okteto.net",gt=/^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/;var bt=s(1);const St=t=>{let{endLevel:e,score:s,time:i,minScore:a,levelId:r,timeInMs:o}=t;const[h,l]=n.a.useState(e),c=Object(ht.n)(),{session:d}=n.a.useContext(ut);n.a.useEffect((()=>{l(e),e&&d.user&&(async()=>{try{const t=await fetch(`${pt}/user_progress/end_of_level`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:d.user.id,levelId:r,score:s,time:o})}),e=await t.json();if(200!==t.status){const s=e.detail[0].msg?e.detail[0].msg:e.detail;let i=t.status+" - "+t.statusText+" - "+s;throw new Error(i)}}catch(t){throw new Error(t)}})()}),[e]);return Object(bt.jsx)(lt.a,{open:h,children:Object(bt.jsxs)(ct.a,{className:"end_of_level_dialog",children:[a>s?Object(bt.jsxs)(bt.Fragment,{children:[Object(bt.jsx)("h1",{children:"Nivel Fallido"}),Object(bt.jsxs)("p",{style:{color:"red"},children:["El puntaje m\xednimo para pasar el nivel es de: ",a,", y tu puntaje fue de: ",s]})]}):Object(bt.jsxs)(bt.Fragment,{children:[Object(bt.jsx)("h1",{children:"\xa1Nivel Superado!"}),Object(bt.jsxs)("p",{style:{color:"green"},children:[Object(bt.jsx)("strong",{children:"Tu puntaje final es"}),": ",s]})]}),Object(bt.jsxs)("p",{children:[Object(bt.jsx)("strong",{children:"Tiempo transcurrido:"})," ",i]}),Object(bt.jsx)(dt.a,{onClick:()=>{window.location.reload()},children:"Reintentar"}),Object(bt.jsx)(dt.a,{onClick:()=>{c("/levels")},children:"Volver al menu"})]})})};var mt=s(298),wt=s(299),xt=s(369),ft=s(277),yt=s(573),vt=s(577),jt=s(211),Et=s(268),It=s(274),At=s(294),Rt=s(53),Ot=s(295),Tt=s(296);const Mt=[{value:0,label:"Desactivado",createMirrors:!1,true_value_aa:0,true_value_res:0},{value:1,label:"Baja",createMirrors:!0,true_value_res:.3,true_value_aa:0},{value:2,label:"Media",createMirrors:!0,true_value_res:.6,true_value_aa:2},{value:3,label:"Alta",createMirrors:!0,true_value_res:1,true_value_aa:4}],Pt=[{value:1,label:"Baja",true_value:.25},{value:2,label:"Media",true_value:.5},{value:3,label:"Alta",true_value:1}],_t=[{value:0,label:"X0.25",true_value:.25},{value:1,label:"X0.50",true_value:.5},{value:2,label:"X0.75",true_value:.75},{value:3,label:"X1",true_value:1}],Ct=t=>{let{pausedLevel:e,pause:s}=t;const[i,a]=n.a.useState(3),[r,o]=n.a.useState(3),[h,l]=n.a.useState(2),[c,d]=n.a.useState(100),[u,p]=n.a.useState(!0),[g,b]=n.a.useState("G29");return n.a.useEffect((()=>{const t=JSON.parse(localStorage.getItem("graphic_config")),e=localStorage.getItem("controller");a(t.indexEspejos),l(t.indexVR),o(t.indexRes),d(t.ViewDistance),p(t.lightsOn),b(e)}),[]),Object(bt.jsxs)(xt.a,{container:!0,direction:"row",justifyContent:"center",alignItems:"center",children:[Object(bt.jsxs)(xt.a,{xs:8,children:[Object(bt.jsx)(Et.a,{id:"controller-label",children:"Tipo de control"}),Object(bt.jsxs)(It.a,{labelId:"controller-label",id:"controller-select",value:g,label:"Tipo de control",onChange:t=>{console.log(t),b(t.target.value)},style:{width:"100%",boxSizing:"border-box"},children:[Object(bt.jsx)(At.a,{value:"XInput",children:"Control de Xbox"}),Object(bt.jsx)(At.a,{value:"G29",children:"Volante con palanca"})]})]}),Object(bt.jsxs)(xt.a,{item:!0,xs:8,children:[Object(bt.jsx)(Rt.a,{id:"input-slider",gutterBottom:!0,children:"Calidad Espejos"}),Object(bt.jsx)(jt.h,{defaultValue:3,marks:Mt,max:3,onChange:t=>{a(t.target.value)},value:i})]}),Object(bt.jsxs)(xt.a,{item:!0,xs:8,children:[Object(bt.jsx)(Rt.a,{id:"input-slider",gutterBottom:!0,children:"Resoluci\xf3n"}),Object(bt.jsx)(jt.h,{defaultValue:3,marks:Pt,max:3,min:1,onChange:t=>{o(t.target.value)},value:r})]}),Object(bt.jsxs)(xt.a,{item:!0,xs:8,children:[Object(bt.jsx)(Rt.a,{id:"input-slider",gutterBottom:!0,children:"Resoluci\xf3n Vr"}),Object(bt.jsx)(jt.h,{defaultValue:2,marks:_t,max:3,onChange:t=>{l(t.target.value)},value:h})]}),Object(bt.jsxs)(xt.a,{item:!0,xs:8,children:[Object(bt.jsx)(Rt.a,{id:"input-slider",gutterBottom:!0,children:"Distancia de visi\xf3n (metros)"}),Object(bt.jsx)(jt.h,{valueLabelDisplay:"auto",defaultValue:100,max:300,value:c,onChange:t=>{d(t.target.value)}})]}),Object(bt.jsx)(xt.a,{item:!0,xs:8,children:Object(bt.jsx)(Ot.a,{control:Object(bt.jsx)(Tt.a,{label:"",onChange:t=>{p(t.target.checked)},value:u}),label:"Activar luces vehiculos"})}),Object(bt.jsx)(xt.a,{item:!0,xs:8,md:4,style:{textAlign:"center"},children:Object(bt.jsx)(ct.a,{style:{textAlign:"center",margin:"auto"},children:Object(bt.jsx)(dt.a,{onClick:function(){const t=Mt.filter((t=>t.value===i))[0],e={VRResMultiplier:_t.filter((t=>t.value===h))[0].true_value,ResMultiplier:Pt.filter((t=>t.value===r))[0].true_value,AAEspejos:t.true_value_aa,MirrorResMultiplier:t.true_value_res,CreateMirrors:t.createMirrors,ViewDistance:c,lightsOn:u,indexEspejos:i,indexRes:r,indexVR:h};localStorage.setItem("graphic_config",JSON.stringify(e)),localStorage.setItem("controller",g),window.location.reload()},variant:"contained",color:"success",children:"Aplicar Cambios y Reiniciar"})})})]})},Lt=t=>{let{pausedLevel:e,pause:s}=t;const[i,a]=n.a.useState(e||!1),r=Object(ht.n)(),[o,h]=n.a.useState("joystick");n.a.useEffect((()=>{void 0!==e&&null!==e&&a(e)}),[e]);return Object(bt.jsx)(lt.a,{open:i,children:Object(bt.jsxs)(ct.a,{className:"pause_menu",children:[Object(bt.jsx)("h1",{children:"Pausa"}),Object(bt.jsxs)(ft.a,{value:o,variant:"fullWidth",scrollButtons:"auto",children:[Object(bt.jsx)(ct.a,{children:Object(bt.jsxs)(yt.a,{scrollButtons:"auto",variant:"fullWidth",onChange:(t,e)=>{h(e)},"aria-label":"pause-tabs",children:[Object(bt.jsx)(mt.a,{label:"C\xf3mo manejar con Joystick",value:"joystick",wrapped:!0}),Object(bt.jsx)(mt.a,{label:"C\xf3mo manejar con volante",value:"volante",wrapped:!0}),Object(bt.jsx)(mt.a,{label:"C\xf3nfiguraci\xf3n",value:"config",wrapped:!0})]})}),Object(bt.jsx)(vt.a,{value:"joystick",children:Object(bt.jsx)(wt.a,{component:"img",width:"100%",height:"100%",image:"/controlesJoystick.png",style:{borderRadius:20},sx:{objectFit:"contain",justifyContent:"center",display:"flex",maxHeight:"100%",maxWidth:"100%"}})}),Object(bt.jsx)(vt.a,{value:"volante",children:Object(bt.jsx)(wt.a,{component:"img",width:"100%",height:"100%",image:"/controlesVolante.png",style:{borderRadius:20},sx:{objectFit:"contain",justifyContent:"center",display:"flex",maxHeight:"100%",maxWidth:"100%"}})}),Object(bt.jsx)(vt.a,{value:"config",children:Object(bt.jsx)(Ct,{})})]}),Object(bt.jsxs)(xt.a,{container:!0,justifyContent:"space-around",alignItems:"center",rowSpacing:2,children:[Object(bt.jsx)(xt.a,{item:!0,xs:12,md:4,style:{textAlign:"center"},children:Object(bt.jsx)(ct.a,{style:{textAlign:"center",margin:"auto"},children:Object(bt.jsx)(dt.a,{onClick:()=>{r("/levels")},color:"error",variant:"contained",children:"Volver al menu"})})}),Object(bt.jsx)(xt.a,{item:!0,xs:12,md:4,style:{textAlign:"center"},children:Object(bt.jsx)(ct.a,{style:{textAlign:"center",margin:"auto"},children:Object(bt.jsx)(dt.a,{onClick:()=>{window.location.reload()},variant:"outlined",color:"error",children:"Reintentar"})})}),Object(bt.jsx)(xt.a,{item:!0,xs:12,md:4,style:{textAlign:"center"},children:Object(bt.jsx)(ct.a,{style:{textAlign:"center",margin:"auto"},children:Object(bt.jsx)(dt.a,{onClick:s,variant:"contained",children:"Seguir"})})})]})]})})};function Dt(){const{state:t}=Object(ht.l)(),{jsonLevel:e}=t;return Object(bt.jsx)(kt,{jsonLevel:e})}const Zt=t=>{const[e,s,i]=t.split(":");return 60*parseInt(e)*60*1e3+60*parseInt(s)*1e3+1e3*parseInt(i)};class kt extends i.Component{constructor(){super(),this.state={currentRPM:0,velocity:0,currentShift:0},this.physicsToUpdate=[],localStorage.setItem("VR",!1),this.gotAnyEvent=!1,this.stats=new rt.a,this.objectsToAnimate=[],this.scene=new o.tb,this.reducedScene=new o.tb,this.renderer=new o.Nb({alpha:!0,powerPreference:"high-performance",antialias:!0}),this.renderer.shadowMap.enabled=!0,this.clock=new o.i,this.finishedLevel=!1,this.levelPaused=!1,this.score=0,this.time=0,this.initializedReducedScene=!1,this.checkpointUpdate=!1}updateCheckpoint(){this.checkpointUpdate=!0}async componentDidMount(){this.jsonLevel=this.props.jsonLevel,this.generateGeneralElements=this.generateGeneralElements.bind(this),this.animation=this.animation.bind(this),this.handleWindowResize=this.handleWindowResize.bind(this),this.generateEvents=this.generateEvents.bind(this),this.addPlayerCar=this.addPlayerCar.bind(this),this.generateLevel=this.generateLevel.bind(this),this.addVR=this.addVR.bind(this),this.endLevel=this.endLevel.bind(this),this.pauseLevel=this.pauseLevel.bind(this),this.updateCheckpoint=this.updateCheckpoint.bind(this),await this.generateGeneralElements(),await this.createAmmo(),await this.addGeneralLights(),await this.generateLevel(),await this.addPlayerCar(),this.jsonLevel.has_traffic&&await this.createTraffic(),this.generateEvents(),await this.addVR();const t=JSON.parse(localStorage.getItem("graphic_config")).ResMultiplier;this.renderer.setPixelRatio(window.devicePixelRatio*t),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setAnimationLoop(this.animation)}componentWillUnmount(){this.renderer.setAnimationLoop(null),delete this.scene,delete this.objectsToAnimate,delete this.physicsToUpdate,delete this.physicsWorld,this.stats.dom.remove(),delete this.stats,delete this.level,delete this.carLogic,delete this.carModel,delete this.trafficModel,delete this.jsonLevel,delete this.camera,document.getElementById("VRButton").remove(),delete this.renderer}async addVR(){this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.xr.enabled=!0;const t=JSON.parse(localStorage.getItem("graphic_config")).VRResMultiplier;this.renderer.xr.setFramebufferScaleFactor(t),this.mount.appendChild(this.renderer.domElement),document.body.appendChild(nt.createButton(this.renderer))}async onReceiveResponseFromSceneWorker(t){this.initializedReducedScene=!0,this.reducedScene.children=t.data}async generateLevel(){this.level=new it(this.scene,this.physicsWorld,this.endLevel,this.updateCheckpoint);let t=await this.level.createLevelCustom(this.jsonLevel);this.objectsToAnimate=[...this.objectsToAnimate,...t.objectsToAnimate],this.physicsToUpdate=[...this.physicsToUpdate,...t.physicsToUpdate];const e=new o.e(1e4,1e4),s=(new o.Cb).load("./textures/pasto.jpeg");s.repeat.set(500,500),s.wrapS=o.rb,s.wrapT=o.rb;const i=new o.U({map:s}),n=new o.T(e,i);n.name="GREEN_FIELD",n.position.set(0,-1,0),n.rotateOnAxis(new o.Jb(1,0,0),Math.PI/2),this.scene.add(n)}async generateGeneralElements(){this.renderer.setClearColor(8900346,1),this.camera=new l(this.renderer),this.camera.addContainerToScene(this.scene),this.stats.showPanel(0),document.body.appendChild(this.stats.dom),localStorage.getItem("graphic_config")||localStorage.setItem("graphic_config",JSON.stringify({VRResMultiplier:.75,ResMultiplier:1,AAEspejos:4,MirrorResMultiplier:1,CreateMirrors:!0,ViewDistance:100,lightsOn:!0,indexEspejos:3,indexRes:3,indexVR:2})),localStorage.getItem("controller")||localStorage.setItem("controller","G29")}async addGeneralLights(){const t=new o.a(16777215,.5);t.name="AmbientLight",this.scene.add(t)}async addPlayerCar(){this.carLogic=new Q(this.physicsWorld,[this.jsonLevel.initial_position[0],1,this.jsonLevel.initial_position[1]],!0,(new o.pb).setFromAxisAngle(new o.Jb(0,1,0),this.jsonLevel.initial_rotation)),await this.carLogic.carPhysics.buildAmmoPhysics();let t=new E(!1);"XInput"===localStorage.getItem("controller")?this.carLogic.changeShiftBox("semi-auto"):this.carLogic.changeShiftBox("manual"),this.carLogic.carPhysics.rigidBody.threeObject=t,this.carLogic.attachObserver(t),this.carLogic.attachObserver(this.camera),this.objectsToAnimate.push(await t.addToScene(this.scene)),this.carLogic.notifyObservers()}async createTraffic(){this.trafficModel=new ot(this.scene,this.physicsWorld,this.jsonLevel.streets),this.carLogic.attachObserver(this.trafficModel),await this.trafficModel.generateInitialTraffic()}generateEvents(){window.addEventListener("resize",this.handleWindowResize),window.addEventListener("gamepaddisconnected",(function(t){R.removeInstance()})),document.addEventListener("keydown",(t=>{var e=t.key;switch(!isNaN(e)&&parseInt(e)>=1&&parseInt(e)<=5&&this.carLogic.removeObserver(this.camera),e){case"1":this.camera=new l(this.renderer),this.camera.addContainerToScene(this.reducedScene),this.camera.addContainerToScene(this.scene);break;case"2":this.camera=new u(this.renderer);break;case"3":this.camera=new c(new o.Jb(-4.35,.6,-.1));break;case"4":this.camera=new c(new o.Jb(4.35,.6,-.1));break;case"5":this.camera=new c(new o.Jb(0,3,-5));break;case"Escape":this.pauseLevel()}!isNaN(e)&&parseInt(e)>=1&&parseInt(e)<=5&&(this.carLogic.attachObserver(this.camera),this.carLogic.notifyObservers())}),!1)}async createAmmo(){let t=await L.getInstance();this.tempTransform=new t.btTransform;let e=new t.btDefaultCollisionConfiguration,s=new t.btCollisionDispatcher(e),i=new t.btDbvtBroadphase,n=new t.btSequentialImpulseConstraintSolver;this.physicsWorld=new t.btDiscreteDynamicsWorld(s,i,n,e),this.physicsWorld.setGravity(new t.btVector3(0,-9.8,0));const a=t.addFunction((async(t,e,s)=>{let i=await L.getInstance();if(e=i.castObject(i.wrapPointer(e,i.btRigidBody),i.btRigidBody),s=i.castObject(i.wrapPointer(s,i.btRigidBody),i.btRigidBody),e.threeObject&&s.threeObject&&("driverCar"===e.threeObject.threeDModel.name||"driverCar"===s.threeObject.threeDModel.name)){if(0===(t=i.wrapPointer(t,i.btManifoldPoint)).get_m_userPersistentData()){e.onCollide?e.onCollide():s.onCollide();const i=1;t.set_m_userPersistentData(i)}}}));this.physicsWorld.setContactProcessedCallback(a)}handleWindowResize(){this.camera.handleResize(),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.render(this.scene,this.camera.getCameraInstance())}vecDistance(t,e){return t.distanceTo(e)}getMaxSizeStreets(){let t=0,e=0;for(let s=0;s<this.jsonLevel.streets.length;s++){const i=this.jsonLevel.streets[s];t<i.position_x+i.long_x/2&&(t=i.position_x+i.long_x/2),e<i.position_y+i.long_y/2&&(e=i.position_y+i.long_y/2)}return[t,e]}async getReducedScene(t){const e=JSON.parse(localStorage.getItem("graphic_config")).ViewDistance,s=this.scene.children.filter((s=>"GREEN_FIELD"===s.name||"AmbientLight"===s.name||"driverCar"===s.name||this.vecDistance(s.position,t)<=e||s.LONG&&this.vecDistance(s.position,t)<=e+s.LONG));this.reducedScene.children=s,this.initializedReducedScene=!0}animation(){if(this.stats.begin(),!this.levelPaused){let t=this.clock.getDelta();this.physicsWorld.stepSimulation(t,10),this.jsonLevel.has_traffic&&this.trafficModel.animate(),this.objectsToAnimate.forEach((function(t){t.animate()})),this.physicsToUpdate.forEach((function(t){t.updatePhysics()})),this.camera.setPositionRelativeToObject(),"XInput"===localStorage.getItem("controller")?M.getInstance(this.carLogic,this.camera,this.pauseLevel).checkEvents():R.getInstance(this.carLogic,this.camera,this.pauseLevel).checkEvents(),this.setState({...this.state,velocity:this.carLogic.getSpeed(),currentRPM:this.carLogic.getCurrentRPM(),currentShift:this.carLogic.getCurrentShift(),score:this.level.getScore(),time:this.level.getTime()});const e=this.carLogic.getDataToAnimate().position;(!this.lastPlayerPos||this.checkpointUpdate||this.vecDistance(this.lastPlayerPos,e)>=30)&&(this.lastPlayerPos=e,this.checkpointUpdate=!1,this.getReducedScene(this.lastPlayerPos)),this.initializedReducedScene?this.renderer.render(this.reducedScene,this.camera.getCameraInstance()):this.renderer.render(this.scene,this.camera.getCameraInstance())}this.stats.end()}endLevel(t,e){this.finishedLevel=!0,this.score=t,this.time=e,this.setState({...this.state,endScore:t,endTime:e,finishedLevel:!0})}pauseLevel(){const t=!this.levelPaused;this.levelPaused=t,this.setState({...this.state,paused:t})}render(){return Object(bt.jsxs)("div",{style:{width:"100vw"},children:[Object(bt.jsxs)("div",{style:{position:"absolute",top:"10px",right:"10px",color:"red",width:"175px"},id:"Acelerador",children:[Object(bt.jsxs)("p",{style:{zIndex:20,display:"float",fontWeight:"bold"},children:["Cambio Actual: ",parseInt(this.state.currentShift)]}),Object(bt.jsxs)("p",{style:{zIndex:20,display:"float",fontWeight:"bold"},children:["Puntaje Actual: ",this.state.score]}),Object(bt.jsxs)("p",{style:{zIndex:20,display:"float",fontWeight:"bold"},children:["Tiempo Actual: ",this.state.time]})]}),Object(bt.jsx)("div",{ref:t=>{this.mount=t}}),Object(bt.jsx)(St,{endLevel:this.state.finishedLevel?this.state.finishedLevel:this.finishedLevel,score:this.state.endScore,time:this.state.endTime,minScore:this.jsonLevel?this.jsonLevel.minimum_to_win:0,levelId:this.jsonLevel?this.jsonLevel.id:void 0,timeInMs:this.state.endTime?Zt(this.state.endTime):0}),Object(bt.jsx)(Lt,{pausedLevel:this.state.paused,pause:this.pauseLevel})]})}}s(239);const Ut={width:"100vw",height:"100vh",backgroundImage:'url("DrivingSimMenuNoTitle.png")',backgroundSize:"cover",backgroundRepeat:"no-repeat",backgroundColor:"#B1E6F2"},Bt=()=>{const t=Object(ht.n)();return Object(bt.jsx)(bt.Fragment,{children:Object(bt.jsx)("div",{style:Ut,children:Object(bt.jsxs)(xt.a,{container:!0,rowSpacing:2,justifyContent:"center",alignItems:"center",flexDirection:"column",className:"containerMainMenu",children:[Object(bt.jsx)(xt.a,{item:!0,xs:12,className:"MainMenuTitle",children:Object(bt.jsxs)("h1",{className:"titleMainMenu",children:["Driving",Object(bt.jsx)("br",{}),"Simulator"]})}),Object(bt.jsx)(xt.a,{item:!0,xs:12,className:"buttonWrapperMainMenu",children:Object(bt.jsx)("button",{className:"buttonMainMenu",onClick:()=>t("/levels"),children:"Iniciar"})}),Object(bt.jsx)(xt.a,{item:!0,xs:12,className:"buttonWrapperMainMenu",children:Object(bt.jsx)("button",{className:"buttonMainMenu",onClick:()=>t("/level-editor"),children:"Editor de Niveles"})})]})})})};var Wt=s(301),Jt=s(4),Ht=s(52),Nt=s(300),Gt=s(380),Qt=s.n(Gt);const zt=t=>{let{openConfigs:e,handleDrawerClose:s}=t;const[i,a]=n.a.useState(!1);n.a.useEffect((()=>{a(e)}),[e]);const r=Object(Jt.a)("div")((t=>{let{theme:e}=t;return{display:"flex",alignItems:"center",width:"100%",padding:e.spacing(0,1),...e.mixins.toolbar,justifyContent:"flex-start"}}));return Object(bt.jsx)(bt.Fragment,{children:Object(bt.jsx)(xt.a,{children:Object(bt.jsxs)(Ht.a,{sx:{width:window.innerWidth/6,flexShrink:0,"& .MuiDrawer-paper":{width:window.innerWidth/6,boxSizing:"border-box"}},variant:"persistent",anchor:"right",open:i,children:[Object(bt.jsxs)(r,{className:"drawer-header",onClick:s,children:[Object(bt.jsx)(Qt.a,{}),Object(bt.jsx)("div",{style:{width:"100%"},children:Object(bt.jsx)("h3",{style:{textAlign:"right",paddingRight:30},children:"Configurations"})})]}),Object(bt.jsx)(Nt.a,{})]})})})};var Vt=s(381),Ft=s.n(Vt);const Xt=Object(i.createContext)(),Kt={cone:null,trapecio:null,street:null},qt=t=>{let{openItems:e,handleDrawerClose:s}=t;const[i,a]=n.a.useState(!1),{setLastSelectedItem:r,lastSelectedItem:o}=n.a.useContext(Xt);n.a.useEffect((()=>{a(e)}),[e]);const h=Object(Jt.a)("div")((t=>{let{theme:e}=t;return{display:"flex",alignItems:"center",padding:e.spacing(0,1),...e.mixins.toolbar,justifyContent:"flex-end"}})),[l,c]=n.a.useState(Kt);return Object(bt.jsx)(bt.Fragment,{children:Object(bt.jsx)(xt.a,{children:Object(bt.jsxs)(Ht.a,{sx:{width:window.innerWidth/6,flexShrink:0,"& .MuiDrawer-paper":{width:window.innerWidth/6,boxSizing:"border-box"}},variant:"persistent",anchor:"left",open:i,children:[Object(bt.jsxs)(h,{onClick:s,className:"drawer-header",children:[Object(bt.jsx)("div",{style:{width:"100%"},children:Object(bt.jsx)("h3",{style:{textAlign:"left",paddingLeft:10},children:"Items"})}),Object(bt.jsx)(Ft.a,{})]}),Object(bt.jsx)(Nt.a,{}),Object(bt.jsx)(xt.a,{style:{justifyContent:"center",display:"flex",alignItems:"center",flexDirection:"column"},children:Object.entries(l).map((t=>{let[e,s]=t;return Object(bt.jsx)("img",{alt:`${e}`,src:`${e}.png`,width:75,height:75,className:`imageLevelEditor ${s}`,onClick:()=>(t=>{const e={...Kt};e[t]="selected",c(e),r({selectedItem:t,scale:1,positionX:0,positionY:0,zIndex:o?o.zIndex+1:1})})(e)},e)}))})]})})})};var Yt=s(384),$t=s.n(Yt),te=s(383),ee=s.n(te);const se=t=>{let{setGridDimensions:e,gridDimensions:s}=t;const[n,a]=Object(i.useState)(s.width),[r,o]=Object(i.useState)(s.height);return Object(bt.jsxs)(xt.a,{container:!0,direction:"row",width:"80%",marginLeft:"10%",justifyContent:"space-evenly",alignItems:"center",spacing:2,children:[Object(bt.jsxs)(xt.a,{item:!0,xs:2,children:[Object(bt.jsx)("p",{children:"Ancho:"}),Object(bt.jsx)("input",{value:n,type:"number",step:"1",onChange:t=>{let e=parseInt(t.target.value.replaceAll(",","").replaceAll(".",""));a(e>40?40:e)}})]}),Object(bt.jsx)(xt.a,{item:!0,xs:2,children:Object(bt.jsxs)("div",{children:[Object(bt.jsx)("p",{children:"Alto:"}),Object(bt.jsx)("input",{value:r,type:"number",step:"1",onChange:t=>{let e=parseInt(t.target.value.replaceAll(",","").replaceAll(".",""));o(e>40?40:e)}})]})}),Object(bt.jsx)(xt.a,{item:!0,xs:2,children:Object(bt.jsx)(dt.a,{variant:"contained",onClick:()=>{e({width:n,height:r})},children:"Actualizar"})})]})};var ie=s(382),ne=s.n(ie);const ae=30;class re{constructor(t,e,s){const i=t[1][2].filled,n=t[0][1].filled,a=t[2][1].filled,r=t[1][0].filled;this.rotation=this.determineStreetRotation(n,r,a,i),this.long=[ae,ae],this.position=[e*ae+15,s*ae+15]}static isValidNinePerNineGrid(t){}static sumValueForCell(t){return t.filled?1:0}static calculateNeighboursFilled(t){let e=0,s=0;return e+=re.sumValueForCell(t[1][0])+re.sumValueForCell(t[1][2]),s+=re.sumValueForCell(t[0][1])+re.sumValueForCell(t[2][1]),[e,s]}isStraight(){return!1}determineStreetRotation(){}getAsJSON(){return{position_x:this.position[0],position_y:this.position[1],rotation:this.rotation,long_x:this.long[0],long_y:this.long[1]}}getPositionAsRowAndColumn(){return[(this.position[0]-15)/ae,(this.position[1]-15)/ae]}getPositionX(){return this.position[0]}getPositionY(){return this.position[1]}getLongX(){return this.long[0]}getLongY(){return this.long[1]}}const oe={TOP_TO_LEFT:3*Math.PI/2,LEFT_TO_BOT:0,BOT_TO_RIGHT:Math.PI/2,RIGHT_TO_TOP:Math.PI};const he={HORIZONTAL:0,VERTICAL:Math.PI/2};const le={TOP_SINGLE:Math.PI,LEFT_SINGLE:3*Math.PI/2,BOT_SINGLE:0,RIGHT_SINGLE:Math.PI/2};class ce{constructor(t){this.sections=this.segregateSections(t),this.sectionsAsJSON=this.linkSections()}segregateSections(t){const e={},s={};let i=[];for(let n=0;n<t.length;n++){let[i,a]=t[n].getPositionAsRowAndColumn();t[n].isHorizontal()?(i in e||(e[i]=[]),e[i].push({idx:a,street:t[n]})):(a in s||(s[a]=[]),s[a].push({idx:i,street:t[n]}))}for(const[,n]of Object.entries(e))i=[...i,...this.generateArraySubsections(n)];for(const[,n]of Object.entries(s))i=[...i,...this.generateArraySubsections(n)];return i}generateArraySubsections(t){const e=[];for(let s=0;s<t.length;s++)0===s||Math.abs(t[s].idx-t[s-1].idx)>1?e.push([t[s].street]):e[e.length-1].push(t[s].street);return e}linkSections(){const t=[];for(let e=0;e<this.sections.length;e++){const s={position_x:this.sections[e].reduce(((t,e)=>t+e.getPositionX()),0)/this.sections[e].length,position_y:this.sections[e].reduce(((t,e)=>t+e.getPositionY()),0)/this.sections[e].length,rotation:this.sections[e][0].rotation,long_x:this.sections[e][0].isHorizontal()?this.sections[e].reduce(((t,e)=>t+e.getLongX()),0):this.sections[e][0].getLongX(),long_y:this.sections[e][0].isHorizontal()?this.sections[e][0].getLongY():this.sections[e].reduce(((t,e)=>t+e.getLongY()),0),type:"STRAIGHT"};t.push(s)}return t}getSectionsAsJSON(){return this.sectionsAsJSON}}const de=[class extends re{static isValidNinePerNineGrid(t){let[e,s]=re.calculateNeighboursFilled(t);return 2===s&&0===e||0===s&&2===e}determineStreetRotation(t,e,s,i){return t&&s?he.VERTICAL:e&&i?he.HORIZONTAL:void 0}isStraight(){return!0}getAsJSON(){let t=super.getAsJSON();return t.type="STRAIGHT",t}isHorizontal(){return this.rotation===he.HORIZONTAL}},class extends re{static isValidNinePerNineGrid(t){let[e,s]=re.calculateNeighboursFilled(t);return 1===e&&1===s}determineStreetRotation(t,e,s,i){return t&&e?oe.TOP_TO_LEFT:e&&s?oe.LEFT_TO_BOT:s&&i?oe.BOT_TO_RIGHT:i&&t?oe.RIGHT_TO_TOP:void 0}getAsJSON(){let t=super.getAsJSON();return t.type="CURVE",t}},class extends re{static isValidNinePerNineGrid(t){let[e,s]=re.calculateNeighboursFilled(t);return 2===s&&1===e||1===s&&2===e}determineStreetRotation(t,e,s,i){return t&&e&&i?le.TOP_SINGLE:e&&s&&t?le.LEFT_SINGLE:s&&i&&e?le.BOT_SINGLE:i&&t&&s?le.RIGHT_SINGLE:void 0}getAsJSON(){let t=super.getAsJSON();return t.type="T_STREET",t}},class extends re{static isValidNinePerNineGrid(t){let[e,s]=re.calculateNeighboursFilled(t);return 2===s&&2===e}determineStreetRotation(){return 0}getAsJSON(){let t=super.getAsJSON();return t.type="INTERSECTION",t}}];class ue{constructor(t,e){this.levelGrid=t,this.getNinePerNineGrid=e?this.getNinePerNineGridInfinite:this.getNinePerNineGridFinite}constructStreets(){const t=[],e=[];for(let i=0;i<this.levelGrid.length;i++)for(let s=0;s<this.levelGrid[i].length;s++){if(this.levelGrid[i][s].filled){const n=this.defineTypeOfStreet(i,s);n.isStraight()?t.push(n):e.push(n)}}const s=this.linkStraightStreets(t);return[...e.map((t=>t.getAsJSON())),...s]}getNinePerNineGridInfinite(t,e){const s=[];for(let i=t-1;i<=t+1;i++){const t=[],n=i<0?this.levelGrid.length-1:i%this.levelGrid.length;for(let s=e-1;s<=e+1;s++){const e=s<0?this.levelGrid[n].length-1:s%this.levelGrid[n].length;t.push(this.levelGrid[n][e])}s.push(t)}return s}getNinePerNineGridFinite(t,e){const s=[],i={filled:!1};for(let n=t-1;n<=t+1;n++)if(n<0||n===this.levelGrid.length)s.push([i,i,i]);else{const t=[];for(let s=e-1;s<=e+1;s++)s<0||s===this.levelGrid[n].length?t.push(i):t.push(this.levelGrid[n][s]);s.push(t)}return s}defineTypeOfStreet(t,e){const s=this.getNinePerNineGrid(t,e);let i,n=!1;for(let a=0;a<de.length&&!n;a++)n=de[a].isValidNinePerNineGrid(s),i=de[a];if(!n)throw new Error("No se pudo definir el tipo de calle dentro de los tipos validos.");return new i(s,this.levelGrid.length-1-t,e)}linkStraightStreets(t){return new ce(t).getSectionsAsJSON()}}function pe(t,e,s){let i=0;for(let n=e-1;n<=e+1&&n<t.length;n++)n>=0&&n!==e&&(i+=t[n][s].filled?1:0);for(let n=s-1;n<=s+1&&n<t[e].length;n++)n>=0&&n!==s&&(i+=t[e][n].filled?1:0);return i}function ge(t,e){return e?void 0:function(t){let e=!0,s=[];for(let i=0;i<t.length;i++)for(let n=0;n<t[i].length;n++)t[i][n].filled&&pe(t,i,n)<=1&&(e=!1,s.push([i,n]));return{valid:e,wrongCells:s}}(t)}const be="darkgray",Se="white",me="orange",we=t=>{let{gridDimensions:e}=t;const[s,n]=Object(i.useState)([]),[a,r]=Object(i.useState)(!1),[o,h]=Object(i.useState)(!1);Object(i.useEffect)((()=>{let t=[];for(let s=0;s<e.height;s++){let s=[];for(let t=0;t<e.width;t++){let t={filled:!1,div_color:Se};s.push(t)}t.push(s)}n(t)}),[e.width,e.height]),Object(i.useEffect)((()=>{window.addEventListener("mouseup",(t=>{t.preventDefault(),0===t.button?r(!1):2===t.button&&h(!1)})),window.addEventListener("contextmenu",(t=>{t.preventDefault()}))}),[]);const l=(t,e)=>{if(!e||!t)return!1;for(let i=0;i<t.length;i++){let n=!0;for(let a=0;a<t[i].length;a++)try{t[i][a]!==e[a]&&(n=!1)}catch(s){a=t[i].length,n=!1}if(n)return!0}return!1};return Object(bt.jsxs)("div",{style:{width:600,height:600,marginTop:25,marginLeft:"auto",marginRight:"auto"},onMouseDown:t=>{t.preventDefault(),0===t.button?r(!0):2===t.button&&h(!0)},children:[s.map(((t,i)=>Object(bt.jsx)("div",{className:"row-level-grid",id:`row_${i}`,style:{width:"100%",height:600/e.height,display:"flex",flexDirection:"row"},children:t.map(((t,r)=>Object(bt.jsx)("div",{className:"cell-level-grid",id:`cell_${i}_${r}`,style:{backgroundColor:t.div_color,width:100/e.width+"%",height:"100%",border:"1px solid black"},onMouseMove:t=>{t.preventDefault(),((t,e)=>{if(a){const i=[...s];i[t][e].filled=!0,i[t][e].div_color=be,n(i)}else if(o){const i=[...s];i[t][e].filled=!1,i[t][e].div_color=Se,n(i)}})(i,r)},onMouseUp:t=>{((t,e,i)=>{if(0===i){const i=[...s];i[t][e].filled=!0,i[t][e].div_color=be,n(i)}else if(2===i){const i=[...s];i[t][e].filled=!1,i[t][e].div_color=Se,n(i)}})(i,r,t.button)}},`cell_${i}_${r}`)))},`row_${i}`))),Object(bt.jsx)("div",{style:{display:"flex",justifyContent:"center",marginTop:40},children:Object(bt.jsxs)(dt.a,{variant:"contained",onClick:()=>{let t=ge(s),e=[...s];for(let i=0;i<s.length;i++)for(let n=0;n<s[i].length;n++)e[i][n].filled&&(e[i][n].div_color=l(t.wrongCells,[i,n])?me:be);n(e),t.valid&&function(t,e){var s="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(t)),i=document.createElement("a");i.setAttribute("href",s),i.setAttribute("download",e+".json"),document.body.appendChild(i),i.click(),i.remove()}(function(t){return{streets:new ue(t).constructStreets()}}(s),"Driving_Simulator_Custom_Level.json")},color:"success",children:[Object(bt.jsx)(ne.a,{})," Procesar nivel..."]})})]})},xe=()=>{const[t,e]=Object(i.useState)(!1),[s,a]=Object(i.useState)(!1),[r,o]=Object(i.useState)([]),[h,l]=Object(i.useState)(null),[c,d]=Object(i.useState)({width:20,height:20});return n.a.useEffect((()=>{null!==h&&o((t=>[...t,h]))}),[h]),Object(bt.jsx)(bt.Fragment,{children:Object(bt.jsxs)(Xt.Provider,{value:{lastSelectedItem:h,setLastSelectedItem:l},children:[Object(bt.jsxs)("div",{style:{backgroundColor:"#B1E6F2",minHeight:"100vh"},children:[Object(bt.jsxs)("div",{style:{flexDirection:"row",justifyContent:"space-between",display:"flex"},children:[Object(bt.jsx)(Wt.a,{onClick:()=>e(!0),style:{height:40,margin:10},className:"header",children:Object(bt.jsx)(ee.a,{})}),Object(bt.jsx)("h1",{children:"Driving Simulator - Level Editor"}),Object(bt.jsx)(Wt.a,{onClick:()=>a(!0),style:{height:40,margin:10},className:"header",children:Object(bt.jsx)($t.a,{})})]}),Object(bt.jsxs)("div",{children:[Object(bt.jsx)(se,{setGridDimensions:d,gridDimensions:c}),Object(bt.jsx)(we,{gridDimensions:c}),r.map(((t,e)=>Object(bt.jsx)("span",{},e)))]})]}),Object(bt.jsx)(qt,{openItems:t,handleDrawerClose:()=>{e(!1)}}),Object(bt.jsx)(zt,{openConfigs:s,handleDrawerClose:()=>{a(!1)}})]})})};var fe=s(98);var ye=s(354),ve=s(355),je=s(356),Ee=s(357),Ie=s(358),Ae=s(368),Re=s(359),Oe=s(360),Te=s(361),Me=s(221),Pe=s(574),_e=s(575);const{createHash:Ce}=s(423),Le=t=>Ce("sha256").update(t).digest("hex"),De=t=>{let{setLogin:e,setOpenDialog:s}=t;const[a,r]=n.a.useState(""),[o,h]=n.a.useState(""),[l,c]=n.a.useState(!1),[d,u]=n.a.useState(void 0),{setSessionWithResponse:p}=(()=>{const{session:t,setSession:e}=Object(i.useContext)(ut);return{setSessionWithResponse:t=>{localStorage.setItem("session",JSON.stringify({user:t.user,exp:t.exp,jwt:t.jwt})),e({user:t.user,exp:t.exp,jwt:t.jwt})},getUser:()=>t.user?t.user:void 0,getJWT:()=>t.jwt?t.jwt:void 0}})(),[g,b]=n.a.useState(!1),[S,m]=n.a.useState(""),w=async t=>{try{const e=await(async t=>{const e=await fetch(`${pt}/users/login_google`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:t})});if(200!==e.status){const t=await e.json(),s=t.detail[0].msg?t.detail[0].msg:t.detail;let i=e.status+" - "+e.statusText+" - "+s;throw new Error(i)}return e.json()})(t);p(e),m("Sesi\xf3n iniciada correctamente.")}catch(e){u([e.toString().replaceAll("Error: ","")])}},x=()=>{m(""),s(!1)};return Object(bt.jsxs)(bt.Fragment,{children:[Object(bt.jsxs)(ye.a,{onClose:x,open:""!==S,children:[Object(bt.jsx)(ve.a,{children:"Inicio de sesi\xf3n"}),Object(bt.jsx)(je.a,{children:Object(bt.jsx)(Ee.a,{children:S})}),Object(bt.jsx)(Ie.a,{children:Object(bt.jsx)(dt.a,{onClick:x,autoFocus:!0,children:"Aceptar"})})]}),Object(bt.jsx)("form",{onSubmit:async t=>{if(t.preventDefault(),(()=>{const t=[];return""===o&&t.push("El campo contrase\xf1a se encuentra vac\xedo."),""===a&&t.push("El campo email se encuentra vac\xedo"),a.match(gt)||t.push("El email establecido es inv\xe1lido."),!(t.length>0)||(u(t),!1)})())try{const t=await(async()=>{try{b(!0);const t=await fetch(`${pt}/users/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:a,password:Le(o)})});if(200!==t.status){const e=await t.json();b(!1);const s=e.detail[0].msg?e.detail[0].msg:e.detail;let i=t.status+" - "+t.statusText+" - "+s;throw new Error(i)}return b(!1),t.json()}catch(t){throw b(!1),new Error(t)}})();p(t),m("Sesi\xf3n iniciada correctamente.")}catch(e){u([e.toString().replaceAll("Error: ","")])}},children:Object(bt.jsxs)("div",{style:{display:"flex",justifyContent:"center",alignContent:"center",flexDirection:"column",textAlign:"center",margin:"auto"},children:[d&&Object(bt.jsxs)(Ae.a,{severity:"error",style:{textAlign:"justify"},onClose:()=>u(void 0),children:["Han ocurrido los siguientes errores:",Object(bt.jsx)("ul",{children:d&&d.map(((t,e)=>Object(bt.jsx)("li",{children:t},e)))})]}),Object(bt.jsx)("h1",{sx:{position:"absolute",top:0},children:"Iniciar Sesi\xf3n"}),Object(bt.jsx)("div",{style:{marginTop:20},children:Object(bt.jsx)(Re.a,{style:{width:"80%"},type:"text",onChange:t=>r(t.target.value),value:a,name:"email",label:"E-Mail"})}),Object(bt.jsx)("div",{style:{marginTop:20},children:Object(bt.jsx)(Re.a,{style:{width:"80%"},type:l?"text":"password",onChange:t=>h(t.target.value),value:o,name:"password",label:"Contrase\xf1a",InputProps:{endAdornment:Object(bt.jsx)(Oe.a,{position:"end",children:Object(bt.jsx)(Wt.a,{"aria-label":"toggle password visibility",onClick:()=>c(!l),children:l?Object(bt.jsx)(Pe.a,{}):Object(bt.jsx)(_e.a,{})})})}})}),Object(bt.jsx)("div",{style:{marginTop:20},children:g?Object(bt.jsx)(Te.a,{}):Object(bt.jsx)(dt.a,{variant:"contained",type:"submit",children:"Iniciar Sesi\xf3n"})}),Object(bt.jsx)("div",{style:{marginTop:20},children:Object(bt.jsx)("p",{className:"p_button",onClick:()=>{e(!1)},children:"\xbfNo posees una cuenta? Registrate aqu\xed..."})}),Object(bt.jsx)("div",{style:{marginTop:20,display:"flex",justifyContent:"center",textAlign:"center",alignContent:"center"},children:Object(bt.jsx)(Me.a,{onSuccess:t=>{const e=t.credential;w(e)},onError:()=>{u(["El inicio de sesi\xf3n con Google ha fallado."])}})})]})})]})},Ze=t=>{let{setLogin:e,setOpenDialog:s}=t;const[i,a]=n.a.useState(""),[r,o]=n.a.useState(""),[h,l]=n.a.useState(""),[c,d]=n.a.useState(""),[u,p]=n.a.useState(!1),[g,b]=n.a.useState(void 0),[S,m]=n.a.useState(""),[w,x]=n.a.useState(!1),f=()=>{m(""),s(!1)};return Object(bt.jsxs)(bt.Fragment,{children:[Object(bt.jsxs)(ye.a,{onClose:f,open:""!==S,children:[Object(bt.jsx)(ve.a,{children:"Creaci\xf3n de usuario"}),Object(bt.jsx)(je.a,{children:Object(bt.jsx)(Ee.a,{children:S})}),Object(bt.jsx)(Ie.a,{children:Object(bt.jsx)(dt.a,{onClick:f,autoFocus:!0,children:"Aceptar"})})]}),Object(bt.jsx)("form",{onSubmit:async t=>{if(t.preventDefault(),!(()=>{const t=[];return""!==i&&""!==r&&""!==h&&""!==c||t.push("A\xfan existen campos sin completar."),r!==h&&t.push("Las contrase\xf1as establecidas no coinciden."),r.length<8&&t.push("La contrase\xf1a debe tener una longitud m\xednima de 8 caracteres."),i.match(gt)||t.push("El email establecido es inv\xe1lido."),t.length>0?(b(t),!1):(b(void 0),!0)})())return;await(async()=>{x(!0);const t=`${pt}/users/register`;try{const e=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:i,password:Le(r),name_to_show:c})});if(200!==e.status){const t=await e.json();x(!1);const s=t.detail[0].msg?t.detail[0].msg:t.detail;let i=e.status+" - "+e.statusText+" - "+s;throw new Error(i)}return x(!1),e.json()}catch(e){throw x(!1),new Error(e)}})();m("Su usuario ha sido creado exitosamente.")},children:Object(bt.jsxs)("div",{style:{display:"flex",justifyContent:"center",alignContent:"center",flexDirection:"column",textAlign:"center",margin:"auto"},children:[g&&Object(bt.jsxs)(Ae.a,{severity:"error",style:{textAlign:"justify"},onClose:()=>b(void 0),children:["Han ocurrido los siguientes errores:",Object(bt.jsx)("ul",{children:g.map(((t,e)=>Object(bt.jsx)("li",{children:t},e)))})]}),Object(bt.jsx)("h1",{sx:{position:"absolute",top:0},children:"Crea tu cuenta"}),Object(bt.jsx)("div",{style:{marginTop:20},children:Object(bt.jsx)(Re.a,{style:{width:"80%"},type:"text",onChange:t=>a(t.target.value),value:i,name:"email",label:"E-Mail"})}),Object(bt.jsx)("div",{style:{marginTop:20},children:Object(bt.jsx)(Re.a,{style:{width:"80%"},type:"text",onChange:t=>d(t.target.value),value:c,name:"username",label:"Nombre para mostrar"})}),Object(bt.jsx)("div",{style:{marginTop:20},children:Object(bt.jsx)(Re.a,{style:{width:"80%"},type:u?"text":"password",onChange:t=>o(t.target.value),value:r,name:"password",label:"Contrase\xf1a",InputProps:{endAdornment:Object(bt.jsx)(Oe.a,{position:"end",children:Object(bt.jsx)(Wt.a,{"aria-label":"toggle password visibility",onClick:()=>p(!u),children:u?Object(bt.jsx)(Pe.a,{}):Object(bt.jsx)(_e.a,{})})})}})}),Object(bt.jsx)("div",{style:{marginTop:20},children:Object(bt.jsx)(Re.a,{style:{width:"80%"},type:u?"text":"password",onChange:t=>l(t.target.value),value:h,name:"passwordConfirmation",label:"Repetir Contrase\xf1a"})}),Object(bt.jsx)("div",{style:{marginTop:20},children:w?Object(bt.jsx)(Te.a,{}):Object(bt.jsx)(dt.a,{variant:"contained",type:"submit",children:"CREAR CUENTA"})}),Object(bt.jsx)("div",{style:{marginTop:20},children:Object(bt.jsx)("p",{className:"p_button",onClick:()=>{e(!0)},children:"\xbfYa poses una cuenta? Inicia sesi\xf3n..."})})]})})]})},ke=t=>{let{childElement:e}=t;const[s,a]=Object(i.useState)({user:void 0,exp:void 0,jwt:void 0});return n.a.useEffect((()=>{const t=localStorage.getItem("session");if(t){const e=JSON.parse(t);e&&new Date(e.exp)>new Date?a({user:e.user,exp:e.exp,jwt:e.jwt}):(a({user:void 0,exp:void 0,jwt:void 0}),localStorage.setItem("session",null))}}),[]),Object(bt.jsx)(Me.b,{clientId:"18785041157-s9ga39r0i6up45radtj3soo6je1pneon.apps.googleusercontent.com",children:Object(bt.jsx)(ut.Provider,{value:{session:s,setSession:a},children:e})})};var Ue=s(364),Be=s(365),We=s(362),Je=s(363),He=s(385),Ne=s.n(He),Ge=s(386),Qe=s.n(Ge),ze=s(387),Ve=s.n(ze),Fe=s(388),Xe=s.n(Fe),Ke=s(389),qe=s.n(Ke);const Ye=t=>{let{level:e}=t;const s=Object(ht.n)(),{session:i}=n.a.useContext(ut),[a,r]=n.a.useState(!1),[o,h]=n.a.useState({score:void 0,time:void 0}),l=t=>{const e=parseInt(t/1e3),s=e%60,i=parseInt((e-s)/60);return`${parseInt((i-i%60)/24).toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`};return n.a.useEffect((()=>{i&&i.user&&(async()=>{try{const t=await fetch(`${pt}/user_progress/?level_id=${e.id}&user_id=${i.user.id}`,{method:"GET",headers:{"Content-Type":"application/json"}}),s=await t.json();if(200!==t.status){const e=s.detail[0].msg?s.detail[0].msg:s.detail;let i=t.status+" - "+t.statusText+" - "+e;throw new Error(i)}r(s.completed),h({score:s.best_score,time:s.best_time?l(s.best_time):s.best_time})}catch(t){throw new Error(t)}})()}),[]),Object(bt.jsxs)(We.a,{style:{display:"flex",justifyContent:"center",alignItems:"center",flexDirection:"column",width:"100%"},children:[Object(bt.jsx)(wt.a,{component:"img",width:400,height:200,image:`/levels/images/${e.image}`,title:e.title,style:{borderRadius:20},sx:{objectFit:"contain",justifyContent:"center",display:"flex",maxHeight:"100%",maxWidth:"100%"}}),Object(bt.jsxs)(xt.a,{container:!0,spacing:2,rowSpacing:2,justifyContent:"space-around",alignItems:"center",alignContent:"center",className:"card_text_wrapper",children:[Object(bt.jsx)(xt.a,{item:!0,xs:12,sm:9,style:{padding:0},children:Object(bt.jsx)(Je.a,{title:e.title,subheader:e.description,style:{padding:0}})}),Object(bt.jsx)(xt.a,{item:!0,xs:12,sm:3,children:Object(bt.jsx)(ct.a,{children:a?Object(bt.jsxs)(Rt.a,{style:{color:"green",fontWeight:"bold"},children:[Object(bt.jsx)(Ne.a,{style:{color:"green",verticalAlign:"middle",marginRight:10}}),"COMPLETADO"]}):Object(bt.jsxs)(Rt.a,{style:{color:"red",fontWeight:"bold"},children:[Object(bt.jsx)(Qe.a,{style:{color:"red",verticalAlign:"middle",marginRight:10}}),"PENDIENTE"]})})}),Object(bt.jsx)(xt.a,{item:!0,xs:12,md:4,children:a&&Object(bt.jsxs)(bt.Fragment,{children:[Object(bt.jsxs)(Rt.a,{children:[Object(bt.jsx)(Ve.a,{style:{verticalAlign:"middle",marginRight:10}}),Object(bt.jsx)("strong",{children:"Mejor tiempo:"})]}),Object(bt.jsx)(Rt.a,{style:{marginLeft:35},children:o.time})]})}),Object(bt.jsx)(xt.a,{item:!0,xs:12,md:4,children:a&&Object(bt.jsxs)(bt.Fragment,{children:[Object(bt.jsxs)(Rt.a,{children:[Object(bt.jsx)(Xe.a,{style:{verticalAlign:"middle",marginRight:10}}),Object(bt.jsx)("strong",{children:"Mejor puntaje:"})]}),Object(bt.jsx)(Rt.a,{style:{marginLeft:35},children:o.score})]})}),Object(bt.jsx)(xt.a,{item:!0,xs:12,md:4,style:{textAlign:"center"},children:Object(bt.jsx)(dt.a,{startIcon:Object(bt.jsx)(qe.a,{}),onClick:()=>{s("/scene",{state:{jsonLevel:e}})},className:"accept_button",children:"PRACTICAR"})})]})]})};var $e=s(390),ts=s.n($e);const es=()=>{const[t,e]=n.a.useState([]);n.a.useEffect((()=>{null!==localStorage.getItem("VR")&&(localStorage.removeItem("VR"),window.location.reload())}),[]);return n.a.useEffect((()=>{(async()=>{try{const t=[],s=await fetch(`${pt}/levels/`,{method:"GET",headers:{"Content-Type":"application/json"}}),i=await s.json();if(i.forEach((e=>{e.level_json=JSON.parse(e.level_json),e.level_json.id=e.id,t.push(e.level_json)})),200!==s.status){const t=i.detail[0].msg?i.detail[0].msg:i.detail;let e=s.status+" - "+s.statusText+" - "+t;throw new Error(e)}e(t)}catch(t){throw new Error(t)}})()}),[]),Object(bt.jsx)(xt.a,{container:!0,justifyContent:"center",alignItems:"center",alignContent:"center",children:Object(bt.jsx)(xt.a,{item:!0,xs:12,md:9,lg:6,alignContent:"center",justifyContent:"center",alignItems:"center",children:Object(bt.jsx)(ts.a,{sx:{width:"100%",padding:"20px"},autoPlay:!1,navButtonsAlwaysVisible:!0,indicators:!1,navButtonsProps:{style:{opacity:"0.4"}},swipe:!0,className:"levelsCarousel",animation:"slide",children:t.map((t=>Object(bt.jsx)(Ue.a,{sx:{height:500,width:"90%",margin:"auto",background:"transparent",boxShadow:0},children:Object(bt.jsx)(Be.a,{children:Object(bt.jsx)(Ye,{level:t})})},t.title)))})})})},ss=t=>{let{openDialog:e,setOpenDialog:s}=t;const[i,a]=n.a.useState(!0);return Object(bt.jsx)(ye.a,{open:e,onClose:()=>{s(!1)},maxWidth:"md",fullWidth:!0,children:Object(bt.jsx)(je.a,{style:{backgroundColor:"#68B9D2"},sx:{minHeight:"75vh",display:"flex",alignContent:"center",justifyContent:"center",alignItems:"center"},children:i?Object(bt.jsx)(De,{setLogin:a,setOpenDialog:s}):Object(bt.jsx)(Ze,{setLogin:a,setOpenDialog:s})})})},is=()=>{const[t,e]=n.a.useState(!1),[s,i]=n.a.useState(null),{session:a}=n.a.useContext(ut);return n.a.useEffect((()=>{a&&a.user&&i(a.user.name_to_show)}),[a]),Object(bt.jsxs)(bt.Fragment,{children:[s?Object(bt.jsx)("p",{children:Object(bt.jsxs)("strong",{children:["\xa1Bienvenido, ",s,"!"]})}):Object(bt.jsx)("div",{children:Object(bt.jsx)("p",{className:"p_button",onClick:()=>e(!0),children:"Inicia sesi\xf3n y guarda tu progreso..."})}),Object(bt.jsx)(ss,{openDialog:t,setOpenDialog:e})]})};var ns=s(391),as=s.n(ns);const rs=()=>{const t=Object(ht.n)();return Object(bt.jsxs)("div",{className:"background",children:[Object(bt.jsx)(xt.a,{container:!0,spacing:2,rowSpacing:2,sx:{marginTop:0},children:Object(bt.jsx)(xt.a,{item:!0,xs:12,style:{textAlign:"center"},children:Object(bt.jsx)("h1",{style:{fontSize:64},children:"Seleccionar Nivel"})})}),Object(bt.jsxs)(xt.a,{container:!0,spacing:2,rowSpacing:2,justifyContent:"center",children:[Object(bt.jsx)(xt.a,{item:!0,xs:12,md:4,style:{textAlign:"right"},children:Object(bt.jsx)(dt.a,{onClick:()=>{t("/")},startIcon:Object(bt.jsx)(as.a,{}),className:"accept_button",children:"ATR\xc1S"})}),Object(bt.jsx)(xt.a,{item:!0,xs:12,md:8,style:{textAlign:"center"},children:Object(bt.jsx)(is,{})})]}),Object(bt.jsx)(xt.a,{container:!0,spacing:2,rowSpacing:2,children:Object(bt.jsx)(xt.a,{item:!0,xs:12,children:Object(bt.jsx)(es,{})})})]})};var os=function(){return Object(bt.jsx)(ke,{childElement:Object(bt.jsx)(fe.a,{children:Object(bt.jsxs)(ht.c,{children:[Object(bt.jsx)(ht.a,{exact:!0,path:"/levels",element:Object(bt.jsx)(rs,{})}),Object(bt.jsx)(ht.a,{exact:!0,path:"/scene",element:Object(bt.jsx)(Dt,{})}),Object(bt.jsx)(ht.a,{exact:!0,path:"/",element:Object(bt.jsx)(Bt,{})}),Object(bt.jsx)(ht.a,{exact:!0,path:"/level-editor",element:Object(bt.jsx)(xe,{})}),Object(bt.jsx)(ht.a,{exact:!0,path:"/login",element:Object(bt.jsx)(De,{})}),Object(bt.jsx)(ht.a,{exact:!0,path:"/signup",element:Object(bt.jsx)(Ze,{})})]})})})};r.a.createRoot(document.getElementById("root")).render(Object(bt.jsx)(os,{}))}},[[528,1,2]]]);
//# sourceMappingURL=main.84b3039c.chunk.js.map