/*! For license information please see main.772b7830.chunk.js.LICENSE.txt */
(this["webpackJsonptpp-driving-simulator"]=this["webpackJsonptpp-driving-simulator"]||[]).push([[0],{122:function(t,e,s){"use strict";s.r(e),s.d(e,"default",(function(){return i}));class i{constructor(t){this.car=t}handleAccelerate(t,e){this.car.accelerate(t,e)}handleBrake(t,e){this.car.brake(t,e)}doHorn(){this.car.doHorn()}changeShift(t,e){this.car.changeShift(t,e)}turnDirection(t){this.car.turnDirection(t)}turnOnCar(){this.car.turnOnCar()}updateCar(){this.car.update()}changeShiftBox(t){this.car.changeShiftBox(t)}}},212:function(t,e,s){},223:function(t,e){},225:function(t,e){},236:function(t,e){},238:function(t,e){},263:function(t,e){},265:function(t,e){},266:function(t,e){},271:function(t,e){},273:function(t,e){},279:function(t,e){},281:function(t,e){},300:function(t,e){},312:function(t,e){},315:function(t,e){},319:function(t,e,s){"use strict";s.r(e);var i=s(1),n=s.n(i),o=s(177),r=s.n(o),a=(s(212),s(0));class h{constructor(){this.observedState=null}update(t){this.observedState=t}}class l extends h{constructor(t){super(),this.camera=new a.hb(85,window.innerWidth/window.innerHeight,.1,300),this.group=new a.fb,this.group180Rot=(new a.fb).add(this.camera),this.group.add(this.group180Rot),this.renderer=t}handleResize(){this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix()}setPositionRelativeToObject(){const t=new a.Jb(.4,.6,-.1);if(null!=this.observedState)if(t.applyQuaternion(this.observedState.rotation),this.group.position.copy(this.observedState.position).add(t),"true"===localStorage.getItem("VR")){let t=new a.Jb(0,-1.25,0);t.applyQuaternion(this.observedState.rotation),this.group.position.add(t),this.group.setRotationFromQuaternion(this.observedState.rotation),this.group180Rot.setRotationFromAxisAngle(new a.Jb(0,1,0),Math.PI),this.camera.lookAt(new a.Jb(0,0,5))}else{const t=new a.pb(this.observedState.rotation.x,this.observedState.rotation.y,this.observedState.rotation.z,this.observedState.rotation.w).normalize();this.group180Rot.setRotationFromAxisAngle(new a.Jb(0,1,0),-5*Math.PI/180),this.group.quaternion.copy(t)}else this.camera.lookAt(new a.Jb(0,0,5))}getCameraInstance(){return this.camera}addContainerToScene(t){t.add(this.group)}}class d extends h{constructor(t){super(),this.positionCamera=t,this.camera=new a.hb(75,window.innerWidth/window.innerHeight,.1,300)}handleResize(){this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix()}setPositionRelativeToObject(){const t=new a.Jb(this.positionCamera.x,this.positionCamera.y,this.positionCamera.z);if(null!=this.observedState){let e=t.applyQuaternion(this.observedState.rotation);this.camera.position.copy(this.observedState.position).add(e);let s=new a.Jb(this.observedState.position.x,this.observedState.position.y,this.observedState.position.z);this.camera.lookAt(s)}else this.camera.lookAt(new a.Jb(0,0,0)),this.camera.position.copy(t)}getCameraInstance(){return this.camera}}var c=s(178);class u extends h{constructor(t){super(),this.camera=new a.hb(75,window.innerWidth/window.innerHeight,.1,1e3),this.renderer=t,this.controls=new c.a(this.camera,this.renderer.domElement),this.controls.enableDamping=!0,this.controls.dampingFactor=.25,this.controls.enableZoom=!0,this.camera.position.set(0,5.5,0)}handleResize(){this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix()}getCameraInstance(){return this.camera}setPositionRelativeToObject(){this.controls.update(),null!=this.observedState?this.camera.lookAt(this.observedState.position):this.camera.lookAt(new a.Jb(0,0,0))}}var p=s(190),b=s(85);class g extends h{constructor(t){super(),this.fbxLoader=new p.a,this.gltfLoader=new b.a,this.threeDModel=null,this.pathToTexture=t}async loadFBX(){let t=this.pathToTexture;return await this.fbxLoader.loadAsync(t,(function(t){return t}))}async loadGLTF(){let t=this.pathToTexture;return await this.gltfLoader.loadAsync(t,(function(t){return t}))}async addToScene(t,e,s,i){if(!this.threeDModel){let o;try{o=await this.loadFBX(),this.threeDModel=o}catch(n){o=await this.loadGLTF(),this.threeDModel=o.scene}this.threeDModel.name=e,this.threeDModel.position.x=s[0],this.threeDModel.position.y=s[1],this.threeDModel.position.z=s[2],this.threeDModel.scale.x=i[0],this.threeDModel.scale.y=i[1],this.threeDModel.scale.z=i[2],t.add(this.threeDModel)}return this}getModel(){return this.threeDModel}animate(){return null}}var S=s(87);class w{constructor(){this.gltfLoader=new b.a,this.carModel=null,this.building_1=null,this.building_2=null,this.building_3=null,this.building_4=null}changeMaterialsToBasic(t){for(let e=0;e<t.length;e++){const s=t[e];if(s.isGroup)this.changeMaterialsToBasic(s.children);else if(s.isMesh){const t=new a.W;a.U.prototype.copy.call(t,s.material),s.material=t,s.receiveShadow=!0,s.castShadow=!0}}}async loadGLTF(t){let e=t;const s=await this.gltfLoader.loadAsync(e,(function(t){return t}));return this.changeMaterialsToBasic(s.scene.children),s.scene}async loadModels(){return this.carModel=this.loadGLTF("res/models/source/Mercedes.glb"),this.building_1=this.loadGLTF("res/models/source/buildings/Building_1.glb"),this.building_2=this.loadGLTF("res/models/source/buildings/Building_2.glb"),this.building_3=this.loadGLTF("res/models/source/buildings/Building_3.glb"),this.building_4=this.loadGLTF("res/models/source/buildings/Building_4.glb"),"OK"}}class m{static async getInstance(){if(m.ModelsSingleton)return m.ModelsSingleton;if(m.ModelsSingleton=new w,"OK"===await m.ModelsSingleton.loadModels())return m.ModelsSingleton;throw new Error("Error al cargar los modelos.")}}const E=[1,1,1],f=[0,0,0],x=.75,y=1/3600;class v extends g{constructor(){super("res/models/source/Mercedes.glb"),this.carModel=null,this.carLogic=null,this.lastValueRotation=0,this.currentSpeedRotation=0,this.currentWheelRotation=0,this.lastSteeringRotation=0,this.lastVelocityRotation=0,this.lastRPMRotation=0}generateRetrovisor(){const t=new a.jb(.145,.085),e=new S.a(t,{textureWidth:window.innerWidth,textureHeight:window.innerHeight,clipBias:.35,multisample:4});e.rotateX(Math.PI-.04),e.rotateY(.35),e.position.set(.075,.625,.31),this.threeDModel.add(e)}generateLeftMirror(){const t=new a.jb(.19,.1),e=new S.a(t,{textureWidth:window.innerWidth,textureHeight:window.innerHeight,clipBias:0,multisample:4});let s=new a.fb;s.add(e),s.position.set(.96,.345,.62),s.rotateX(.13-Math.PI),e.rotateY(-18*Math.PI/180),this.threeDModel.add(s)}generateRightMirror(){const t=new a.jb(.19,.1),e=new S.a(t,{textureWidth:window.innerWidth,textureHeight:window.innerHeight,clipBias:0,multisample:4});let s=new a.fb;s.add(e),s.position.set(-.96,.345,.62),s.rotateX(.1-Math.PI),e.rotateY(18*Math.PI/180),this.threeDModel.add(s)}generateMirrors(){this.generateRetrovisor(),this.generateLeftMirror(),this.generateRightMirror()}generateSpotlights(){this.rightSpotlight=new a.zb(16777215),this.leftSpotlight=new a.zb(16777215),this.targetRight=new a.fb,this.targetLeft=new a.fb,this.targetRight.position.set(-.8,.05,3),this.targetLeft.position.set(.8,.05,3),this.rightSpotlight.position.set(-.8,.3,2.6),this.leftSpotlight.position.set(.8,.3,2.6),this.rightSpotlight.target=this.targetRight,this.leftSpotlight.target=this.targetLeft,this.leftSpotlight.castShadow=!0,this.rightSpotlight.castShadow=!0,this.rightSpotlight.shadow.mapSize.width=1024,this.leftSpotlight.shadow.mapSize.height=1024,this.rightSpotlight.shadow.camera.near=.1,this.leftSpotlight.shadow.camera.near=.1,this.rightSpotlight.shadow.camera.far=2,this.leftSpotlight.shadow.camera.far=2,this.rightSpotlight.shadow.camera.fov=10,this.leftSpotlight.shadow.camera.fov=10,this.rightSpotlight.intensity=.5,this.leftSpotlight.intensity=.5,this.rightSpotlight.angle=Math.PI/5,this.leftSpotlight.angle=Math.PI/5,this.threeDModel.add(this.leftSpotlight),this.threeDModel.add(this.rightSpotlight),this.threeDModel.add(this.targetLeft),this.threeDModel.add(this.targetRight)}async addToScene(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"driverCar",s=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const i=await m.getInstance();return this.threeDModel=await i.carModel,this.threeDModel=this.threeDModel.clone(),this.threeDModel.name=e,this.threeDModel.position.x=f[0],this.threeDModel.position.y=f[1],this.threeDModel.position.z=f[2],this.threeDModel.scale.x=E[0],this.threeDModel.scale.y=E[1],this.threeDModel.scale.z=E[2],t.add(this.threeDModel),s&&this.generateMirrors(),this.generateSpotlights(),this}animate(){this.moveCar()}addPhysicsView(t){this.physicsShape=new a.Jb(2,1.35,5);const e=new a.e(this.physicsShape.x,this.physicsShape.y,this.physicsShape.z),s=new a.U({color:255});this.PHYSICSSQUARE=new a.T(e,s),this.PHYSICSSQUARE.position.set(0,0,0),t.add(this.PHYSICSSQUARE);const i=new a.l(.35,.35,.35,32,32);i.rotateZ(Math.PI/2);const n=new a.U({color:16711680});this.wheelMesh1=new a.T(i,n),this.wheelMesh1.position.set(0,4,0),t.add(this.wheelMesh1),this.wheelMesh2=new a.T(i,n),this.wheelMesh2.position.set(0,4,0),t.add(this.wheelMesh2),this.wheelMesh3=new a.T(i,n),this.wheelMesh3.position.set(0,4,0),t.add(this.wheelMesh3),this.wheelMesh4=new a.T(i,n),this.wheelMesh4.position.set(0,4,0),t.add(this.wheelMesh4)}watchPhysicsColliders(){null!=this.observedState&&(this.PHYSICSSQUARE.position.set(this.observedState.position.x,this.observedState.position.y,this.observedState.position.z),this.PHYSICSSQUARE.quaternion.set(this.observedState.rotation.x,this.observedState.rotation.y,this.observedState.rotation.z,this.observedState.rotation.w),this.wheelMesh1.position.set(this.observedState.wheelsData[0].position.x,this.observedState.wheelsData[0].position.y,this.observedState.wheelsData[0].position.z),this.wheelMesh1.quaternion.set(this.observedState.wheelsData[0].rotation.x,this.observedState.wheelsData[0].rotation.y,this.observedState.wheelsData[0].rotation.z,this.observedState.wheelsData[0].rotation.w),this.wheelMesh2.position.set(this.observedState.wheelsData[1].position.x,this.observedState.wheelsData[1].position.y,this.observedState.wheelsData[1].position.z),this.wheelMesh2.quaternion.set(this.observedState.wheelsData[1].rotation.x,this.observedState.wheelsData[1].rotation.y,this.observedState.wheelsData[1].rotation.z,this.observedState.wheelsData[1].rotation.w),this.wheelMesh3.position.set(this.observedState.wheelsData[2].position.x,this.observedState.wheelsData[2].position.y,this.observedState.wheelsData[2].position.z),this.wheelMesh3.quaternion.set(this.observedState.wheelsData[2].rotation.x,this.observedState.wheelsData[2].rotation.y,this.observedState.wheelsData[2].rotation.z,this.observedState.wheelsData[2].rotation.w),this.wheelMesh4.position.set(this.observedState.wheelsData[3].position.x,this.observedState.wheelsData[3].position.y,this.observedState.wheelsData[3].position.z),this.wheelMesh4.quaternion.set(this.observedState.wheelsData[3].rotation.x,this.observedState.wheelsData[3].rotation.y,this.observedState.wheelsData[3].rotation.z,this.observedState.wheelsData[3].rotation.w))}moveCar(){null!=this.observedState&&(this.threeDModel.userData.physicsBody=this.observedState.physicsBody,this.threeDModel.position.set(this.observedState.position.x,this.observedState.position.y,this.observedState.position.z),this.threeDModel.quaternion.set(this.observedState.rotation.x,this.observedState.rotation.y,this.observedState.rotation.z,this.observedState.rotation.w),this.lastValueRotation=this.observedState.direction,this.rotateWheels(),this.rotateSteeringWheel(),this.rotateVelocityAndRPM())}rotateSteeringWheel(){let t=this.threeDModel.children.find((t=>"Steering_Wheel"===t.name)),e=new a.Jb(0,0,1).applyAxisAngle(new a.Jb(1,0,0),.13);t.rotateOnAxis(e,this.lastSteeringRotation),t.rotateOnAxis(e,540*this.observedState.lastRotationWheel/360*Math.PI*2),this.lastSteeringRotation=540*-this.observedState.lastRotationWheel/360*Math.PI*2}rotateVelocityAndRPM(){let t=this.threeDModel.children.find((t=>"Cubo001"===t.name)),e=this.threeDModel.children.find((t=>"Cubo"===t.name));const s=-Math.abs(this.observedState.velocity)*(240*Math.PI/180)/240,i=-this.observedState.rpm*(260*Math.PI/180)/6e3;t.rotateOnAxis(new a.Jb(0,1,0),-this.lastVelocityRotation),t.rotateOnAxis(new a.Jb(0,1,0),s),e.rotateOnAxis(new a.Jb(0,1,0),-this.lastRPMRotation),e.rotateOnAxis(new a.Jb(0,1,0),i),this.lastVelocityRotation=s,this.lastRPMRotation=i}rotateWheels(){let t=this.threeDModel.children.find((t=>"W222WheelFtR"===t.name)),e=this.threeDModel.children.find((t=>"W222WheelFtL"===t.name)),s=this.threeDModel.children.find((t=>"W222WheelBkR"===t.name)),i=this.threeDModel.children.find((t=>"W222WheelBkL"===t.name)),n=new a.Jb(0,1,0).applyAxisAngle(new a.Jb(1,0,0),-this.currentSpeedRotation);e.rotateOnAxis(n,this.currentWheelRotation),t.rotateOnAxis(n,this.currentWheelRotation),e.rotateX(this.observedState.velocity*y*4),t.rotateX(this.observedState.velocity*y*4),s.rotateX(this.observedState.velocity*y*4),i.rotateX(this.observedState.velocity*y*4),n=new a.Jb(0,1,0).applyAxisAngle(new a.Jb(1,0,0),-this.currentSpeedRotation-this.observedState.velocity*y*4),e.rotateOnAxis(n,-this.observedState.lastRotationWheel*x),t.rotateOnAxis(n,-this.observedState.lastRotationWheel*x),this.currentWheelRotation=this.observedState.lastRotationWheel*x,this.currentSpeedRotation+=this.observedState.velocity*y*4,this.currentSpeedRotation>=2*Math.PI&&(this.currentSpeedRotation-=2*Math.PI)}}const{default:I}=s(122);class A{constructor(t){this.carLogic=t;const e=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[];this.gamepad=null;for(let s=0;s<e.length;s++)e[s]&&e[s].id.startsWith("G29 Driving Force Racing Wheel")&&(this.gamepad=e[s]);this.buttonX=0,this.buttonSquare=1,this.buttonCircle=2,this.buttonTriangle=3,this.bumperRight=4,this.bumperLeft=5,this.buttonR2=6,this.buttonL2=7,this.shareButton=8,this.optionsButton=9,this.buttonR3=10,this.buttonL3=11,this.firstShift=12,this.secondShift=13,this.thirdShift=14,this.fourthShift=15,this.fifthShift=16,this.sixthShift=17,this.reverseShift=18,this.buttonPlus=19,this.buttonMinus=20,this.wheelInEnterRight=21,this.wheelInEnterLeft=22,this.enter=23,this.psButton=24,this.buttonsPressed=[];for(let s=0;s<=24;s++)this.buttonsPressed.push(!1);this.wheelAxes=0,this.clutch=1,this.accelerator=2,this.brake=5,this.DPad=9,this.valueDpadUP=-1,this.valueDpadDOWN=.14285719394683838,this.valueDpadLEFT=.7142857313156128,this.valueDpadRIGHT=-.4285714030265808,this.dpadPressed=[];for(let s=0;s<=3;s++)this.dpadPressed.push(!1);this.globalControllerHandler=new I(t)}checkGamepadChanges(){const t=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[];for(let e=0;e<t.length;e++)t[e]&&t[e].id.startsWith("G29 Driving Force Racing Wheel")&&(this.gamepad=t[e])}checkEvents(){this.gamepad=null,this.checkGamepadChanges(),null!=this.gamepad&&this.doActionByMapping(),this.globalControllerHandler.updateCar()}doActionsPedals(){let t=this.gamepad.axes[this.clutch]**3,e=this.gamepad.axes[this.brake]**3;e=1-(e+1)/2;let s=this.gamepad.axes[this.accelerator]**3;s=1-(s+1)/2,this.globalControllerHandler.handleAccelerate(t,s),this.globalControllerHandler.handleBrake(t,e)}doActionsWheel(){this.globalControllerHandler.turnDirection(this.gamepad.axes[this.wheelAxes])}doActionsDPad(){if(1.2857143878936768!==this.gamepad.axes[this.DPad])this.gamepad.axes[this.DPad]!==this.valueDpadDOWN||this.dpadPressed[1]?this.gamepad.axes[this.DPad]!==this.valueDpadDOWN&&(this.dpadPressed[1]=!1):this.dpadPressed[1]=!0,this.gamepad.axes[this.DPad]!==this.valueDpadLEFT||this.dpadPressed[2]?this.gamepad.axes[this.DPad]!==this.valueDpadLEFT&&(this.dpadPressed[2]=!1):this.dpadPressed[2]=!0,this.gamepad.axes[this.DPad]!==this.valueDpadRIGHT||this.dpadPressed[3]?this.gamepad.axes[this.DPad]!==this.valueDpadRIGHT&&(this.dpadPressed[3]=!1):this.dpadPressed[3]=!0,this.gamepad.axes[this.DPad]!==this.valueDpadUP||this.dpadPressed[0]?this.gamepad.axes[this.DPad]!==this.valueDpadUP&&(this.dpadPressed[0]=!1):this.dpadPressed[0]=!0;else for(let t=0;t<this.dpadPressed.length;t++)this.dpadPressed[t]=!1}doActionsButtons(){this.gamepad.buttons[this.buttonX].pressed&&!this.buttonsPressed[this.buttonX]?this.buttonsPressed[this.buttonX]=!0:this.gamepad.buttons[this.buttonX].pressed||(this.buttonsPressed[this.buttonX]=!1),this.gamepad.buttons[this.buttonTriangle].pressed&&!this.buttonsPressed[this.buttonTriangle]?this.buttonsPressed[this.buttonTriangle]=!0:this.gamepad.buttons[this.buttonTriangle].pressed||(this.buttonsPressed[this.buttonTriangle]=!1),this.gamepad.buttons[this.buttonCircle].pressed&&!this.buttonsPressed[this.buttonCircle]?this.buttonsPressed[this.buttonCircle]=!0:this.gamepad.buttons[this.buttonCircle].pressed||(this.buttonsPressed[this.buttonCircle]=!1),this.gamepad.buttons[this.buttonSquare].pressed&&!this.buttonsPressed[this.buttonSquare]?this.buttonsPressed[this.buttonSquare]=!0:this.gamepad.buttons[this.buttonSquare].pressed||(this.buttonsPressed[this.buttonSquare]=!1),this.gamepad.buttons[this.psButton].pressed&&!this.buttonsPressed[this.psButton]?this.buttonsPressed[this.psButton]=!0:this.gamepad.buttons[this.psButton].pressed||(this.buttonsPressed[this.psButton]=!1),this.gamepad.buttons[this.buttonPlus].pressed&&!this.buttonsPressed[this.buttonPlus]?this.buttonsPressed[this.buttonPlus]=!0:this.gamepad.buttons[this.buttonPlus].pressed||(this.buttonsPressed[this.buttonPlus]=!1),this.gamepad.buttons[this.buttonMinus].pressed&&!this.buttonsPressed[this.buttonMinus]?this.buttonsPressed[this.buttonMinus]=!0:this.gamepad.buttons[this.buttonMinus].pressed||(this.buttonsPressed[this.buttonMinus]=!1),this.gamepad.buttons[this.buttonL2].pressed&&!this.buttonsPressed[this.buttonL2]?this.buttonsPressed[this.buttonL2]=!0:this.gamepad.buttons[this.buttonL2].pressed||(this.buttonsPressed[this.buttonL2]=!1),this.gamepad.buttons[this.buttonL3].pressed&&!this.buttonsPressed[this.buttonL3]?this.buttonsPressed[this.buttonL3]=!0:this.gamepad.buttons[this.buttonL3].pressed||(this.buttonsPressed[this.buttonL3]=!1),this.gamepad.buttons[this.buttonR2].pressed&&!this.buttonsPressed[this.buttonR2]?(this.globalControllerHandler.turnOnCar(),this.buttonsPressed[this.buttonR2]=!0):this.gamepad.buttons[this.buttonR2].pressed||(this.buttonsPressed[this.buttonR2]=!1),this.gamepad.buttons[this.buttonR3].pressed&&!this.buttonsPressed[this.buttonR3]?(this.globalControllerHandler.doHorn(),this.buttonsPressed[this.buttonR3]=!0):this.gamepad.buttons[this.buttonR3].pressed||(this.buttonsPressed[this.buttonR3]=!1),this.gamepad.buttons[this.enter].pressed&&!this.buttonsPressed[this.enter]?this.buttonsPressed[this.enter]=!0:this.gamepad.buttons[this.enter].pressed||(this.buttonsPressed[this.enter]=!1),this.gamepad.buttons[this.shareButton].pressed&&!this.buttonsPressed[this.shareButton]?this.buttonsPressed[this.shareButton]=!0:this.gamepad.buttons[this.shareButton].pressed||(this.buttonsPressed[this.shareButton]=!1),this.gamepad.buttons[this.optionsButton].pressed&&!this.buttonsPressed[this.optionsButton]?this.buttonsPressed[this.optionsButton]=!0:this.gamepad.buttons[this.optionsButton].pressed||(this.buttonsPressed[this.optionsButton]=!1),this.gamepad.buttons[this.bumperLeft].pressed&&!this.buttonsPressed[this.bumperLeft]?this.buttonsPressed[this.bumperLeft]=!0:this.gamepad.buttons[this.bumperLeft].pressed||(this.buttonsPressed[this.bumperLeft]=!1),this.gamepad.buttons[this.bumperRight].pressed&&!this.buttonsPressed[this.bumperRight]?this.buttonsPressed[this.bumperRight]=!0:this.gamepad.buttons[this.bumperRight].pressed||(this.buttonsPressed[this.bumperRight]=!1),this.gamepad.buttons[this.wheelInEnterLeft].pressed&&!this.buttonsPressed[this.wheelInEnterLeft]?this.buttonsPressed[this.wheelInEnterLeft]=!0:this.gamepad.buttons[this.wheelInEnterLeft].pressed||(this.buttonsPressed[this.wheelInEnterLeft]=!1),this.gamepad.buttons[this.wheelInEnterRight].pressed&&!this.buttonsPressed[this.wheelInEnterRight]?this.buttonsPressed[this.wheelInEnterRight]=!0:this.gamepad.buttons[this.wheelInEnterRight].pressed||(this.buttonsPressed[this.wheelInEnterRight]=!1)}doActionsShifter(){this.gamepad.buttons[this.firstShift].pressed&&!this.buttonsPressed[this.firstShift]?(this.globalControllerHandler.changeShift(this.gamepad.axes[this.clutch],1),this.buttonsPressed[this.firstShift]=!0):!this.gamepad.buttons[this.firstShift].pressed&&this.buttonsPressed[this.firstShift]&&(this.globalControllerHandler.changeShift(this.gamepad.axes[this.clutch],0),this.buttonsPressed[this.firstShift]=!1),this.gamepad.buttons[this.secondShift].pressed&&!this.buttonsPressed[this.secondShift]?(this.globalControllerHandler.changeShift(this.gamepad.axes[this.clutch],2),this.buttonsPressed[this.secondShift]=!0):!this.gamepad.buttons[this.secondShift].pressed&&this.buttonsPressed[this.secondShift]&&(this.globalControllerHandler.changeShift(this.gamepad.axes[this.clutch],0),this.buttonsPressed[this.secondShift]=!1),this.gamepad.buttons[this.thirdShift].pressed&&!this.buttonsPressed[this.thirdShift]?(this.globalControllerHandler.changeShift(this.gamepad.axes[this.clutch],3),this.buttonsPressed[this.thirdShift]=!0):!this.gamepad.buttons[this.thirdShift].pressed&&this.buttonsPressed[this.thirdShift]&&(this.globalControllerHandler.changeShift(this.gamepad.axes[this.clutch],0),this.buttonsPressed[this.thirdShift]=!1),this.gamepad.buttons[this.fourthShift].pressed&&!this.buttonsPressed[this.fourthShift]?(this.globalControllerHandler.changeShift(this.gamepad.axes[this.clutch],4),this.buttonsPressed[this.fourthShift]=!0):!this.gamepad.buttons[this.fourthShift].pressed&&this.buttonsPressed[this.fourthShift]&&(this.globalControllerHandler.changeShift(this.gamepad.axes[this.clutch],0),this.buttonsPressed[this.fourthShift]=!1),this.gamepad.buttons[this.fifthShift].pressed&&!this.buttonsPressed[this.fifthShift]?(this.globalControllerHandler.changeShift(this.gamepad.axes[this.clutch],5),this.buttonsPressed[this.fifthShift]=!0):!this.gamepad.buttons[this.fifthShift].pressed&&this.buttonsPressed[this.fifthShift]&&(this.globalControllerHandler.changeShift(this.gamepad.axes[this.clutch],0),this.buttonsPressed[this.fifthShift]=!1),this.gamepad.buttons[this.sixthShift].pressed&&!this.buttonsPressed[this.sixthShift]?(this.globalControllerHandler.changeShift(this.gamepad.axes[this.clutch],6),this.buttonsPressed[this.sixthShift]=!0):!this.gamepad.buttons[this.sixthShift].pressed&&this.buttonsPressed[this.sixthShift]&&(this.globalControllerHandler.changeShift(this.gamepad.axes[this.clutch],0),this.buttonsPressed[this.sixthShift]=!1),this.gamepad.buttons[this.reverseShift].pressed&&!this.buttonsPressed[this.reverseShift]?(this.globalControllerHandler.changeShift(this.gamepad.axes[this.clutch],-1),this.buttonsPressed[this.reverseShift]=!0):!this.gamepad.buttons[this.reverseShift].pressed&&this.buttonsPressed[this.reverseShift]&&(this.globalControllerHandler.changeShift(this.gamepad.axes[this.clutch],0),this.buttonsPressed[this.reverseShift]=!1)}doActionByMapping(){this.doActionsPedals(),this.doActionsWheel(),this.doActionsDPad(),this.doActionsButtons(),this.doActionsShifter()}}class R{constructor(){throw new Error("Can not construct singleton. Call get instance instead.")}static getInstance(t){return R.instance||(R.instance=new A(t)),R.instance}}const{default:P}=s(122),j=.1;class M{constructor(t){const e=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[];this.gamepad=null;for(let s=0;s<e.length;s++)e[s]&&(e[s].id.startsWith("Xbox")||e[s].id.startsWith("xinput"))&&(this.gamepad=e[s]);this.buttonA=0,this.buttonB=1,this.buttonX=2,this.buttonY=3,this.buttonL1=4,this.buttonR1=5,this.buttonL2=6,this.buttonR2=7,this.shareButton=8,this.optionButton=9,this.buttonL3=10,this.buttonR3=11,this.padUp=12,this.padDown=13,this.padLeft=14,this.padRight=15,this.buttomHome=16,this.buttonPressed=[],this.actualShift=0;for(let s=0;s<=16;s++)this.buttonPressed.push(!1);this.xLeftAxe=0,this.yLeftAxe=1,this.xRightAxe=2,this.yRightAxe=3,this.globalControllerHandler=new P(t)}checkGamepadChanges(){const t=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[];for(let e=0;e<t.length;e++)t[e]&&t[e].id.startsWith("Xbox")&&(this.gamepad=t[e])}checkEvents(){this.gamepad=null,this.checkGamepadChanges(),null!=this.gamepad&&this.doActionByMapping(),this.globalControllerHandler.updateCar()}doActionsAxes(){if(Math.abs(this.gamepad.axes[this.yLeftAxe]),Math.abs(this.gamepad.axes[this.xLeftAxe])>=j){let t=this.gamepad.axes[this.xLeftAxe]**3;this.globalControllerHandler.turnDirection(t)}else this.globalControllerHandler.turnDirection(0);Math.abs(this.gamepad.axes[this.yRightAxe]),Math.abs(this.gamepad.axes[this.xRightAxe])}doActionHotKeys(){this.globalControllerHandler.handleAccelerate(1,this.gamepad.buttons[this.buttonR2].value),this.globalControllerHandler.handleBrake(0,this.gamepad.buttons[this.buttonL2].value)}doActionsTriggers(){this.gamepad.buttons[this.buttonR2].pressed,this.gamepad.buttons[this.buttonL2].pressed}doActionsButtons(){this.gamepad.buttons[this.buttonR1].pressed&&!this.buttonPressed[this.buttonR1]?(this.actualShift<=5&&(this.actualShift+=1,this.globalControllerHandler.changeShift(0,this.actualShift)),this.buttonPressed[this.buttonR1]=!0):this.gamepad.buttons[this.buttonR1].pressed||(this.buttonPressed[this.buttonR1]=!1),this.gamepad.buttons[this.buttonL1].pressed&&!this.buttonPressed[this.buttonL1]?(this.actualShift>=0&&(this.actualShift-=1,this.globalControllerHandler.changeShift(0,this.actualShift)),this.buttonPressed[this.buttonL1]=!0):this.gamepad.buttons[this.buttonL1].pressed||(this.buttonPressed[this.buttonL1]=!1),this.gamepad.buttons[this.shareButton].pressed&&!this.buttonPressed[this.shareButton]?this.buttonPressed[this.shareButton]=!0:this.gamepad.buttons[this.shareButton].pressed||(this.buttonPressed[this.shareButton]=!1),this.gamepad.buttons[this.padUp].pressed&&!this.buttonPressed[this.padUp]?this.buttonPressed[this.padUp]=!0:this.gamepad.buttons[this.padUp].pressed||(this.buttonPressed[this.padUp]=!1),this.gamepad.buttons[this.padDown].pressed&&!this.buttonPressed[this.padDown]?this.buttonPressed[this.padDown]=!0:this.gamepad.buttons[this.padDown].pressed||(this.buttonPressed[this.padDown]=!1),this.gamepad.buttons[this.padLeft].pressed&&!this.buttonPressed[this.padLeft]?this.buttonPressed[this.padLeft]=!0:this.gamepad.buttons[this.padLeft].pressed||(this.buttonPressed[this.padLeft]=!1),this.gamepad.buttons[this.padRight].pressed&&!this.buttonPressed[this.padRight]?this.buttonPressed[this.padRight]=!0:this.gamepad.buttons[this.padRight].pressed||(this.buttonPressed[this.padRight]=!1),this.gamepad.buttons[this.buttonA].pressed&&!this.buttonPressed[this.buttonA]?this.buttonPressed[this.buttonA]=!0:this.gamepad.buttons[this.buttonA].pressed||(this.buttonPressed[this.buttonA]=!1),this.gamepad.buttons[this.buttonB].pressed&&!this.buttonPressed[this.buttonB]?this.buttonPressed[this.buttonB]=!0:this.gamepad.buttons[this.buttonB].pressed||(this.buttonPressed[this.buttonB]=!1),this.gamepad.buttons[this.buttonY].pressed&&!this.buttonPressed[this.buttonY]?this.buttonPressed[this.buttonY]=!0:this.gamepad.buttons[this.buttonY].pressed||(this.buttonPressed[this.buttonY]=!1),this.gamepad.buttons[this.buttonX].pressed&&!this.buttonPressed[this.buttonX]?this.buttonPressed[this.buttonX]=!0:this.gamepad.buttons[this.buttonX].pressed||(this.buttonPressed[this.buttonX]=!1),this.gamepad.buttons[this.buttonR3].pressed&&!this.buttonPressed[this.buttonR3]?(this.globalControllerHandler.doHorn(),this.buttonPressed[this.buttonR3]=!0):this.gamepad.buttons[this.buttonR3].pressed||(this.buttonPressed[this.buttonR3]=!1),this.gamepad.buttons[this.buttonL3].pressed&&!this.buttonPressed[this.buttonL3]?this.buttonPressed[this.buttonL3]=!0:this.gamepad.buttons[this.buttonL3].pressed||(this.buttonPressed[this.buttonL3]=!1),this.gamepad.buttons[this.padUp].pressed&&!this.buttonPressed[this.padUp]?this.buttonPressed[this.padUp]=!0:this.gamepad.buttons[this.padUp].pressed||(this.buttonPressed[this.padUp]=!1),this.gamepad.buttons[this.padDown].pressed&&!this.buttonPressed[this.padDown]?this.buttonPressed[this.padDown]=!0:this.gamepad.buttons[this.padDown].pressed||(this.buttonPressed[this.padDown]=!1),this.gamepad.buttons[this.padLeft].pressed&&!this.buttonPressed[this.padLeft]?this.buttonPressed[this.padLeft]=!0:this.gamepad.buttons[this.padLeft].pressed||(this.buttonPressed[this.padLeft]=!1),this.gamepad.buttons[this.padRight].pressed&&!this.buttonPressed[this.padRight]?this.buttonPressed[this.padRight]=!0:this.gamepad.buttons[this.padRight].pressed||(this.buttonPressed[this.padRight]=!1),this.gamepad.buttons[this.buttomHome].pressed&&!this.buttonPressed[this.buttomHome]?(this.globalControllerHandler.changeShiftBox("semi-auto"),this.buttonPressed[this.buttomHome]=!0):this.gamepad.buttons[this.buttomHome].pressed||(this.buttonPressed[this.buttomHome]=!1),this.gamepad.buttons[this.optionButton].pressed&&!this.buttonPressed[this.optionButton]?(this.globalControllerHandler.turnOnCar(),this.buttonPressed[this.optionButton]=!0):this.gamepad.buttons[this.optionButton].pressed||(this.buttonPressed[this.optionButton]=!1)}doActionByMapping(){this.doActionHotKeys(),this.doActionsAxes(),this.doActionsTriggers(),this.doActionsButtons()}}class T{constructor(){throw new Error("Can not construct singleton. Call get instance instead.")}static getInstance(t){return T.instance||(T.instance=new M(t)),T.instance}}class O{constructor(){this.observers=[]}attachObserver(t){this.observers.push(t)}removeObserver(t){let e=this.observers.indexOf(t);e>-1&&this.observers.splice(e,1)}notifyObservers(t){for(let e=0;e<this.observers.length;e++)this.observers[e].update(t)}}var D=s(179),_=s.n(D);class C{constructor(){throw new Error("Can not construct singleton. Call get instance instead.")}static async getInstance(){return C.AmmoInstanceToReturn||(C.AmmoInstanceToReturn=await _()()),C.AmmoInstanceToReturn}}C.AmmoInstanceToReturn=null;class L{constructor(t,e,s,i,n,o,r){this.position=t,this.quaternion=e,this.inertia=s,this.mass=i,this.shape=n,this.physicsWorld=o,this.friction=r}async buildAmmoPhysics(){let t=await C.getInstance();this.inertia=new t.btVector3(this.inertia.x,this.inertia.y,this.inertia.z),this.Ammo=t;let e=new t.btTransform;e.setIdentity(),e.setOrigin(new t.btVector3(this.position.x,this.position.y,this.position.z)),e.setRotation(new t.btQuaternion(this.quaternion.x,this.quaternion.y,this.quaternion.z,this.quaternion.w)),this.tempTransform=new t.btTransform;let s=new t.btDefaultMotionState(e),i=new t.btBoxShape(new t.btVector3(this.shape.x/2,this.shape.y/2,this.shape.z/2));i.calculateLocalInertia(this.mass,this.inertia);let n=new t.btRigidBodyConstructionInfo(this.mass,s,i,this.inertia);this.rigidBody=new t.btRigidBody(n),this.rigidBody.setFriction(this.friction),this.rigidBody.setRollingFriction(10*this.friction),this.physicsWorld.addRigidBody(this.rigidBody),this.tuning=new this.Ammo.btVehicleTuning;var o=new this.Ammo.btDefaultVehicleRaycaster(this.physicsWorld);this.vehicle=new this.Ammo.btRaycastVehicle(this.tuning,this.rigidBody,o),this.vehicle.setCoordinateSystem(0,1,2),this.physicsWorld.addAction(this.vehicle);this.addWheel(!0,new this.Ammo.btVector3(.85,.2,1.65),.35,.35,0,1),this.addWheel(!0,new this.Ammo.btVector3(-.85,.2,1.65),.35,.35,1,-1),this.addWheel(!1,new this.Ammo.btVector3(.85,.2,-1.45),.35,.35,2,1),this.addWheel(!1,new this.Ammo.btVector3(-.85,.2,-1.45),.35,.35,3,-1),this.mass>0&&this.rigidBody.setActivationState(4)}addWheel(t,e,s,i,n,o){var r=new this.Ammo.btVector3(0,-1,0),a=new this.Ammo.btVector3(-1,0,0),h=this.vehicle.addWheel(e,r,a,.6,s,this.tuning,t);h.set_m_suspensionStiffness(2),h.set_m_wheelsDampingRelaxation(3.3),h.set_m_wheelsDampingCompression(4.4),h.set_m_frictionSlip(1e3),h.set_m_rollInfluence(.2)}updatePhysics(){let t={chassis:{position:null,rotation:null},wheels:[]};for(let n=0;n<this.vehicle.getNumWheels();n++){this.vehicle.updateWheelTransform(n,!0);let e=this.vehicle.getWheelTransformWS(n),s=e.getOrigin(),i=e.getRotation();t.wheels.push({position:new a.Jb(s.x(),s.y(),s.z()),rotation:new a.Kb(i.x(),i.y(),i.z(),i.w())})}let e=this.vehicle.getChassisWorldTransform(),s=e.getOrigin(),i=e.getRotation();return t.chassis={position:new a.Jb(s.x(),s.y(),s.z()),rotation:new a.Kb(i.x(),i.y(),i.z(),i.w())},t}getRigidBody(){return this.rigidBody}setEngineForce(t){this.vehicle.applyEngineForce(t,2),this.vehicle.applyEngineForce(t,3)}brake(t){let e=Math.abs(this.vehicle.getCurrentSpeedKmHour()),s=100/e;0===e&&(s=0),t+=s,this.vehicle.setBrake(t/2,0),this.vehicle.setBrake(t/2,1),this.vehicle.setBrake(t,2),this.vehicle.setBrake(t,3)}setSteeringRotation(t){this.vehicle.setSteeringValue(-.5*t,0),this.vehicle.setSteeringValue(-.5*t,1)}getVelocity(){return this.vehicle.getCurrentSpeedKmHour()}}const Z=8e3,U=200;class W{changeValueInRPMCurve(t,e,s,i){let n;if(e){n=2*(t-s/Z)}else n=1.5*-t;return(i+=n)>600?i=600:i<0&&(i=0),[s=Z*(1-Math.exp(-i/U)),i]}}class H extends W{accelerate(t,e,s){return this.changeValueInRPMCurve(0,!0,e,s)}brake(t,e,s){return this.changeValueInRPMCurve(t,!1,e,s)}}class B extends W{accelerate(t,e,s){return this.changeValueInRPMCurve(t,!0,e,s)}brake(t,e,s){return this.changeValueInRPMCurve(t,!1,e,s)}}class J{constructor(t){this.engineState=new H,this.currentRPM=0,this.currentXInRPMCurve=0,this.playbackRate=1.1,this.useAudio=t}turnOn(){this.engineState instanceof H&&(this.engineState=new B,this.useAudio&&(new Audio("./sounds/encendido.wav").play(),setTimeout((()=>{this.soundEngine=new(window.AudioContext||window.webkitAudioContext),fetch("./sounds/engine.wav").then((t=>t.arrayBuffer())).then((t=>this.soundEngine.decodeAudioData(t))).then((t=>{this.soundEngineSource=this.soundEngine.createBufferSource(),this.soundEngineSource.buffer=t,this.soundEngineSource.loop=!0,this.soundEngineSource.connect(this.soundEngine.destination),this.soundEngineSource.start()}))}),1300)))}clutchIsPressed(t){return t<=.25}handleEngineShutdown(t,e){e.shutDownEngine(t,this.currentRPM)&&this.engineState instanceof B&&(this.engineState=new H)}isInConditionToAccelerate(t){return this.currentRPM>=0&&!this.clutchIsPressed(t)||this.clutchIsPressed(t)}engineCanApplyForce(t){return this.currentRPM>=0&&!this.clutchIsPressed(t)}accelerate(t,e,s){let i=this.engineState.accelerate(e,this.currentRPM,this.currentXInRPMCurve);this.currentRPM=i[0],this.soundEngineSource&&(this.soundEngineSource.playbackRate.value=1.1+this.currentRPM/Z*2),this.currentXInRPMCurve=i[1],this.handleEngineShutdown(t,s)}brake(t,e,s){let i=this.engineState.brake(e,this.currentRPM,this.currentXInRPMCurve);this.currentRPM=i[0],this.soundEngineSource&&(this.soundEngineSource.playbackRate.value=1.1+this.currentRPM/Z*2),this.currentXInRPMCurve=i[1],this.handleEngineShutdown(t,s)}changeRPM(t){this.currentRPM=t,-this.currentRPM/Z+1>0?(this.currentXInRPMCurve=-Math.log(-this.currentRPM/Z+1)*U,this.currentXInRPMCurve<0&&(this.currentXInRPMCurve=0)):this.currentRPM===Z&&(this.currentXInRPMCurve=600)}getCurrentRPM(){return this.currentRPM}}class G{constructor(t){this.NEUTRAL=0,this.REVERSE=-1,this.FIRST=1,this.SECOND=2,this.THIRD=3,this.FOURTH=4,this.FIFTH=5,this.SIXTH=6,this.validShifts=[this.REVERSE,this.NEUTRAL,this.FIRST,this.SECOND,this.THIRD,this.FOURTH,this.FIFTH,this.SIXTH],this.currentShift=this.NEUTRAL,this.carEngine=t,this.minimumVelocityOnShift=[0,10,20,35,60,90],this.maximumVelocityOnShift=[40,60,80,110,140,200]}isValidShift(t){if(this.validShifts.indexOf(t)>=0)return!0;throw new Error("Shift "+t+" is not valid.")}calculateNormalFactorRPM(t,e){return(e-this.minimumVelocityOnShift[Math.abs(t)-1])/(this.maximumVelocityOnShift[Math.abs(t)-1]-this.minimumVelocityOnShift[Math.abs(t)-1])}getValueForNewRPM(t,e){if(t===this.NEUTRAL||Math.abs(t)===this.FIRST&&Math.abs(e)<5)return this.carEngine.getCurrentRPM();if(t===this.REVERSE&&e>0)return 0;if(t>0&&e<0)return 0;let s=this.calculateNormalFactorRPM(t,e);if(s>1)return Z;{let t=s*U;return Z*(1-Math.exp(-t/U))}}clutchIsPressed(t){return t<=-.75}shutDownEngine(){return!1}getEngineForce(t,e){t=Math.abs(t);let s=this.carEngine.getCurrentRPM();if(this.currentShift===this.NEUTRAL)return 0;let i=(e+1)/2,n=this.minimumVelocityOnShift[Math.abs(this.currentShift)-1]*(1-Math.exp(3*-i)),o=(1-(t-n)/(this.maximumVelocityOnShift[Math.abs(this.currentShift)-1]-n))**2;return o>1&&(o=0),6/this.currentShift*s*o}changeShift(){}getCurrentShift(){return this.currentShift}}class k extends G{changeShift(t,e,s){if(!this.isValidShift(e)||!this.clutchIsPressed(t))throw new Error("Can't change shift if clutch is not pressed");this.currentShift=e,this.carEngine.changeRPM(this.getValueForNewRPM(e,s,t))}shutDownEngine(t,e){return!this.clutchIsPressed(t)&&e<1e3}}class Q extends G{changeShift(t,e,s){this.isValidShift(e)&&(this.currentShift=e,this.carEngine.changeRPM(this.getValueForNewRPM(e,s,t)))}}class N extends O{constructor(t,e){let s=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:(new a.pb).identity();super(),this.carEngine=new J(s),this.shiftBox=new Q(this.carEngine),this.currentDirectionTurn=0,this.currentTireRotation=0,this.position=new a.Jb(e[0],e[1],e[2]),this.rotationQuaternion=i,this.mass=1e3,this.physicsShape=new a.Jb(2,1.3,5),this.rotation=new a.Kb(0,0,0,1),this.inertia=new a.Jb(1,0,1),this.carPhysics=new L(this.position,this.rotationQuaternion,this.inertia,this.mass,this.physicsShape,t,0)}accelerate(t,e){this.carEngine.accelerate(t,e,this.shiftBox),e>.1&&this.carEngine.engineCanApplyForce(t)?this.carPhysics.setEngineForce(this.shiftBox.getEngineForce(this.carPhysics.getVelocity(),t)):this.carPhysics.setEngineForce(0)}brake(t,e){this.carEngine.brake(t,e,this.shiftBox),this.carPhysics.brake(180*e)}doHorn(){new Audio("./sounds/bocina.wav").play()}changeShift(t,e){this.shiftBox.changeShift(t,e,this.carPhysics.getVelocity())}turnOnRightLight(){}turnOnLeftLight(){}turnOnCar(){this.carEngine.turnOn()}turnDirection(t){this.currentTireRotation=t,this.carPhysics.setSteeringRotation(t)}update(){let t=this.carPhysics.updatePhysics();this.position=t.chassis.position,this.rotation=t.chassis.rotation,this.wheelsData=t.wheels,super.notifyObservers(this.getDataToAnimate())}getLastRotation(){return this.currentTireRotation}getDataToAnimate(){return{direction:this.currentDirectionTurn,velocity:this.carPhysics.getVelocity(),lastRotationWheel:this.currentTireRotation,dirVector:new a.Jb(0,0,1).applyQuaternion(this.rotation),position:this.position,rotation:this.rotation,physicsBody:this.carPhysics,wheelsData:this.wheelsData,rpm:this.getCurrentRPM()}}getSpeed(){return this.carPhysics.getVelocity()}getCurrentRPM(){return this.carEngine.getCurrentRPM()}changeShiftBox(t){"semi-auto"===t?this.shiftBox=new Q(this.carEngine):"manual"===t&&(this.shiftBox=new k(this.carEngine))}getCurrentShift(){return this.shiftBox.getCurrentShift()}}class z extends O{constructor(t,e,s,i,n,o,r){super(),this.position=t,this.quaternion=e,this.inertia=s,this.mass=i,this.shape=n,this.physicsWorld=o,r||(r=1),this.friction=r}async generateShape(){return null}async buildAmmoPhysics(){let t=await C.getInstance();this.inertia=new t.btVector3(this.inertia.x,this.inertia.y,this.inertia.z),this.Ammo=t;let e=new t.btTransform;e.setIdentity(),e.setOrigin(new t.btVector3(this.position.x,this.position.y,this.position.z)),e.setRotation(new t.btQuaternion(this.quaternion.x,this.quaternion.y,this.quaternion.z,this.quaternion.w)),this.tempTransform=new t.btTransform;let s=new t.btDefaultMotionState(e),i=await this.generateShape();i.calculateLocalInertia(this.mass,this.inertia);let n=new t.btRigidBodyConstructionInfo(this.mass,s,i,this.inertia);this.rigidBody=new t.btRigidBody(n),this.rigidBody.setFriction(this.friction),this.rigidBody.setRollingFriction(2*this.friction),this.physicsWorld.addRigidBody(this.rigidBody),this.mass>0&&this.rigidBody.setActivationState(4)}updatePhysics(){let t=this.rigidBody.getMotionState();if(t){t.getWorldTransform(this.tempTransform);let e=this.tempTransform.getOrigin(),s=this.tempTransform.getRotation();const i={position:new a.Jb(e.x(),e.y(),e.z()),rotation:new a.Kb(s.x(),s.y(),s.z(),s.w())};return this.notifyObservers(i),i}throw new Error("No motion state found in rigid body")}setLinearVelocity(t){let e=new this.Ammo.btVector3(this.mass*t.x,this.mass*t.y,this.mass*t.z);this.rigidBody.applyForce(e)}getRigidBody(){return this.rigidBody}}class V extends z{async generateShape(){let t=await C.getInstance();const e=new t.btBoxShape(new t.btVector3(this.shape.x/2,this.shape.y/2,this.shape.z/2));return e.setMargin(.05),e}}class F extends g{constructor(t){super(t),this.pathToTexture=t,this.RADIUS_TOP=.1,this.RADIUS_BOTTOM=.8,this.HEIGHT=1.25,this.observedState=null}animate(){null!=this.observedState&&(this.threeDModel.position.set(this.observedState.position.x,this.observedState.position.y,this.observedState.position.z),this.threeDModel.quaternion.set(this.observedState.rotation.x,this.observedState.rotation.y,this.observedState.rotation.z,this.observedState.rotation.w))}async addToScene(t,e,s,i){if(!this.threeDModel){const n=new a.l(this.RADIUS_TOP,this.RADIUS_BOTTOM,this.HEIGHT,32,void 0,!0),o=(new a.Cb).load(this.pathToTexture),r=new a.U({map:o}),h=new a.U({color:13984548}),l=new a.e(2*this.RADIUS_BOTTOM,.1,2*this.RADIUS_BOTTOM),d=new a.T(l,h);d.position.set(0,-this.HEIGHT/2,0);const c=new a.T(n,r);c.castShadow=!0,c.receiveShadow=!0,c.position.set(0,0,0),this.threeDModel=new a.u,this.threeDModel.add(c).add(d),this.threeDModel.name=e,this.threeDModel.position.set(s[0],s[1],s[2]),this.threeDModel.scale.set(i[0],i[1],i[2]),this.RADIUS_TOP*=i[0],this.RADIUS_BOTTOM*=i[0],this.HEIGHT*=i[1],t.add(this.threeDModel)}return this}}class X extends z{async generateShape(){let t=await C.getInstance();const e=new t.btCylinderShape(new t.btVector3(this.shape.x,this.shape.y,this.shape.z));return e.setMargin(.05),e}}class K extends z{async generateShape(){let t=await C.getInstance(),e=new t.btTriangleMesh,s=new t.btVector3(0,0,0),i=new t.btVector3(0,0,0),n=new t.btVector3(0,0,0),o=this.shape.getAttribute("position").array,r=[];for(let h=0;h<o.length;h+=3)r.push({x:o[h],y:o[h+1],z:o[h+2]});for(let h=0;h<r.length-3;h+=3)s.setX(r[h].x),s.setY(r[h].y),s.setZ(r[h].z),i.setX(r[h+1].x),i.setY(r[h+1].y),i.setZ(r[h+1].z),n.setX(r[h+2].x),n.setY(r[h+2].y),n.setZ(r[h+2].z),e.addTriangle(s,i,n,!0);t.destroy(s),t.destroy(i),t.destroy(n);var a=new t.btBvhTriangleMeshShape(e,!0);return a.setMargin(0),a}}class q extends g{constructor(t){super(t),this.pathToTexture=t,this.pathToNormalMap="textures/pavimento_map.png",this.SIZE=30,this.SIDEWALK_HEIGHT=.4,this.observedState=null}animate(){null!=this.observedState&&(this.threeDModel.position.set(this.observedState.position.x,this.observedState.position.y,this.observedState.position.z),this.threeDModel.quaternion.set(this.observedState.rotation.x,this.observedState.rotation.y,this.observedState.rotation.z,this.observedState.rotation.w))}createSidewalkMesh(t){const e=(new a.Cb).load("textures/pavimento.jpg");e.wrapS=a.rb,e.wrapT=a.rb,e.repeat.set(3,10*t);const s=new a.W({map:e,side:a.n}),i=new a.e(7*this.SIZE/24,this.SIDEWALK_HEIGHT,this.SIZE);return new a.T(i,s)}createStreetMesh(t){const e=new a.e(10*this.SIZE/24,.1,this.SIZE),s=(new a.Cb).load(this.pathToTexture);s.repeat.set(1,2*t),s.wrapS=a.rb,s.wrapT=a.rb;const i=new a.W({map:s,side:a.n}),n=new a.T(e,i);return n.receiveShadow=!0,n}async loadBuildingBlock(t){const e=await m.getInstance();return(await e[`building_${t}`]).clone()}async createBuildings(t,e){let s=await this.loadBuildingBlock(1+parseInt(4*Math.random()));s.name="buildingsRight_"+e,s.position.x=10*this.SIZE/24,s.position.y=this.SIDEWALK_HEIGHT+.05,s.position.z=-this.LONG/2+4+7.5*e,s.scale.x=.8,s.scale.y=1,s.scale.z=.6,s.rotateOnAxis(new a.Jb(0,1,0),-Math.PI/2),s.updateMatrix(),s.updateMatrixWorld(),s.matrixAutoUpdate=!1;let i=await this.loadBuildingBlock(1+parseInt(4*Math.random()));i.name="buildingsLeft_"+e,i.position.x=-10*this.SIZE/24,i.position.y=this.SIDEWALK_HEIGHT+.05,i.position.z=-this.LONG/2+4+7.5*e,i.scale.x=.8,i.scale.y=1,i.scale.z=.6,i.rotateOnAxis(new a.Jb(0,1,0),Math.PI/2),i.updateMatrix(),i.updateMatrixWorld(),i.matrixAutoUpdate=!1,this.threeDModel.add(s,i)}async addToScene(t,e,s,i,n){if(!this.threeDModel){const o=this.createStreetMesh(i),r=this.createSidewalkMesh(i),h=this.createSidewalkMesh(i);o.position.set(0,0,0),r.position.set(-8.4*this.SIZE/24,this.SIDEWALK_HEIGHT/2,0),h.position.set(8.4*this.SIZE/24,this.SIDEWALK_HEIGHT/2,0),this.threeDModel=new a.u,this.threeDModel.add(o).add(r).add(h);for(let t=0;t<4*i;t++)this.createBuildings(s,t);this.threeDModel.name=e,this.threeDModel.position.set(s[0],s[1],s[2]),this.threeDModel.rotateOnAxis(new a.Jb(0,1,0),n),o.scale.set(1,1,i),r.scale.set(1,1,i),h.scale.set(1,1,i),o.updateMatrix(),o.updateMatrixWorld(),o.matrixAutoUpdate=!1,r.updateMatrix(),r.updateMatrixWorld(),r.matrixAutoUpdate=!1,h.updateMatrix(),h.updateMatrixWorld(),h.matrixAutoUpdate=!1,this.threeDModel.updateMatrix(),this.threeDModel.updateMatrixWorld(),this.threeDModel.matrixAutoUpdate=!1,this.LONG=this.SIZE*i,t.add(this.threeDModel)}return this}}class Y extends g{constructor(t){super(t),this.pathToTexture=t,this.pathToNormalMap="textures/pavimento_map.png",this.SIZE=30,this.SIDEWALK_HEIGHT=.4,this.SQUARE_SIZE=8.87,this.observedState=null}animate(){null!=this.observedState&&(this.threeDModel.position.set(this.observedState.position.x,this.observedState.position.y,this.observedState.position.z),this.threeDModel.quaternion.set(this.observedState.rotation.x,this.observedState.rotation.y,this.observedState.rotation.z,this.observedState.rotation.w))}getLerpPoints(t,e,s){const i=[];for(let n=0;n<=s;n++)i.push(new a.Jb(t.x+(e.x-t.x)*n/s,t.y+(e.y-t.y)*n/s,t.z+(e.z-t.z)*n/s));return i}createSidewalkCurve(){let t=new a.Jb(-this.SQUARE_SIZE/2,0,-this.SQUARE_SIZE/2);const e=this.getLerpPoints(t,new a.Jb(-this.SQUARE_SIZE/2,0,this.SQUARE_SIZE/10),5),s=new a.ob(new a.Ib(-this.SQUARE_SIZE/2,this.SQUARE_SIZE/10),new a.Ib(-this.SQUARE_SIZE/2,this.SQUARE_SIZE/2),new a.Ib(-this.SQUARE_SIZE/10,this.SQUARE_SIZE/2)).getPoints(10);for(let r=0;r<s.length;r++)s[r]=new a.Jb(s[r].x,0,s[r].y);const i=this.getLerpPoints(new a.Jb(-this.SQUARE_SIZE/10,0,this.SQUARE_SIZE/2),new a.Jb(this.SQUARE_SIZE/2,0,this.SQUARE_SIZE/2),5),n=this.getLerpPoints(new a.Jb(this.SQUARE_SIZE/2,0,this.SQUARE_SIZE/2),new a.Jb(this.SQUARE_SIZE/2,0,-this.SQUARE_SIZE/2),5),o=this.getLerpPoints(new a.Jb(this.SQUARE_SIZE/2,0,-this.SQUARE_SIZE/2),new a.Jb(-this.SQUARE_SIZE/2,0,-this.SQUARE_SIZE/2),5);return[...e,...s,...i,...n,...o]}getGeometrySidewalk(){const t=new a.g,e=this.createSidewalkCurve(),s=e.length,i=[[],[],[]],n=[],o=[],r=[],h=[];let l=0,d=0;for(let a=0;a<e.length;a++)l+=e[a].x,d+=e[a].z;for(let a=0;a<e.length;a++)i[0].push(e[a].x,e[a].y,e[a].z),i[1].push(e[a].x,this.SIDEWALK_HEIGHT,e[a].z),i[2].push(l/e.length,this.SIDEWALK_HEIGHT,d/e.length),o.push(.03414,0),r.push((e[a].x+this.SQUARE_SIZE/2)/this.SQUARE_SIZE,(e[a].z+this.SQUARE_SIZE/2)/this.SQUARE_SIZE),h.push((l/e.length+this.SQUARE_SIZE/2)/this.SQUARE_SIZE,(d/e.length+this.SQUARE_SIZE/2)/this.SQUARE_SIZE);const c=[...o,...o,...r,...h],u=[...i[0],...i[1],...i[1],...i[2]];for(let a=0;a<3;a++)for(let t=1;t<s;t++)n.push(a*s+t-1),n.push((a+1)*s+t-1),n.push(a*s+t),n.push(a*s+t),n.push((a+1)*s+t-1),n.push((a+1)*s+t);const p=new Float32Array(u),b=new Float32Array(c);return t.setIndex(n),t.setAttribute("position",new a.f(p,3)),t.setAttribute("uv",new a.f(b,2)),t.computeVertexNormals(),t}createSidewalkMesh(){const t=(new a.Cb).load("textures/pavimento.jpg");t.repeat.set(3,3),t.wrapS=a.rb,t.wrapT=a.rb;const e=new a.W({map:t,side:a.n}),s=this.getGeometrySidewalk(),i=new a.T(s,e);return i.receiveShadow=!0,i.castShadow=!0,i}createStreetMesh(){const t=new a.e(this.SIZE,.1,this.SIZE),e=(new a.Cb).load(this.pathToTexture);e.repeat.set(2.4,2.4),e.wrapS=a.rb,e.wrapT=a.rb;const s=new a.W({map:e,side:a.n}),i=new a.T(t,s);return i.receiveShadow=!0,i}async addToScene(t,e,s){if(!this.threeDModel){const i=this.createStreetMesh();i.position.set(0,0,0),this.threeDModel=new a.u,this.threeDModel.add(i);for(let t=0;t<4;t++){const e=this.createSidewalkMesh();0===t?(e.position.set(-this.SIZE/2+this.SQUARE_SIZE/2,0,-this.SIZE/2+this.SQUARE_SIZE/2),e.rotateOnAxis(new a.Jb(0,1,0),Math.PI/2)):2===t?(e.position.set(-this.SIZE/2+this.SQUARE_SIZE/2,0,this.SIZE/2-this.SQUARE_SIZE/2),e.rotateOnAxis(new a.Jb(0,1,0),Math.PI)):3===t?e.position.set(this.SIZE/2-this.SQUARE_SIZE/2,0,-this.SIZE/2+this.SQUARE_SIZE/2):(e.position.set(this.SIZE/2-this.SQUARE_SIZE/2,0,this.SIZE/2-this.SQUARE_SIZE/2),e.rotateOnAxis(new a.Jb(0,1,0),-Math.PI/2)),e.updateMatrix(),e.updateMatrixWorld(),e.matrixAutoUpdate=!1,this.threeDModel.add(e)}this.threeDModel.name=e,this.threeDModel.receiveShadow=!0,this.threeDModel.position.set(s[0],s[1],s[2]),i.updateMatrix(),i.updateMatrixWorld(),i.matrixAutoUpdate=!1,this.threeDModel.updateMatrix(),this.threeDModel.updateMatrixWorld(),this.threeDModel.matrixAutoUpdate=!1,t.add(this.threeDModel)}return this}}class $ extends g{constructor(t){super(t),this.pathToTexture=t,this.pathToNormalMap="textures/pavimento_map.png",this.SIZE=30,this.SIDEWALK_HEIGHT=.4,this.SQUARE_SIZE=8.87,this.TOP_CENTER=[this.SIZE/2-this.SQUARE_SIZE,this.SIDEWALK_HEIGHT,-this.SIZE/2+this.SQUARE_SIZE],this.observedState=null}animate(){null!=this.observedState&&(this.threeDModel.position.set(this.observedState.position.x,this.observedState.position.y,this.observedState.position.z),this.threeDModel.quaternion.set(this.observedState.rotation.x,this.observedState.rotation.y,this.observedState.rotation.z,this.observedState.rotation.w))}getLerpPoints(t,e,s){const i=[];for(let n=0;n<=s;n++)i.push(new a.Jb(t.x+(e.x-t.x)*n/s,t.y+(e.y-t.y)*n/s,t.z+(e.z-t.z)*n/s));return i}createSidewalkCurve(){let t=new a.Jb(-this.SQUARE_SIZE/2,0,-this.SQUARE_SIZE/2);const e=this.getLerpPoints(t,new a.Jb(-this.SQUARE_SIZE/2,0,this.SQUARE_SIZE/10),5),s=new a.ob(new a.Ib(-this.SQUARE_SIZE/2,this.SQUARE_SIZE/10),new a.Ib(-this.SQUARE_SIZE/2,this.SQUARE_SIZE/2),new a.Ib(-this.SQUARE_SIZE/10,this.SQUARE_SIZE/2)).getPoints(10);for(let r=0;r<s.length;r++)s[r]=new a.Jb(s[r].x,0,s[r].y);const i=this.getLerpPoints(new a.Jb(-this.SQUARE_SIZE/10,0,this.SQUARE_SIZE/2),new a.Jb(this.SQUARE_SIZE/2,0,this.SQUARE_SIZE/2),5),n=this.getLerpPoints(new a.Jb(this.SQUARE_SIZE/2,0,this.SQUARE_SIZE/2),new a.Jb(this.SQUARE_SIZE/2,0,-this.SQUARE_SIZE/2),5),o=this.getLerpPoints(new a.Jb(this.SQUARE_SIZE/2,0,-this.SQUARE_SIZE/2),new a.Jb(-this.SQUARE_SIZE/2,0,-this.SQUARE_SIZE/2),5);return[...e,...s,...i,...n,...o]}createLongSidewalkCurve(){let t=new a.Jb(-this.SIZE/2,0,-this.SIZE/2);const e=this.getLerpPoints(t,new a.Jb(this.SIZE/2,0,-this.SIZE/2),5),s=this.getLerpPoints(new a.Jb(this.SIZE/2,0,-this.SIZE/2),new a.Jb(this.SIZE/2,0,this.SIZE/2),5),i=this.getLerpPoints(new a.Jb(this.SIZE/2,0,this.SIZE/2),new a.Jb(this.SIZE/2-this.SQUARE_SIZE,0,this.SIZE/2),5),n=this.getLerpPoints(new a.Jb(this.SIZE/2-this.SQUARE_SIZE,0,this.SIZE/2),new a.Jb(this.SIZE/2-this.SQUARE_SIZE,0,this.SIZE/2-this.SQUARE_SIZE),5);let o=new a.ob(new a.Ib(this.SIZE/2-this.SQUARE_SIZE,this.SIZE/2-this.SQUARE_SIZE),new a.Ib(this.SIZE/2-this.SQUARE_SIZE,-this.SIZE/2+this.SQUARE_SIZE),new a.Ib(-this.SIZE/2+this.SQUARE_SIZE,-this.SIZE/2+this.SQUARE_SIZE)).getPoints(30);for(let l=0;l<o.length;l++)o[l]=new a.Jb(o[l].x,0,o[l].y);const r=this.getLerpPoints(new a.Jb(-this.SIZE/2+this.SQUARE_SIZE,0,-this.SIZE/2+this.SQUARE_SIZE),new a.Jb(-this.SIZE/2,0,-this.SIZE/2+this.SQUARE_SIZE),5),h=this.getLerpPoints(new a.Jb(-this.SIZE/2,0,-this.SIZE/2+this.SQUARE_SIZE),new a.Jb(-this.SIZE/2,0,-this.SIZE/2),5);return[...e,...s,...i,...n,...o,...r,...h]}getGeometrySidewalk(){const t=new a.g,e=this.createSidewalkCurve(),s=e.length,i=[[],[],[]],n=[],o=[],r=[],h=[];for(let a=0;a<e.length;a++)i[0].push(e[a].x,e[a].y,e[a].z),i[1].push(e[a].x,this.SIDEWALK_HEIGHT,e[a].z),i[2].push(0/e.length,this.SIDEWALK_HEIGHT,0/e.length),o.push(.03414,0),r.push((e[a].x+this.SQUARE_SIZE/2)/this.SQUARE_SIZE,(e[a].z+this.SQUARE_SIZE/2)/this.SQUARE_SIZE),h.push((0/e.length+this.SQUARE_SIZE/2)/this.SQUARE_SIZE,(0/e.length+this.SQUARE_SIZE/2)/this.SQUARE_SIZE);const l=[...o,...o,...r,...h],d=[...i[0],...i[1],...i[1],...i[2]];for(let a=0;a<3;a++)for(let t=1;t<s;t++)n.push(a*s+t-1),n.push((a+1)*s+t-1),n.push(a*s+t),n.push(a*s+t),n.push((a+1)*s+t-1),n.push((a+1)*s+t);const c=new Float32Array(d),u=new Float32Array(l);return t.setIndex(n),t.setAttribute("position",new a.f(c,3)),t.setAttribute("uv",new a.f(u,2)),t.computeVertexNormals(),t}getGeometryLongSidewalk(){const t=new a.g,e=this.createLongSidewalkCurve(),s=e.length,i=[[],[],[]],n=[],o=[],r=[],h=[];for(let a=0;a<e.length;a++)i[0].push(e[a].x,e[a].y,e[a].z),i[1].push(e[a].x,this.SIDEWALK_HEIGHT,e[a].z),i[2].push(this.TOP_CENTER[0],this.TOP_CENTER[1],this.TOP_CENTER[2]),o.push(.03414,0),r.push((e[a].x+this.SIZE/2)/this.SIZE,(e[a].z+this.SIZE/2)/this.SIZE),h.push((this.TOP_CENTER[0]+this.SIZE/2)/this.SIZE,(this.TOP_CENTER[2]+this.SIZE/2)/this.SIZE);const l=[...o,...o,...r,...h],d=[...i[0],...i[1],...i[1],...i[2]];for(let a=0;a<3;a++)for(let t=1;t<s;t++)n.push(a*s+t-1),n.push((a+1)*s+t-1),n.push(a*s+t),n.push(a*s+t),n.push((a+1)*s+t-1),n.push((a+1)*s+t);const c=new Float32Array(d),u=new Float32Array(l);return t.setIndex(n),t.setAttribute("position",new a.f(c,3)),t.setAttribute("uv",new a.f(u,2)),t.computeVertexNormals(),t}createSidewalkMesh(){const t=(new a.Cb).load("textures/pavimento.jpg");t.repeat.set(3,3),t.wrapS=a.rb,t.wrapT=a.rb;const e=new a.W({map:t,side:a.n}),s=this.getGeometrySidewalk(),i=new a.T(s,e);return i.receiveShadow=!0,i.castShadow=!0,i}createLongSidewalkMesh(){const t=(new a.Cb).load("textures/pavimento.jpg");t.repeat.set(10,10),t.wrapS=a.rb,t.wrapT=a.rb;const e=new a.W({map:t,side:a.n}),s=this.getGeometryLongSidewalk(),i=new a.T(s,e);return i.receiveShadow=!0,i.castShadow=!0,i}async loadBuildingBlock(t){const e=await m.getInstance();return(await e[`building_${t}`]).clone()}async createBuildings(t,e){let s=await this.loadBuildingBlock(1+parseInt(4*Math.random()));s.name="buildingsCurve_"+e,s.position.x=10*this.SIZE/24,s.position.y=this.SIDEWALK_HEIGHT+.05,s.position.z=-this.SIZE/2+4+7.5*e,s.scale.x=.8,s.scale.y=1,s.scale.z=.6,s.rotateOnAxis(new a.Jb(0,1,0),-Math.PI/2),s.updateMatrix(),s.updateMatrixWorld(),s.matrixAutoUpdate=!1;let i=await this.loadBuildingBlock(1+parseInt(4*Math.random()));i.name="buildingsCurveOtherSide_"+e,i.position.x=-this.SIZE/2+4+7.5*e,i.position.y=this.SIDEWALK_HEIGHT+.05,i.position.z=10*this.SIZE/24,i.scale.x=.8,i.scale.y=1,i.scale.z=.6,i.rotateOnAxis(new a.Jb(0,1,0),Math.PI),i.updateMatrix(),i.updateMatrixWorld(),i.matrixAutoUpdate=!1,this.threeDModel.add(s,i)}createStreetMesh(){const t=new a.e(this.SIZE,.1,this.SIZE),e=(new a.Cb).load(this.pathToTexture);e.repeat.set(2.4,2.4),e.wrapS=a.rb,e.wrapT=a.rb;const s=new a.W({map:e,side:a.n}),i=new a.T(t,s);return i.receiveShadow=!0,i}async addToScene(t,e,s,i){if(!this.threeDModel){const n=this.createStreetMesh();n.position.set(0,0,0),this.threeDModel=new a.u,this.threeDModel.add(n);const o=this.createSidewalkMesh();o.position.set(-this.SIZE/2+this.SQUARE_SIZE/2,0,-this.SIZE/2+this.SQUARE_SIZE/2),o.rotateOnAxis(new a.Jb(0,1,0),Math.PI/2),o.updateMatrix(),o.updateMatrixWorld(),o.matrixAutoUpdate=!1;const r=this.createLongSidewalkMesh();r.position.set(0,0,0),r.rotateOnAxis(new a.Jb(0,1,0),-Math.PI/2),r.updateMatrix(),r.updateMatrixWorld(),r.matrixAutoUpdate=!1,this.threeDModel.add(o).add(r);for(let t=0;t<3;t++)this.createBuildings(s,t);this.threeDModel.name=e,this.threeDModel.receiveShadow=!0,this.threeDModel.position.set(s[0],s[1],s[2]),this.threeDModel.rotateOnAxis(new a.Jb(0,1,0),i),n.updateMatrix(),n.updateMatrixWorld(),n.matrixAutoUpdate=!1,this.threeDModel.updateMatrix(),this.threeDModel.updateMatrixWorld(),this.threeDModel.matrixAutoUpdate=!1,t.add(this.threeDModel)}return this}}class tt extends g{constructor(t){super(t),this.pathToTexture=t,this.pathToNormalMap="textures/pavimento_map.png",this.SIZE=30,this.SIDEWALK_HEIGHT=.4,this.SQUARE_SIZE=8.87,this.observedState=null}animate(){null!=this.observedState&&(this.threeDModel.position.set(this.observedState.position.x,this.observedState.position.y,this.observedState.position.z),this.threeDModel.quaternion.set(this.observedState.rotation.x,this.observedState.rotation.y,this.observedState.rotation.z,this.observedState.rotation.w))}getLerpPoints(t,e,s){const i=[];for(let n=0;n<=s;n++)i.push(new a.Jb(t.x+(e.x-t.x)*n/s,t.y+(e.y-t.y)*n/s,t.z+(e.z-t.z)*n/s));return i}createSidewalkCurve(){let t=new a.Jb(-this.SQUARE_SIZE/2,0,-this.SQUARE_SIZE/2);const e=this.getLerpPoints(t,new a.Jb(-this.SQUARE_SIZE/2,0,this.SQUARE_SIZE/10),5),s=new a.ob(new a.Ib(-this.SQUARE_SIZE/2,this.SQUARE_SIZE/10),new a.Ib(-this.SQUARE_SIZE/2,this.SQUARE_SIZE/2),new a.Ib(-this.SQUARE_SIZE/10,this.SQUARE_SIZE/2)).getPoints(10);for(let r=0;r<s.length;r++)s[r]=new a.Jb(s[r].x,0,s[r].y);const i=this.getLerpPoints(new a.Jb(-this.SQUARE_SIZE/10,0,this.SQUARE_SIZE/2),new a.Jb(this.SQUARE_SIZE/2,0,this.SQUARE_SIZE/2),5),n=this.getLerpPoints(new a.Jb(this.SQUARE_SIZE/2,0,this.SQUARE_SIZE/2),new a.Jb(this.SQUARE_SIZE/2,0,-this.SQUARE_SIZE/2),5),o=this.getLerpPoints(new a.Jb(this.SQUARE_SIZE/2,0,-this.SQUARE_SIZE/2),new a.Jb(-this.SQUARE_SIZE/2,0,-this.SQUARE_SIZE/2),5);return[...e,...s,...i,...n,...o]}getGeometrySidewalk(){const t=new a.g,e=this.createSidewalkCurve(),s=e.length,i=[[],[],[]],n=[],o=[],r=[],h=[];let l=0,d=0;for(let a=0;a<e.length;a++)l+=e[a].x,d+=e[a].z;for(let a=0;a<e.length;a++)i[0].push(e[a].x,e[a].y,e[a].z),i[1].push(e[a].x,this.SIDEWALK_HEIGHT,e[a].z),i[2].push(l/e.length,this.SIDEWALK_HEIGHT,d/e.length),o.push(.03414,0),r.push((e[a].x+this.SQUARE_SIZE/2)/this.SQUARE_SIZE,(e[a].z+this.SQUARE_SIZE/2)/this.SQUARE_SIZE),h.push((l/e.length+this.SQUARE_SIZE/2)/this.SQUARE_SIZE,(d/e.length+this.SQUARE_SIZE/2)/this.SQUARE_SIZE);const c=[...o,...o,...r,...h],u=[...i[0],...i[1],...i[1],...i[2]];for(let a=0;a<3;a++)for(let t=1;t<s;t++)n.push(a*s+t-1),n.push((a+1)*s+t-1),n.push(a*s+t),n.push(a*s+t),n.push((a+1)*s+t-1),n.push((a+1)*s+t);const p=new Float32Array(u),b=new Float32Array(c);return t.setIndex(n),t.setAttribute("position",new a.f(p,3)),t.setAttribute("uv",new a.f(b,2)),t.computeVertexNormals(),t}createSidewalkMesh(){const t=(new a.Cb).load("textures/pavimento.jpg");t.repeat.set(3,3),t.wrapS=a.rb,t.wrapT=a.rb;const e=new a.W({map:t,side:a.n}),s=this.getGeometrySidewalk(),i=new a.T(s,e);return i.receiveShadow=!0,i.castShadow=!0,i}async loadBuildingBlock(t){const e=await m.getInstance();return(await e[`building_${t}`]).clone()}async createBuilding(t,e){let s=await this.loadBuildingBlock(1+parseInt(4*Math.random()));s.name="buildingsRight_"+e,s.position.x=10*this.SIZE/24,s.position.y=this.SIDEWALK_HEIGHT+.05,s.position.z=-this.SIZE/2+4+7.5*e,s.scale.x=.8,s.scale.y=1,s.scale.z=.6,s.rotateOnAxis(new a.Jb(0,1,0),-Math.PI/2),s.updateMatrix(),s.updateMatrixWorld(),s.matrixAutoUpdate=!1,this.threeDModel.add(s)}createStraightSidewalkMesh(){const t=(new a.Cb).load("textures/pavimento.jpg");t.wrapS=a.rb,t.wrapT=a.rb,t.repeat.set(3,10);const e=new a.W({map:t,side:a.n}),s=new a.e(7*this.SIZE/24,this.SIDEWALK_HEIGHT,this.SIZE);return new a.T(s,e)}createStreetMesh(){const t=new a.e(this.SIZE,.1,this.SIZE),e=(new a.Cb).load(this.pathToTexture);e.repeat.set(2.4,2.4),e.wrapS=a.rb,e.wrapT=a.rb;const s=new a.W({map:e,side:a.n}),i=new a.T(t,s);return i.receiveShadow=!0,i}async addToScene(t,e,s,i){if(!this.threeDModel){const n=this.createStreetMesh();n.position.set(0,0,0),this.threeDModel=new a.u,this.threeDModel.add(n);for(let t=0;t<2;t++){const e=this.createSidewalkMesh();0===t?(e.position.set(-this.SIZE/2+this.SQUARE_SIZE/2,0,-this.SIZE/2+this.SQUARE_SIZE/2),e.rotateOnAxis(new a.Jb(0,1,0),Math.PI/2)):(e.position.set(-this.SIZE/2+this.SQUARE_SIZE/2,0,this.SIZE/2-this.SQUARE_SIZE/2),e.rotateOnAxis(new a.Jb(0,1,0),Math.PI)),e.updateMatrix(),e.updateMatrixWorld(),e.matrixAutoUpdate=!1,this.threeDModel.add(e)}for(let t=0;t<4;t++)this.createBuilding(s,t);const o=this.createStraightSidewalkMesh();o.position.set(8.4*this.SIZE/24,this.SIDEWALK_HEIGHT/2,0),o.updateMatrix(),o.updateMatrixWorld(),o.matrixAutoUpdate=!1,this.threeDModel.add(o),this.threeDModel.name=e,this.threeDModel.receiveShadow=!0,this.threeDModel.position.set(s[0],s[1],s[2]),this.threeDModel.rotateOnAxis(new a.Jb(0,1,0),i),n.updateMatrix(),n.updateMatrixWorld(),n.matrixAutoUpdate=!1,this.threeDModel.updateMatrix(),this.threeDModel.updateMatrixWorld(),this.threeDModel.matrixAutoUpdate=!1,t.add(this.threeDModel)}return this}}class et extends g{constructor(t){super(null),this.checkpointsData=t,this.RADIUS=1,this.HEIGHT=5,this.observedState=null,this.stepHeartbeat=-.002,this.LEAST_OPACITY=.25,this.MAX_OPACITY=.5}animate(){null!=this.observedState&&(this.threeDModel.position.set(this.observedState.position.x,this.observedState.position.y,this.observedState.position.z),this.threeDModel.quaternion.set(this.observedState.rotation.x,this.observedState.rotation.y,this.observedState.rotation.z,this.observedState.rotation.w));const t=this.threeDModel.children[0].material.opacity-this.stepHeartbeat;this.threeDModel.children[0].material.opacity=t,(t<=this.LEAST_OPACITY||t>=this.MAX_OPACITY)&&(this.stepHeartbeat*=-1)}async addToScene(t,e,s,i){if(!this.threeDModel){const n=new a.l(this.RADIUS,this.RADIUS,this.HEIGHT,32),o=new a.U({color:65280,opacity:.4,transparent:!0}),r=new a.T(n,o);r.position.set(0,0,0),this.threeDModel=new a.u,this.threeDModel.add(r),this.threeDModel.name=e,this.threeDModel.position.set(s[0],s[1],s[2]),this.threeDModel.scale.set(i[0],i[1],i[2]),this.RADIUS*=i[0],this.RADIUS*=i[0],this.HEIGHT*=i[1],t.add(this.threeDModel)}return this}}class st{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this.score=t}alterScore(t){if(isNaN(t))throw new Error("Solo se puede alterar el puntaje con n\xfameros.");this.score+=t}getCurrentScore(){return this.score}}class it{constructor(t,e){this.scene=t,this.physicsWorld=e,this.levelScore=new st(0),this.physicsToUpdate=[],this.objectsToAnimate=[],this.STREET_TYPES={STRAIGHT:this.createStreet.bind(this),CURVE:this.createCurve.bind(this),T_STREET:this.createTStreet.bind(this),INTERSECTION:this.createIntersection.bind(this)},this.OBJECTS={CONE:this.createCone.bind(this)}}updatePhysics(){this.physicsToUpdate.forEach((function(t){t.updatePhysics()}))}animate(){this.objectsToAnimate.forEach((function(t){t.animate()}))}async createRectangle(t,e,s,i,n,o,r){let h=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;const l=(new a.Cb).load(o);l.wrapS=a.rb,l.wrapT=a.rb,l.repeat.set(e,i);const d=new a.Y({map:l,side:a.n});if(h){let t=(new a.Cb).load(h);t.repeat.set(e,i),t.wrapS=a.rb,t.wrapT=a.rb,d.normalMap=t,d.normalScale.set(10,10)}const c=new a.e(e,s,i);c.rotateX(n);const u=new a.pb;u.setFromAxisAngle(new a.Jb(1,0,0),n);let p=new V(new a.Jb(t[0],t[1],t[2]),u,new r.btVector3(0,0,0),0,new a.Jb(e,s,i),this.physicsWorld,1e3);await p.buildAmmoPhysics();let b=new a.T(c,d);b.position.set(t[0],t[1],t[2]),this.scene.add(b)}async createCone(t,e,s){let i=new F("textures/coneTexture.jpg");i=await i.addToScene(this.scene,"trafficCone",t,[.5,1,.5]);let n=new X(new a.Jb(t[0],t[1],t[2]),(new a.pb).setFromAxisAngle(new a.Jb(0,1,0),s),new e.btVector3(0,0,0),10,new a.Jb(i.RADIUS_BOTTOM,i.HEIGHT/2,i.RADIUS_BOTTOM),this.physicsWorld,1e3);await n.buildAmmoPhysics(),n.rigidBody.threeObject=i,n.rigidBody.onCollide=()=>{this.levelScore.alterScore(-100),console.log("New score: ",this.levelScore.getCurrentScore())},this.physicsToUpdate.push(n),n.attachObserver(i),this.objectsToAnimate.push(i)}async buildStreetPhysics(t,e,s,i){let n=new V(new a.Jb(t[0],t[1],t[2]),(new a.pb).setFromAxisAngle(new a.Jb(0,1,0),i),new s.btVector3(0,0,0),0,new a.Jb(e.SIZE,.1,e.LONG),this.physicsWorld,1e3);await n.buildAmmoPhysics();const o=new a.Jb(-8.4*e.SIZE/24,e.SIDEWALK_HEIGHT/2,0).applyAxisAngle(new a.Jb(0,1,0),i);let r=new V(new a.Jb(t[0]+o.x,t[1]+o.y,t[2]+o.z),(new a.pb).setFromAxisAngle(new a.Jb(0,1,0),i),new s.btVector3(0,0,0),0,new a.Jb(7*e.SIZE/24,e.SIDEWALK_HEIGHT,e.LONG),this.physicsWorld,1e3);await r.buildAmmoPhysics();const h=new a.Jb(8.4*e.SIZE/24,e.SIDEWALK_HEIGHT/2,0).applyAxisAngle(new a.Jb(0,1,0),i);let l=new V(new a.Jb(t[0]+h.x,t[1]+e.SIDEWALK_HEIGHT/2+h.y,t[2]+h.z),(new a.pb).setFromAxisAngle(new a.Jb(0,1,0),i),new s.btVector3(0,0,0),0,new a.Jb(7*e.SIZE/24,e.SIDEWALK_HEIGHT,e.LONG),this.physicsWorld,1e3);await l.buildAmmoPhysics()}async buildTStreetPhysics(t,e,s,i){let n=new V(new a.Jb(t[0],t[1],t[2]),(new a.pb).identity(),new e.btVector3(0,0,0),0,new a.Jb(30,.1,30),this.physicsWorld,1e3);await n.buildAmmoPhysics();const o=new a.Jb(-s.SIZE/2+s.SQUARE_SIZE/2,0,-s.SIZE/2+s.SQUARE_SIZE/2).applyAxisAngle(new a.Jb(0,1,0),i),r=new K(new a.Jb(t[0]+o.x,t[1]+o.y,t[2]+o.z),(new a.pb).setFromAxisAngle(new a.Jb(0,1,0),Math.PI/2+i),new e.btVector3(0,0,0),0,s.getGeometrySidewalk(),this.physicsWorld,1e3);await r.buildAmmoPhysics();const h=new a.Jb(-s.SIZE/2+s.SQUARE_SIZE/2,0,s.SIZE/2-s.SQUARE_SIZE/2).applyAxisAngle(new a.Jb(0,1,0),i),l=new K(new a.Jb(t[0]+h.x,t[1]+h.y,t[2]+h.z),(new a.pb).setFromAxisAngle(new a.Jb(0,1,0),Math.PI+i),new e.btVector3(0,0,0),0,s.getGeometrySidewalk(),this.physicsWorld,1e3);await l.buildAmmoPhysics();const d=new a.Jb(8.4*s.SIZE/24,s.SIDEWALK_HEIGHT/2,0).applyAxisAngle(new a.Jb(0,1,0),i);let c=new V(new a.Jb(t[0]+d.x,t[1]+d.y,t[2]+d.z),(new a.pb).setFromAxisAngle(new a.Jb(0,1,0),i),new e.btVector3(0,0,0),0,new a.Jb(7*s.SIZE/24,s.SIDEWALK_HEIGHT,s.SIZE),this.physicsWorld,1e3);await c.buildAmmoPhysics()}async buildIntersectionPhysics(t,e,s){let i=new V(new a.Jb(t[0],t[1],t[2]),(new a.pb).identity(),new e.btVector3(0,0,0),0,new a.Jb(30,.1,30),this.physicsWorld,1e3);await i.buildAmmoPhysics();const n=new K(new a.Jb(t[0]-s.SIZE/2+s.SQUARE_SIZE/2,t[1],t[2]-s.SIZE/2+s.SQUARE_SIZE/2),(new a.pb).setFromAxisAngle(new a.Jb(0,1,0),Math.PI/2),new e.btVector3(0,0,0),0,s.getGeometrySidewalk(),this.physicsWorld,1e3);await n.buildAmmoPhysics();const o=new K(new a.Jb(t[0]-s.SIZE/2+s.SQUARE_SIZE/2,t[1],t[2]+s.SIZE/2-s.SQUARE_SIZE/2),(new a.pb).setFromAxisAngle(new a.Jb(0,1,0),Math.PI),new e.btVector3(0,0,0),0,s.getGeometrySidewalk(),this.physicsWorld,1e3);await o.buildAmmoPhysics();const r=new K(new a.Jb(t[0]+s.SIZE/2-s.SQUARE_SIZE/2,t[1],t[2]-s.SIZE/2+s.SQUARE_SIZE/2),(new a.pb).identity(),new e.btVector3(0,0,0),0,s.getGeometrySidewalk(),this.physicsWorld,1e3);await r.buildAmmoPhysics();const h=new K(new a.Jb(t[0]+s.SIZE/2-s.SQUARE_SIZE/2,t[1],t[2]+s.SIZE/2-s.SQUARE_SIZE/2),(new a.pb).setFromAxisAngle(new a.Jb(0,1,0),-Math.PI/2),new e.btVector3(0,0,0),0,s.getGeometrySidewalk(),this.physicsWorld,1e3);await h.buildAmmoPhysics()}async buildCurvePhysics(t,e,s,i){let n=new V(new a.Jb(t[0],t[1],t[2]),(new a.pb).setFromAxisAngle(new a.Jb(0,1,0),i),new e.btVector3(0,0,0),0,new a.Jb(30,.1,30),this.physicsWorld,1e3);await n.buildAmmoPhysics();const o=new a.Jb(-s.SIZE/2+s.SQUARE_SIZE/2,0,-s.SIZE/2+s.SQUARE_SIZE/2).applyAxisAngle(new a.Jb(0,1,0),i),r=new K(new a.Jb(t[0]+o.x,t[1]+o.y,t[2]+o.z),(new a.pb).setFromAxisAngle(new a.Jb(0,1,0),Math.PI/2+i),new e.btVector3(0,0,0),0,s.getGeometrySidewalk(),this.physicsWorld,1e3);await r.buildAmmoPhysics();const h=new K(new a.Jb(t[0],t[1],t[2]),(new a.pb).setFromAxisAngle(new a.Jb(0,1,0),-Math.PI/2+i),new e.btVector3(0,0,0),0,s.getGeometryLongSidewalk(),this.physicsWorld,1e3);await h.buildAmmoPhysics()}async createStreet(t,e,s,i){let n=new q("textures/road.jpg");await n.addToScene(this.scene,"street",t,i,s),await this.buildStreetPhysics(t,n,e,s)}async createIntersection(t,e){let s=new Y("textures/CleanRoadNoBorder.jpg");await s.addToScene(this.scene,"intersection",t),await this.buildIntersectionPhysics(t,e,s)}async createCurve(t,e,s){let i=new $("textures/CleanRoadNoBorder.jpg");await i.addToScene(this.scene,"curve",t,s),await this.buildCurvePhysics(t,e,i,s)}async createTStreet(t,e,s){let i=new tt("textures/CleanRoadNoBorder.jpg");await i.addToScene(this.scene,"tStreet",t,s),await this.buildTStreetPhysics(t,e,i,s)}async createCheckpoint(t,e){let s=new et(e),i=await C.getInstance();await s.addToScene(this.scene,"checkpoint",t,[1,1,1]);let n=new X(new a.Jb(t[0],t[1],t[2]),(new a.pb).identity(),new i.btVector3(0,0,0),1,new a.Jb(s.RADIUS,s.HEIGHT/2,s.RADIUS),this.physicsWorld,1e3);this.physicsToUpdate.push(n),await n.buildAmmoPhysics(),n.rigidBody.threeObject=s,n.rigidBody.onCollide=async()=>{this.physicsWorld.removeRigidBody(n.rigidyBody),this.physicsWorld.removeCollisionObject(n.rigidBody),this.levelScore.alterScore(1e3),console.log("New score: ",this.levelScore.getCurrentScore()),this.scene.remove(s.threeDModel);e.shift().end||e.length>0&&await this.createCheckpoint([e[0].position_x,1,e[0].position_y],e)},n.attachObserver(s),this.objectsToAnimate.push(s)}async createLevel0(){let t=await C.getInstance();this.createRectangle([10,0,10],10,2,10,-Math.PI/8,"textures/pavimento.jpg",t,"textures/pavimento_map.png"),this.createRectangle([-10,0,10],10,2,10,-Math.PI/4,"textures/pavimento.jpg",t,"textures/pavimento_map.png"),this.createRectangle([0,0,0],100,.1,100,0,"textures/pavimento.jpg",t,"textures/pavimento_map.png"),this.createCone([0,.5,10],t),this.createCone([0,.5,30],t),this.createCone([0,.5,20],t)}async instantiateStreet(t,e,s,i){let n=await C.getInstance(),o=(30===s[0]?s[1]:s[0])/30;await this.STREET_TYPES[i]([t[0],0,t[1]],n,e,o)}async instantiateObject(t,e,s){let i=await C.getInstance();await this.OBJECTS[s]([t[0],.5,t[1]],i,e)}async createLevelCustom(t){for(let e=0;e<t.streets.length;e++){let s=t.streets[e];await this.instantiateStreet([s.position_x,s.position_y],s.rotation,[s.long_x,s.long_y],s.type)}for(let e=0;e<t.objects.length;e++){let s=t.objects[e];await this.instantiateObject([s.position_x,s.position_y],s.rotation,s.type)}return t.checkpoints.length>0&&await this.createCheckpoint([t.checkpoints[0].position_x,1,t.checkpoints[0].position_y],t.checkpoints),{physicsToUpdate:this.physicsToUpdate,objectsToAnimate:this.objectsToAnimate}}}class nt{static createButton(t){const e=document.createElement("button");function s(){e.style.display="",e.style.cursor="auto",e.style.left="calc(50% - 75px)",e.style.width="150px",e.onmouseenter=null,e.onmouseleave=null,e.onclick=null}function i(t){t.style.position="absolute",t.style.bottom="20px",t.style.padding="12px 6px",t.style.border="1px solid #fff",t.style.borderRadius="4px",t.style.background="rgba(0,0,0,0.1)",t.style.color="#fff",t.style.font="normal 13px sans-serif",t.style.textAlign="center",t.style.opacity="0.5",t.style.outline="none",t.style.zIndex="999"}if("xr"in navigator)return e.id="VRButton",e.style.display="none",i(e),navigator.xr.isSessionSupported("immersive-vr").then((function(i){i?function(){let s=null;async function i(i){i.addEventListener("end",n),await t.xr.setSession(i),e.textContent="EXIT VR",s=i}function n(){s.removeEventListener("end",n),e.textContent="ENTER VR",s=null}e.style.display="",e.style.cursor="pointer",e.style.left="calc(50% - 50px)",e.style.width="100px",e.textContent="ENTER VR",e.onmouseenter=function(){e.style.opacity="1.0"},e.onmouseleave=function(){e.style.opacity="0.5"},e.onclick=function(){if(null===s){const t={optionalFeatures:["local-floor","bounded-floor","hand-tracking","layers"]};navigator.xr.requestSession("immersive-vr",t).then(i),localStorage.setItem("VR",!0)}else s.end()}}():(s(),e.textContent="VR NOT SUPPORTED"),i&&nt.xrSessionIsGranted&&e.click()})).catch((function(t){s(),console.warn("Exception when trying to call xr.isSessionSupported",t),e.textContent="VR NOT ALLOWED"})),e;{const t=document.createElement("a");return!1===window.isSecureContext?(t.href=document.location.href.replace(/^http:/,"https:"),t.innerHTML="WEBXR NEEDS HTTPS"):(t.href="https://immersiveweb.dev/",t.innerHTML="WEBXR NOT AVAILABLE"),t.style.left="calc(50% - 90px)",t.style.width="180px",t.style.textDecoration="none",i(t),t}}static registerSessionGrantedListener(){if("xr"in navigator){if(/WebXRViewer\//i.test(navigator.userAgent))return;navigator.xr.addEventListener("sessiongranted",(()=>{nt.xrSessionIsGranted=!0}))}}}nt.xrSessionIsGranted=!1,nt.registerSessionGrantedListener();var ot=s(180),rt=s.n(ot);class at extends h{constructor(t,e,s){super(),this.SIZE_OF_TRAFFIC=2,this.timeSinceLastUpdate=Date.now(),this.trafficWorker=new Worker("./workers/TrafficWorker.js"),this.currentTraffic={},this.scene=t,this.physicsWorld=e,this.levelStreets=s,this.lastID=0,this.trafficWorker.onmessage=t=>{this.onReceiveResponseFromWorker(t)}}async onReceiveResponseFromWorker(t){this.updateCarEngines(t.data)}async onCollideWithCarOfTraffic(){console.log("CHOCASTE AL AUTO")}async generateCar(){let t=new N(this.physicsWorld,[12,2,15+5*this.lastID],!1);await t.carPhysics.buildAmmoPhysics();let e=new v;return await e.addToScene(this.scene,`traffic_car_${this.lastID}`,!1),t.carPhysics.rigidBody.threeObject=e,t.carPhysics.rigidBody.onCollide=this.onCollideWithCarOfTraffic,t.attachObserver(e),t.notifyObservers(),this.currentTraffic[this.lastID]={object3D:e,engine:t},this.lastID+=1,e}deleteCar(t){this.currentTraffic[t].engine.removeObserver(this.currentTraffic[t].object3D),this.physicsWorld.removeRigidBody(this.currentTraffic[t].engine.carPhysics.rigidyBody),this.physicsWorld.removeCollisionObject(this.currentTraffic[t].engine.carPhysics.rigidyBody),this.scene.remove(this.currentTraffic[t].object3D.threeDModel),delete this.currentTraffic[t]}async generateInitialTraffic(){const t=[];for(let e=0;e<this.SIZE_OF_TRAFFIC;e++)t.push(await this.generateCar());return t}updateTraffic(){const t=[];Object.entries(this.currentTraffic).forEach((e=>{const[s,i]=e,n=i.engine.getDataToAnimate();n.carId=s,delete n.physicsBody,delete n.wheelsData,t.push(n)})),this.observedState&&(delete this.observedState.physicsBody,delete this.observedState.wheelsData),this.trafficWorker.postMessage({playersCar:this.observedState,streets:this.levelStreets,trafficCars:t})}updateCarEngines(t){Object.keys(t).forEach((e=>{t[e].deleteCar?this.deleteCar(e):(this.currentTraffic[e].engine.turnOnCar(),this.currentTraffic[e].engine.turnDirection(t[e].steering),this.currentTraffic[e].engine.changeShift(0,1),this.currentTraffic[e].engine.accelerate(1,t[e].accelerate),this.currentTraffic[e].engine.brake(0,t[e].brake),this.currentTraffic[e].engine.update())}))}animate(){this.updateTraffic(),Object.values(this.currentTraffic).forEach((t=>{t.object3D.animate()}))}}var ht=s(2);const lt=50;class dt extends i.Component{constructor(){super(),this.state={currentRPM:0,velocity:0,currentShift:0},this.physicsToUpdate=[],localStorage.setItem("VR",!1),this.gotAnyEvent=!1,this.stats=new rt.a,this.objectsToAnimate=[],this.scene=new a.tb,this.renderer=new a.Nb({alpha:!0,powerPreference:"high-performance",antialias:!0}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.shadowMap.enabled=!0,this.clock=new a.i}async componentDidMount(){this.jsonLevel=this.props.jsonLevel,this.generateGeneralElements=this.generateGeneralElements.bind(this),this.animation=this.animation.bind(this),this.handleWindowResize=this.handleWindowResize.bind(this),this.generateEvents=this.generateEvents.bind(this),this.addPlayerCar=this.addPlayerCar.bind(this),this.generateLevel=this.generateLevel.bind(this),this.addVR=this.addVR.bind(this),await this.generateGeneralElements(),await this.createAmmo(),await this.addGeneralLights(),await this.generateLevel(),await this.addPlayerCar(),this.jsonLevel["has-traffic"]&&await this.createTraffic(),this.generateEvents(),this.addVR(),this.renderer.setAnimationLoop(this.animation)}async addVR(){this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.xr.enabled=!0,this.renderer.xr.setFramebufferScaleFactor(.75),this.mount.appendChild(this.renderer.domElement),document.body.appendChild(nt.createButton(this.renderer))}async generateLevel(){this.level=new it(this.scene,this.physicsWorld);let t=await this.level.createLevelCustom(this.jsonLevel);this.objectsToAnimate=[...this.objectsToAnimate,...t.objectsToAnimate],this.physicsToUpdate=[...this.physicsToUpdate,...t.physicsToUpdate];const e=new a.e(1e4,1e4),s=(new a.Cb).load("./textures/pasto.jpeg");s.repeat.set(500,500),s.wrapS=a.rb,s.wrapT=a.rb;const i=new a.U({map:s}),n=new a.T(e,i);n.name="GREEN_FIELD",n.position.set(0,-1,0),n.rotateOnAxis(new a.Jb(1,0,0),Math.PI/2),this.scene.add(n)}async generateGeneralElements(){this.renderer.setClearColor(8900346,1),this.camera=new l(this.renderer),this.camera.addContainerToScene(this.scene),this.stats.showPanel(0),document.body.appendChild(this.stats.dom)}async addGeneralLights(){this.scene.add(new a.a(16777215,.5))}async addPlayerCar(){this.carLogic=new N(this.physicsWorld,[this.jsonLevel.initial_position[0],1,this.jsonLevel.initial_position[1]],!0,(new a.pb).setFromAxisAngle(new a.Jb(0,1,0),this.jsonLevel.initial_rotation)),await this.carLogic.carPhysics.buildAmmoPhysics();let t=new v;this.carLogic.carPhysics.rigidBody.threeObject=t,this.carLogic.attachObserver(t),this.carLogic.attachObserver(this.camera),this.objectsToAnimate.push(await t.addToScene(this.scene)),this.carLogic.notifyObservers()}async createTraffic(){this.trafficModel=new at(this.scene,this.physicsWorld,this.jsonLevel.streets),this.carLogic.attachObserver(this.trafficModel),await this.trafficModel.generateInitialTraffic()}generateEvents(){window.addEventListener("resize",this.handleWindowResize),window.addEventListener("gamepaddisconnected",(function(t){R.removeInstance()})),document.addEventListener("keydown",(t=>{var e=t.key;switch(this.carLogic.removeObserver(this.camera),e){case"1":this.camera=new l(this.renderer),this.camera.addContainerToScene(this.scene);break;case"2":this.camera=new u(this.renderer);break;case"3":this.camera=new d(new a.Jb(-4.35,.6,-.1));break;case"4":this.camera=new d(new a.Jb(4.35,.6,-.1));break;case"5":this.camera=new d(new a.Jb(0,3,-5))}this.carLogic.attachObserver(this.camera),this.carLogic.notifyObservers()}),!1)}async createAmmo(){let t=await C.getInstance();this.tempTransform=new t.btTransform;let e=new t.btDefaultCollisionConfiguration,s=new t.btCollisionDispatcher(e),i=new t.btDbvtBroadphase,n=new t.btSequentialImpulseConstraintSolver;this.physicsWorld=new t.btDiscreteDynamicsWorld(s,i,n,e),this.physicsWorld.setGravity(new t.btVector3(0,-9.8,0));const o=t.addFunction((async(t,e,s)=>{let i=await C.getInstance();if(e=i.castObject(i.wrapPointer(e,i.btRigidBody),i.btRigidBody),s=i.castObject(i.wrapPointer(s,i.btRigidBody),i.btRigidBody),e.threeObject&&s.threeObject&&("driverCar"===e.threeObject.threeDModel.name||"driverCar"===s.threeObject.threeDModel.name)){if(0===(t=i.wrapPointer(t,i.btManifoldPoint)).get_m_userPersistentData()){e.onCollide?e.onCollide():s.onCollide();const i=1;t.set_m_userPersistentData(i)}}}));this.physicsWorld.setContactProcessedCallback(o)}handleWindowResize(){this.camera.handleResize(),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.render(this.scene,this.camera.getCameraInstance())}vecDistance(t,e){return t.distanceTo(e)}getMaxSizeStreets(){let t=0,e=0;for(let s=0;s<this.jsonLevel.streets.length;s++){const i=this.jsonLevel.streets[s];t<i.position_x+i.long_x/2&&(t=i.position_x+i.long_x/2),e<i.position_y+i.long_y/2&&(e=i.position_y+i.long_y/2)}return[t,e]}generateSegmentedScenesChildren(){const[t,e]=this.getMaxSizeStreets();this.segmentedScenes=[];for(let s=0;s<parseInt(t/lt)+1;s++){this.segmentedScenes.push([]);for(let t=0;t<parseInt(e/lt)+1;t++){const e=new a.Jb(s*lt,0,t*lt);this.segmentedScenes[s].push(this.scene.children.filter((t=>t.isLight||"GREEN_FIELD"===t.name||t.name.includes("traffic_car")||"driverCar"===t.name||this.vecDistance(t.position,e)<=200)))}}}getReducedScene(){const t=new a.tb;return 0===this.segmentedScenes.length&&this.generateSegmentedScenesChildren(),t.children=this.segmentedScenes[parseInt(this.lastPlayerPos.x/lt)][parseInt(this.lastPlayerPos.z/lt)],t}animation(){this.stats.begin();let t=this.clock.getDelta();this.physicsWorld.stepSimulation(t,10),this.jsonLevel["has-traffic"]&&this.trafficModel.animate(),this.objectsToAnimate.forEach((function(t){t.animate()})),this.physicsToUpdate.forEach((function(t){t.updatePhysics()})),this.camera.setPositionRelativeToObject(),T.getInstance(this.carLogic).checkEvents(),this.setState({velocity:this.carLogic.getSpeed(),currentRPM:this.carLogic.getCurrentRPM(),currentShift:this.carLogic.getCurrentShift()}),this.renderer.render(this.scene,this.camera.getCameraInstance()),this.stats.end()}render(){return Object(ht.jsxs)("div",{style:{width:"100vw"},children:[Object(ht.jsx)("div",{style:{position:"absolute",top:"10px",right:"10px",color:"red",width:"175px"},id:"Acelerador",children:Object(ht.jsxs)("p",{style:{zIndex:20,display:"float",fontWeight:"bold"},children:["Cambio Actual: ",parseInt(this.state.currentShift)]})}),Object(ht.jsx)("div",{ref:t=>{this.mount=t}})]})}}var ct=s(9);const ut={width:"100vw",height:"100vh",backgroundImage:'url("DrivingSimMenuNoTitle.png")',backgroundSize:"cover",backgroundRepeat:"no-repeat"},pt=()=>{const t=Object(ct.n)();return Object(ht.jsx)(ht.Fragment,{children:Object(ht.jsx)("div",{style:ut,children:Object(ht.jsxs)("div",{id:"button-box",style:{position:"absolute",top:"5%",right:"5%"},children:[Object(ht.jsx)("div",{className:"MainMenuTitle",children:Object(ht.jsxs)("h1",{style:{textAlign:"center",fontSize:"7rem"},children:["Driving",Object(ht.jsx)("br",{}),"Simulator"]})}),Object(ht.jsx)("div",{className:"buttonWrapperMainMenu",children:Object(ht.jsx)("button",{className:"buttonMainMenu",onClick:()=>t("/scene"),children:"Iniciar"})}),Object(ht.jsx)("div",{className:"buttonWrapperMainMenu",children:Object(ht.jsx)("button",{className:"buttonMainMenu",onClick:()=>t("/level-editor"),children:"Editor de Niveles"})}),Object(ht.jsx)("div",{className:"buttonWrapperMainMenu",children:Object(ht.jsx)("button",{className:"buttonMainMenu",onClick:()=>t("/configs"),children:"Configuraci\xf3n"})})]})})})};var bt=s(380),gt=s(374),St=s(5),wt=s(375),mt=s(379),Et=s(185),ft=s.n(Et);const xt=t=>{let{openConfigs:e,handleDrawerClose:s}=t;const[i,o]=n.a.useState(!1);n.a.useEffect((()=>{o(e)}),[e]);const r=Object(St.a)("div")((t=>{let{theme:e}=t;return{display:"flex",alignItems:"center",width:"100%",padding:e.spacing(0,1),...e.mixins.toolbar,justifyContent:"flex-start"}}));return Object(ht.jsx)(ht.Fragment,{children:Object(ht.jsx)(gt.a,{children:Object(ht.jsxs)(wt.a,{sx:{width:window.innerWidth/6,flexShrink:0,"& .MuiDrawer-paper":{width:window.innerWidth/6,boxSizing:"border-box"}},variant:"persistent",anchor:"right",open:i,children:[Object(ht.jsxs)(r,{className:"drawer-header",onClick:s,children:[Object(ht.jsx)(ft.a,{}),Object(ht.jsx)("div",{style:{width:"100%"},children:Object(ht.jsx)("h3",{style:{textAlign:"right",paddingRight:30},children:"Configurations"})})]}),Object(ht.jsx)(mt.a,{})]})})})};var yt=s(186),vt=s.n(yt);const It=Object(i.createContext)(),At={cone:null,trapecio:null,street:null},Rt=t=>{let{openItems:e,handleDrawerClose:s}=t;const[i,o]=n.a.useState(!1),{setLastSelectedItem:r,lastSelectedItem:a}=n.a.useContext(It);n.a.useEffect((()=>{o(e)}),[e]);const h=Object(St.a)("div")((t=>{let{theme:e}=t;return{display:"flex",alignItems:"center",padding:e.spacing(0,1),...e.mixins.toolbar,justifyContent:"flex-end"}})),[l,d]=n.a.useState(At);return Object(ht.jsx)(ht.Fragment,{children:Object(ht.jsx)(gt.a,{children:Object(ht.jsxs)(wt.a,{sx:{width:window.innerWidth/6,flexShrink:0,"& .MuiDrawer-paper":{width:window.innerWidth/6,boxSizing:"border-box"}},variant:"persistent",anchor:"left",open:i,children:[Object(ht.jsxs)(h,{onClick:s,className:"drawer-header",children:[Object(ht.jsx)("div",{style:{width:"100%"},children:Object(ht.jsx)("h3",{style:{textAlign:"left",paddingLeft:10},children:"Items"})}),Object(ht.jsx)(vt.a,{})]}),Object(ht.jsx)(mt.a,{}),Object(ht.jsx)(gt.a,{style:{justifyContent:"center",display:"flex",alignItems:"center",flexDirection:"column"},children:Object.entries(l).map((t=>{let[e,s]=t;return Object(ht.jsx)("img",{alt:`${e}`,src:`${e}.png`,width:75,height:75,className:`imageLevelEditor ${s}`,onClick:()=>(t=>{const e={...At};e[t]="selected",d(e),r({selectedItem:t,scale:1,positionX:0,positionY:0,zIndex:a?a.zIndex+1:1})})(e)},e)}))})]})})})};var Pt=s(189),jt=s.n(Pt),Mt=s(188),Tt=s.n(Mt),Ot=s(377);const Dt=t=>{let{setGridDimensions:e,gridDimensions:s}=t;const[n,o]=Object(i.useState)(s.width),[r,a]=Object(i.useState)(s.height);return Object(ht.jsxs)(gt.a,{container:!0,direction:"row",width:"80%",marginLeft:"10%",justifyContent:"space-evenly",alignItems:"center",spacing:2,children:[Object(ht.jsxs)(gt.a,{item:!0,xs:2,children:[Object(ht.jsx)("p",{children:"Ancho:"}),Object(ht.jsx)("input",{value:n,type:"number",step:"1",onChange:t=>{let e=parseInt(t.target.value.replaceAll(",","").replaceAll(".",""));o(e>40?40:e)}})]}),Object(ht.jsx)(gt.a,{item:!0,xs:2,children:Object(ht.jsxs)("div",{children:[Object(ht.jsx)("p",{children:"Alto:"}),Object(ht.jsx)("input",{value:r,type:"number",step:"1",onChange:t=>{let e=parseInt(t.target.value.replaceAll(",","").replaceAll(".",""));a(e>40?40:e)}})]})}),Object(ht.jsx)(gt.a,{item:!0,xs:2,children:Object(ht.jsx)(Ot.a,{variant:"contained",onClick:()=>{e({width:n,height:r})},children:"Actualizar"})})]})};var _t=s(187),Ct=s.n(_t);const Lt=30;class Zt{constructor(t,e,s){const i=t[1][2].filled,n=t[0][1].filled,o=t[2][1].filled,r=t[1][0].filled;this.rotation=this.determineStreetRotation(n,r,o,i),this.long=[Lt,Lt],this.position=[e*Lt+15,s*Lt+15]}static isValidNinePerNineGrid(t){}static sumValueForCell(t){return t.filled?1:0}static calculateNeighboursFilled(t){let e=0,s=0;return e+=Zt.sumValueForCell(t[1][0])+Zt.sumValueForCell(t[1][2]),s+=Zt.sumValueForCell(t[0][1])+Zt.sumValueForCell(t[2][1]),[e,s]}isStraight(){return!1}determineStreetRotation(){}getAsJSON(){return{position_x:this.position[0],position_y:this.position[1],rotation:this.rotation,long_x:this.long[0],long_y:this.long[1]}}getPositionAsRowAndColumn(){return[(this.position[0]-15)/Lt,(this.position[1]-15)/Lt]}getPositionX(){return this.position[0]}getPositionY(){return this.position[1]}getLongX(){return this.long[0]}getLongY(){return this.long[1]}}const Ut={TOP_TO_LEFT:3*Math.PI/2,LEFT_TO_BOT:0,BOT_TO_RIGHT:Math.PI/2,RIGHT_TO_TOP:Math.PI};const Wt={HORIZONTAL:0,VERTICAL:Math.PI/2};const Ht={TOP_SINGLE:Math.PI,LEFT_SINGLE:3*Math.PI/2,BOT_SINGLE:0,RIGHT_SINGLE:Math.PI/2};class Bt{constructor(t){this.sections=this.segregateSections(t),this.sectionsAsJSON=this.linkSections()}segregateSections(t){const e={},s={};let i=[];for(let n=0;n<t.length;n++){let[i,o]=t[n].getPositionAsRowAndColumn();t[n].isHorizontal()?(i in e||(e[i]=[]),e[i].push({idx:o,street:t[n]})):(o in s||(s[o]=[]),s[o].push({idx:i,street:t[n]}))}for(const[,n]of Object.entries(e))i=[...i,...this.generateArraySubsections(n)];for(const[,n]of Object.entries(s))i=[...i,...this.generateArraySubsections(n)];return i}generateArraySubsections(t){const e=[];for(let s=0;s<t.length;s++)0===s||Math.abs(t[s].idx-t[s-1].idx)>1?e.push([t[s].street]):e[e.length-1].push(t[s].street);return e}linkSections(){const t=[];for(let e=0;e<this.sections.length;e++){const s={position_x:this.sections[e].reduce(((t,e)=>t+e.getPositionX()),0)/this.sections[e].length,position_y:this.sections[e].reduce(((t,e)=>t+e.getPositionY()),0)/this.sections[e].length,rotation:this.sections[e][0].rotation,long_x:this.sections[e][0].isHorizontal()?this.sections[e].reduce(((t,e)=>t+e.getLongX()),0):this.sections[e][0].getLongX(),long_y:this.sections[e][0].isHorizontal()?this.sections[e][0].getLongY():this.sections[e].reduce(((t,e)=>t+e.getLongY()),0),type:"STRAIGHT"};t.push(s)}return t}getSectionsAsJSON(){return this.sectionsAsJSON}}const Jt=[class extends Zt{static isValidNinePerNineGrid(t){let[e,s]=Zt.calculateNeighboursFilled(t);return 2===s&&0===e||0===s&&2===e}determineStreetRotation(t,e,s,i){return t&&s?Wt.VERTICAL:e&&i?Wt.HORIZONTAL:void 0}isStraight(){return!0}getAsJSON(){let t=super.getAsJSON();return t.type="STRAIGHT",t}isHorizontal(){return this.rotation===Wt.HORIZONTAL}},class extends Zt{static isValidNinePerNineGrid(t){let[e,s]=Zt.calculateNeighboursFilled(t);return 1===e&&1===s}determineStreetRotation(t,e,s,i){return t&&e?Ut.TOP_TO_LEFT:e&&s?Ut.LEFT_TO_BOT:s&&i?Ut.BOT_TO_RIGHT:i&&t?Ut.RIGHT_TO_TOP:void 0}getAsJSON(){let t=super.getAsJSON();return t.type="CURVE",t}},class extends Zt{static isValidNinePerNineGrid(t){let[e,s]=Zt.calculateNeighboursFilled(t);return 2===s&&1===e||1===s&&2===e}determineStreetRotation(t,e,s,i){return t&&e&&i?Ht.TOP_SINGLE:e&&s&&t?Ht.LEFT_SINGLE:s&&i&&e?Ht.BOT_SINGLE:i&&t&&s?Ht.RIGHT_SINGLE:void 0}getAsJSON(){let t=super.getAsJSON();return t.type="T_STREET",t}},class extends Zt{static isValidNinePerNineGrid(t){let[e,s]=Zt.calculateNeighboursFilled(t);return 2===s&&2===e}determineStreetRotation(){return 0}getAsJSON(){let t=super.getAsJSON();return t.type="INTERSECTION",t}}];class Gt{constructor(t,e){this.levelGrid=t,this.getNinePerNineGrid=e?this.getNinePerNineGridInfinite:this.getNinePerNineGridFinite}constructStreets(){const t=[],e=[];for(let i=0;i<this.levelGrid.length;i++)for(let s=0;s<this.levelGrid[i].length;s++){if(this.levelGrid[i][s].filled){const n=this.defineTypeOfStreet(i,s);n.isStraight()?t.push(n):e.push(n)}}const s=this.linkStraightStreets(t);return[...e.map((t=>t.getAsJSON())),...s]}getNinePerNineGridInfinite(t,e){const s=[];for(let i=t-1;i<=t+1;i++){const t=[],n=i<0?this.levelGrid.length-1:i%this.levelGrid.length;for(let s=e-1;s<=e+1;s++){const e=s<0?this.levelGrid[n].length-1:s%this.levelGrid[n].length;t.push(this.levelGrid[n][e])}s.push(t)}return s}getNinePerNineGridFinite(t,e){const s=[],i={filled:!1};for(let n=t-1;n<=t+1;n++)if(n<0||n===this.levelGrid.length)s.push([i,i,i]);else{const t=[];for(let s=e-1;s<=e+1;s++)s<0||s===this.levelGrid[n].length?t.push(i):t.push(this.levelGrid[n][s]);s.push(t)}return s}defineTypeOfStreet(t,e){const s=this.getNinePerNineGrid(t,e);let i,n=!1;for(let o=0;o<Jt.length&&!n;o++)n=Jt[o].isValidNinePerNineGrid(s),i=Jt[o];if(!n)throw new Error("No se pudo definir el tipo de calle dentro de los tipos validos.");return new i(s,this.levelGrid.length-1-t,e)}linkStraightStreets(t){return new Bt(t).getSectionsAsJSON()}}function kt(t,e,s){let i=0;for(let n=e-1;n<=e+1&&n<t.length;n++)n>=0&&n!==e&&(i+=t[n][s].filled?1:0);for(let n=s-1;n<=s+1&&n<t[e].length;n++)n>=0&&n!==s&&(i+=t[e][n].filled?1:0);return i}function Qt(t,e){return e?void 0:function(t){let e=!0,s=[];for(let i=0;i<t.length;i++)for(let n=0;n<t[i].length;n++)t[i][n].filled&&kt(t,i,n)<=1&&(e=!1,s.push([i,n]));return{valid:e,wrongCells:s}}(t)}const Nt="darkgray",zt="white",Vt="orange",Ft=t=>{let{gridDimensions:e}=t;const[s,n]=Object(i.useState)([]),[o,r]=Object(i.useState)(!1),[a,h]=Object(i.useState)(!1);Object(i.useEffect)((()=>{let t=[];for(let s=0;s<e.height;s++){let s=[];for(let t=0;t<e.width;t++){let t={filled:!1,div_color:zt};s.push(t)}t.push(s)}n(t)}),[e.width,e.height]),Object(i.useEffect)((()=>{window.addEventListener("mouseup",(t=>{t.preventDefault(),0===t.button?r(!1):2===t.button&&h(!1)})),window.addEventListener("contextmenu",(t=>{t.preventDefault()}))}),[]);const l=(t,e)=>{if(!e||!t)return!1;for(let i=0;i<t.length;i++){let n=!0;for(let o=0;o<t[i].length;o++)try{t[i][o]!==e[o]&&(n=!1)}catch(s){o=t[i].length,n=!1}if(n)return!0}return!1};return Object(ht.jsxs)("div",{style:{width:600,height:600,marginTop:25,marginLeft:"auto",marginRight:"auto"},onMouseDown:t=>{t.preventDefault(),0===t.button?r(!0):2===t.button&&h(!0)},children:[s.map(((t,i)=>Object(ht.jsx)("div",{className:"row-level-grid",id:`row_${i}`,style:{width:"100%",height:600/e.height,display:"flex",flexDirection:"row"},children:t.map(((t,r)=>Object(ht.jsx)("div",{className:"cell-level-grid",id:`cell_${i}_${r}`,style:{backgroundColor:t.div_color,width:100/e.width+"%",height:"100%",border:"1px solid black"},onMouseMove:t=>{t.preventDefault(),((t,e)=>{if(o){const i=[...s];i[t][e].filled=!0,i[t][e].div_color=Nt,n(i)}else if(a){const i=[...s];i[t][e].filled=!1,i[t][e].div_color=zt,n(i)}})(i,r)},onMouseUp:t=>{((t,e,i)=>{if(0===i){const i=[...s];i[t][e].filled=!0,i[t][e].div_color=Nt,n(i)}else if(2===i){const i=[...s];i[t][e].filled=!1,i[t][e].div_color=zt,n(i)}})(i,r,t.button)}},`cell_${i}_${r}`)))},`row_${i}`))),Object(ht.jsx)("div",{style:{display:"flex",justifyContent:"center",marginTop:40},children:Object(ht.jsxs)(Ot.a,{variant:"contained",onClick:()=>{let t=Qt(s),e=[...s];for(let i=0;i<s.length;i++)for(let n=0;n<s[i].length;n++)e[i][n].filled&&(e[i][n].div_color=l(t.wrongCells,[i,n])?Vt:Nt);n(e),t.valid&&function(t,e){var s="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(t)),i=document.createElement("a");i.setAttribute("href",s),i.setAttribute("download",e+".json"),document.body.appendChild(i),i.click(),i.remove()}(function(t){return{streets:new Gt(t).constructStreets()}}(s),"Driving_Simulator_Custom_Level.json")},color:"success",children:[Object(ht.jsx)(Ct.a,{})," Procesar nivel..."]})})]})},Xt=()=>{const[t,e]=Object(i.useState)(!1),[s,o]=Object(i.useState)(!1),[r,a]=Object(i.useState)([]),[h,l]=Object(i.useState)(null),[d,c]=Object(i.useState)({width:20,height:20});return n.a.useEffect((()=>{null!==h&&a((t=>[...t,h]))}),[h]),Object(ht.jsx)(ht.Fragment,{children:Object(ht.jsxs)(It.Provider,{value:{lastSelectedItem:h,setLastSelectedItem:l},children:[Object(ht.jsxs)("div",{children:[Object(ht.jsxs)("div",{style:{flexDirection:"row",justifyContent:"space-between",display:"flex"},children:[Object(ht.jsx)(bt.a,{onClick:()=>e(!0),style:{height:40,margin:10},className:"header",children:Object(ht.jsx)(Tt.a,{})}),Object(ht.jsx)("h1",{children:"Driving Simulator - Level Editor"}),Object(ht.jsx)(bt.a,{onClick:()=>o(!0),style:{height:40,margin:10},className:"header",children:Object(ht.jsx)(jt.a,{})})]}),Object(ht.jsxs)("div",{children:[Object(ht.jsx)(Dt,{setGridDimensions:c,gridDimensions:d}),Object(ht.jsx)(Ft,{gridDimensions:d}),r.map(((t,e)=>Object(ht.jsx)("span",{},e)))]})]}),Object(ht.jsx)(Rt,{openItems:t,handleDrawerClose:()=>{e(!1)}}),Object(ht.jsx)(xt,{openConfigs:s,handleDrawerClose:()=>{o(!1)}})]})})};var Kt=s(42);const qt="http://localhost:8001",Yt=/^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/,$t=Object(i.createContext)(void 0);var te=s(371),ee=s(368),se=s(381),ie=s(83),ne=s(366),oe=s(367);const{createHash:re}=s(221),ae=t=>re("sha256").update(t).digest("hex"),he=()=>{const t=Object(ct.n)(),[e,s]=n.a.useState(""),[o,r]=n.a.useState(""),[a,h]=n.a.useState(!1),[l,d]=n.a.useState(void 0),{setSessionWithResponse:c}=(()=>{const{session:t,setSession:e}=Object(i.useContext)($t);return{setSessionWithResponse:t=>{e({user:t.user,jwt:t.jwt})},getUser:()=>t.user?t.user:void 0,getJWT:()=>t.jwt?t.jwt:void 0}})(),u=async t=>{try{const e=await(async t=>{const e=await fetch(`${qt}/users/login_google`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:t})});if(200!==e.status){const t=await e.json(),s=t.detail[0].msg?t.detail[0].msg:t.detail;let i=e.status+" - "+e.statusText+" - "+s;throw new Error(i)}return e.json()})(t);c(e)}catch(e){d([e.toString().replaceAll("Error: ","")])}};return Object(ht.jsx)("form",{onSubmit:async s=>{if(s.preventDefault(),(()=>{const t=[];return""===o&&t.push("El campo contrase\xf1a se encuentra vac\xedo."),""===e&&t.push("El campo email se encuentra vac\xedo"),e.match(Yt)||t.push("El email establecido es inv\xe1lido."),!(t.length>0)||(d(t),!1)})())try{const s=await(async()=>{try{const t=await fetch(`${qt}/users/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:ae(o)})});if(200!==t.status){const e=await t.json(),s=e.detail[0].msg?e.detail[0].msg:e.detail;let i=t.status+" - "+t.statusText+" - "+s;throw new Error(i)}return t.json()}catch(t){throw new Error(t)}})();c(s),t("/")}catch(i){d([i.toString().replaceAll("Error: ","")])}},children:Object(ht.jsxs)("div",{style:{display:"flex",justifyContent:"center",alignContent:"center",flexDirection:"column",textAlign:"center",margin:"auto",marginTop:40,padding:30,border:"2px solid black",borderRadius:20,maxWidth:400},children:[l&&Object(ht.jsxs)(te.a,{severity:"error",style:{textAlign:"justify"},onClose:()=>d(void 0),children:["Han ocurrido los siguientes errores:",Object(ht.jsx)("ul",{children:l.map(((t,e)=>Object(ht.jsx)("li",{children:t},e)))})]}),Object(ht.jsx)("h1",{children:"Iniciar Sesi\xf3n"}),Object(ht.jsx)("div",{style:{display:"flex",justifyContent:"center"},children:Object(ht.jsx)("img",{src:"logo_transp.png",width:"25%",alt:"Driving Simulator Logo"})}),Object(ht.jsx)("div",{style:{marginTop:20},children:Object(ht.jsx)(ee.a,{style:{width:"80%"},type:"text",onChange:t=>s(t.target.value),value:e,name:"email",label:"E-Mail"})}),Object(ht.jsx)("div",{style:{marginTop:20},children:Object(ht.jsx)(ee.a,{style:{width:"80%"},type:a?"text":"password",onChange:t=>r(t.target.value),value:o,name:"password",label:"Contrase\xf1a",InputProps:{endAdornment:Object(ht.jsx)(se.a,{position:"end",children:Object(ht.jsx)(bt.a,{"aria-label":"toggle password visibility",onClick:()=>h(!a),children:a?Object(ht.jsx)(ne.a,{}):Object(ht.jsx)(oe.a,{})})})}})}),Object(ht.jsx)("div",{style:{marginTop:20},children:Object(ht.jsx)(Ot.a,{variant:"contained",type:"submit",children:"Iniciar Sesi\xf3n"})}),Object(ht.jsx)("div",{style:{marginTop:20},children:Object(ht.jsx)(Kt.b,{to:"/signup",children:"\xbfNo posees una cuenta? Registrate aqu\xed..."})}),Object(ht.jsx)("div",{style:{marginTop:20,display:"flex",justifyContent:"center",textAlign:"center",alignContent:"center"},children:Object(ht.jsx)(ie.a,{onSuccess:t=>{const e=t.credential;u(e)},onError:()=>{d(["El inicio de sesi\xf3n con Google ha fallado."])}})})]})})},le=()=>{const[t,e]=n.a.useState(""),[s,i]=n.a.useState(""),[o,r]=n.a.useState(""),[a,h]=n.a.useState(""),[l,d]=n.a.useState(!1),[c,u]=n.a.useState(void 0);return Object(ht.jsx)("form",{onSubmit:async e=>{if(e.preventDefault(),!(()=>{const e=[];return""!==t&&""!==s&&""!==o&&""!==a||e.push("A\xfan existen campos sin completar."),s!==o&&e.push("Las contrase\xf1as establecidas no coinciden."),s.length<8&&e.push("La contrase\xf1a debe tener una longitud m\xednima de 8 caracteres."),t.match(Yt)||e.push("El email establecido es inv\xe1lido."),e.length>0?(u(e),!1):(u(void 0),!0)})())return;await(async()=>{const e=`${qt}/users/register`;try{const i=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,password:ae(s),name_to_show:a})});if(200!==i.status){const t=await i.json(),e=t.detail[0].msg?t.detail[0].msg:t.detail;let s=i.status+" - "+i.statusText+" - "+e;throw new Error(s)}return i.json()}catch(i){throw new Error(i)}})()},children:Object(ht.jsxs)("div",{style:{display:"flex",justifyContent:"center",alignContent:"center",flexDirection:"column",textAlign:"center",margin:"auto",marginTop:40,padding:30,border:"2px solid black",borderRadius:20,maxWidth:400},children:[c&&Object(ht.jsxs)(te.a,{severity:"error",style:{textAlign:"justify"},onClose:()=>u(void 0),children:["Han ocurrido los siguientes errores:",Object(ht.jsx)("ul",{children:c.map(((t,e)=>Object(ht.jsx)("li",{children:t},e)))})]}),Object(ht.jsx)("h1",{children:"Crea tu cuenta"}),Object(ht.jsx)("div",{style:{display:"flex",justifyContent:"center"},children:Object(ht.jsx)("img",{src:"logo_transp.png",width:"25%",alt:"Driving Simulator Logo"})}),Object(ht.jsx)("div",{style:{marginTop:20},children:Object(ht.jsx)(ee.a,{style:{width:"80%"},type:"text",onChange:t=>e(t.target.value),value:t,name:"email",label:"E-Mail"})}),Object(ht.jsx)("div",{style:{marginTop:20},children:Object(ht.jsx)(ee.a,{style:{width:"80%"},type:"text",onChange:t=>h(t.target.value),value:a,name:"username",label:"Nombre para mostrar"})}),Object(ht.jsx)("div",{style:{marginTop:20},children:Object(ht.jsx)(ee.a,{style:{width:"80%"},type:l?"text":"password",onChange:t=>i(t.target.value),value:s,name:"password",label:"Contrase\xf1a",InputProps:{endAdornment:Object(ht.jsx)(se.a,{position:"end",children:Object(ht.jsx)(bt.a,{"aria-label":"toggle password visibility",onClick:()=>d(!l),children:l?Object(ht.jsx)(ne.a,{}):Object(ht.jsx)(oe.a,{})})})}})}),Object(ht.jsx)("div",{style:{marginTop:20},children:Object(ht.jsx)(ee.a,{style:{width:"80%"},type:l?"text":"password",onChange:t=>r(t.target.value),value:o,name:"passwordConfirmation",label:"Repetir Contrase\xf1a"})}),Object(ht.jsx)("div",{style:{marginTop:20},children:Object(ht.jsx)(Ot.a,{variant:"contained",type:"submit",children:"CREAR CUENTA"})}),Object(ht.jsx)("div",{style:{marginTop:20},children:Object(ht.jsx)(Kt.b,{to:"/login",children:"\xbfYa poses una cuenta? Inicia sesi\xf3n..."})})]})})},de=t=>{let{childElement:e}=t;const[s,n]=Object(i.useState)({user:void 0,jwt:void 0});return Object(ht.jsx)(ie.b,{clientId:"18785041157-s9ga39r0i6up45radtj3soo6je1pneon.apps.googleusercontent.com",children:Object(ht.jsx)($t.Provider,{value:{session:s,setSession:n},children:e})})};var ce=s(386),ue=s(387);const pe=()=>Object(ht.jsx)("div",{children:"CardContentHover"});var be=s(383),ge=s(384),Se=s(385);const we=t=>{let{level:e}=t;return Object(ht.jsxs)(be.a,{children:[Object(ht.jsx)(ge.a,{component:"img",height:200,width:"100%",image:`/levels/images/${e.image}`,title:e.title,sx:{objectFit:"contain",justifyContent:"center",display:"flex"}}),Object(ht.jsx)(Se.a,{title:e.title,subheader:e.description})]})},me=()=>{const[t,e]=n.a.useState([]),[s,i]=n.a.useState([]);return n.a.useEffect((()=>{const t=[];fetch("./levels/basics.json").then((t=>t.json())).then((s=>{t.push(s),fetch("./levels/reversa.json").then((t=>t.json())).then((s=>{t.push(s),fetch("./levels/adelanto.json").then((t=>t.json())).then((s=>{t.push(s),fetch("./levels/giro_en_u.json").then((t=>t.json())).then((s=>{t.push(s),fetch("./levels/estacionamiento.json").then((t=>t.json())).then((s=>{t.push(s),fetch("./levels/manejo_libre.json").then((t=>t.json())).then((s=>{t.push(s);const n={};for(let e=0;e<t.length;e++)n[t[e].title]=!1;e(t),i(n)}))}))}))}))}))}))}),[]),Object(ht.jsx)(gt.a,{container:!0,spacing:4,rowSpacing:4,alignContent:"center",justifyContent:"space-around",sx:{padding:"2rem"},children:t.map((t=>Object(ht.jsx)(gt.a,{item:!0,xs:12,md:6,lg:4,children:Object(ht.jsx)(ce.a,{sx:{height:400},children:Object(ht.jsx)(ue.a,{onMouseOver:()=>i({...s,[t.title]:!0}),onMouseOut:()=>i({...s,[t.title]:!1}),children:s[t.title]?Object(ht.jsx)(pe,{level:t}):Object(ht.jsx)(we,{level:t})})})},t.title)))})},Ee=()=>Object(ht.jsxs)(gt.a,{container:!0,spacing:2,rowSpacing:2,children:[Object(ht.jsx)(gt.a,{item:!0,xs:12,style:{textAlign:"center"},children:Object(ht.jsx)("h1",{children:"Driving Simulator - Seleccionar Nivel"})}),Object(ht.jsx)(gt.a,{item:!0,xs:12,alignContent:"center",justifyContent:"center",style:{textAlign:"center"},children:Object(ht.jsx)("img",{src:"logo_transp.png",width:"150",alt:"Driving Simulator Logo"})}),Object(ht.jsx)(gt.a,{item:!0,xs:12,children:Object(ht.jsx)(me,{})})]});var fe=function(){const[t,e]=Object(i.useState)(null);return Object(i.useEffect)((()=>{document.title="Driving Simulator",fetch("./levels/estacionamiento.json").then((t=>t.json())).then((t=>{e(t)}))}),[]),Object(ht.jsx)(de,{childElement:Object(ht.jsx)(Kt.a,{children:Object(ht.jsxs)(ct.c,{children:[Object(ht.jsx)(ct.a,{exact:!0,path:"/levels",element:Object(ht.jsx)(Ee,{})}),Object(ht.jsx)(ct.a,{exact:!0,path:"/scene",element:t&&Object(ht.jsx)(dt,{jsonLevel:t})}),Object(ht.jsx)(ct.a,{exact:!0,path:"/",element:Object(ht.jsx)(pt,{})}),Object(ht.jsx)(ct.a,{exact:!0,path:"/level-editor",element:Object(ht.jsx)(Xt,{})}),Object(ht.jsx)(ct.a,{exact:!0,path:"/login",element:Object(ht.jsx)(he,{})}),Object(ht.jsx)(ct.a,{exact:!0,path:"/signup",element:Object(ht.jsx)(le,{})})]})})})};r.a.createRoot(document.getElementById("root")).render(Object(ht.jsx)(fe,{}))}},[[319,1,2]]]);
//# sourceMappingURL=main.772b7830.chunk.js.map